<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ATS Monitoring - JobPulse™</title>
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(125deg, #2c3e50 0%, #34495e 25%, #2980b9 50%, #3498db 75%, #5dade2 100%);
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }
        
        .geometric-bg {
            position: fixed;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 25% 25%, rgba(255,255,255,0.05) 0%, transparent 50%),
                radial-gradient(circle at 75% 75%, rgba(255,255,255,0.05) 0%, transparent 50%),
                linear-gradient(45deg, transparent 49%, rgba(255,255,255,0.02) 50%, transparent 51%),
                linear-gradient(-45deg, transparent 49%, rgba(255,255,255,0.02) 50%, transparent 51%);
            background-size: 200px 200px, 300px 300px, 60px 60px, 60px 60px;
            animation: drift 30s linear infinite;
            z-index: -1;
        }
        
        @keyframes drift {
            0% { transform: translate(0, 0) rotate(0deg); }
            100% { transform: translate(-60px, -60px) rotate(360deg); }
        }
        .activity-table-container {
            max-height: 750px;
            overflow-y: auto;
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 12px;
            background: rgba(255,255,255,0.12);
            backdrop-filter: blur(10px);
        }
        .activity-table-container::-webkit-scrollbar {
            width: 8px;
        }
        .activity-table-container::-webkit-scrollbar-track {
            background: var(--bs-dark);
            border-radius: 4px;
        }
        .activity-table-container::-webkit-scrollbar-thumb {
            background: var(--bs-secondary);
            border-radius: 4px;
        }
        .activity-table-container::-webkit-scrollbar-thumb:hover {
            background: var(--bs-primary);
        }
        .activity-table-container .table {
            margin-bottom: 0;
        }
        .activity-table-container .table thead th {
            position: sticky;
            top: 0;
            background: rgba(52, 58, 64, 0.95);
            backdrop-filter: blur(10px);
            z-index: 10;
            border-bottom: 2px solid rgba(255,255,255,0.15);
        }
        
        /* CRITICAL FIX: Prevent text wrapping in activity table */
        .activity-table-container .table td,
        .activity-table-container .table th {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
            vertical-align: middle;
        }
        
        /* Specific column width optimization */
        .activity-table-container .table th:nth-child(1),
        .activity-table-container .table td:nth-child(1) {
            min-width: 120px;
            max-width: 150px;
        }
        
        .activity-table-container .table th:nth-child(2),
        .activity-table-container .table td:nth-child(2) {
            min-width: 100px;
            max-width: 120px;
        }
        
        .activity-table-container .table th:nth-child(3),
        .activity-table-container .table td:nth-child(3) {
            min-width: 200px;
            max-width: 300px;
        }
        
        .activity-table-container .table th:nth-child(4),
        .activity-table-container .table td:nth-child(4) {
            min-width: 110px;
            max-width: 110px;
        }
        
        .activity-table-container .table th:nth-child(5),
        .activity-table-container .table td:nth-child(5) {
            min-width: 50px;
            max-width: 50px;
            text-align: center;
        }
        
        /* Ensure badges don't wrap */
        .activity-table-container .badge {
            white-space: nowrap;
            font-size: 0.75rem;
        }
        
        /* Monitor name links */
        .activity-table-container td a {
            color: #fff;
            text-decoration: none;
            display: block;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .activity-table-container td a:hover {
            color: #3498db;
            text-decoration: underline;
        }
        
        /* Enhanced button styling for ATS Monitoring */
        .monitor-card .btn {
            font-weight: 500;
            text-transform: none;
            border-width: 1.5px;
            transition: all 0.3s ease;
        }
        
        .monitor-card .btn-outline-info {
            background: rgba(13, 202, 240, 0.1);
            border-color: rgba(13, 202, 240, 0.6);
            color: #0dcaf0;
        }
        
        .monitor-card .btn-outline-info:hover {
            background: rgba(13, 202, 240, 0.2);
            border-color: #0dcaf0;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(13, 202, 240, 0.3);
        }
        
        .monitor-card .btn-outline-success {
            background: rgba(25, 135, 84, 0.1);
            border-color: rgba(25, 135, 84, 0.6);
            color: #198754;
        }
        
        .monitor-card .btn-outline-success:hover {
            background: rgba(25, 135, 84, 0.2);
            border-color: #198754;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(25, 135, 84, 0.3);
        }
        
        /* Enhanced Delete button styling - true outline-only matching View/Test */
        .monitor-card .btn-outline-danger.delete-btn {
            background: transparent !important;
            border: 2px solid rgba(220, 53, 69, 0.6) !important;
            color: #dc3545 !important;
            font-weight: 500;
        }
        
        .monitor-card .btn-outline-danger.delete-btn:hover {
            background: rgba(220, 53, 69, 0.1) !important;
            border-color: #dc3545 !important;
            color: #dc3545 !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(220, 53, 69, 0.2);
        }
        
        /* Enhanced View button styling - true outline-only matching Test/Delete */
        .monitor-card .btn-outline-info.view-btn {
            background: transparent !important;
            border: 2px solid rgba(13, 202, 240, 0.6) !important;
            color: #0dcaf0 !important;
            font-weight: 500;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        }
        
        .monitor-card .btn-outline-info.view-btn:hover {
            background: rgba(13, 202, 240, 0.1) !important;
            border-color: #0dcaf0 !important;
            color: #0dcaf0 !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(13, 202, 240, 0.2);
        }
        
        /* Enhanced Test button styling */
        .monitor-card .btn-outline-warning.test-btn {
            background: rgba(255, 193, 7, 0.15);
            border-color: rgba(255, 193, 7, 0.8);
            color: #ffc107;
            font-weight: 500;
        }
        
        .monitor-card .btn-outline-warning.test-btn:hover {
            background: rgba(255, 193, 7, 0.25);
            border-color: #ffc107;
            color: #ffffff;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 193, 7, 0.4);
        }
        
        /* Modal table styling to match activity table */
        .modal-content .table-responsive {
            border-radius: 12px;
            background: rgba(255,255,255,0.12);
            backdrop-filter: blur(10px);
        }
        
        .modal-content .table thead th {
            background: rgba(52, 58, 64, 0.95);
            backdrop-filter: blur(10px);
        }
        
        /* AI Fix Button Styling - matching Create Monitor button */
        .ai-fix-btn {
            background: rgba(255, 193, 7, 0.15) !important;
            border-color: rgba(255, 193, 7, 0.8) !important;
            color: #ffc107 !important;
            font-weight: 500 !important;
            transition: all 0.3s ease !important;
        }
        
        .ai-fix-btn:hover {
            background: rgba(255, 193, 7, 0.25) !important;
            border-color: #ffc107 !important;
            color: #ffffff !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 193, 7, 0.4) !important;
        }
            border-bottom: 2px solid rgba(255,255,255,0.15);
        }
        
        /* Enhanced Create Monitor button */
        .card-header .btn-primary {
            background: linear-gradient(135deg, #0d6efd 0%, #0b5ed7 100%);
            border: 1.5px solid #0d6efd;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(13, 110, 253, 0.2);
        }
        
        .card-header .btn-primary:hover {
            background: linear-gradient(135deg, #0b5ed7 0%, #0a58ca 100%);
            border-color: #0b5ed7;
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(13, 110, 253, 0.4);
        }
        
        /* Standard logout button styling with light red background */
        .btn-outline-danger {
            background: rgba(220, 53, 69, 0.8) !important;
            border: 2px solid rgba(220, 53, 69, 0.9) !important;
            color: #ffffff !important;
            font-weight: 600 !important;
            border-radius: 8px !important;
            padding: 0.5rem 1rem !important;
            transition: all 0.3s ease !important;
        }
        
        .btn-outline-danger:hover {
            background: rgba(165, 42, 42, 1) !important;
            border-color: rgba(220, 20, 60, 1) !important;
            color: #ffffff !important;
            transform: translateY(-1px) !important;
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.5) !important;
        }
        
        /* Overdue monitor styling */
        .monitor-card.overdue {
            border-left: 4px solid var(--bs-danger) !important;
            background: rgba(220, 53, 69, 0.15);
            backdrop-filter: blur(15px);
        }
        .overdue-indicator {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .jobpulse-header {
            text-align: center;
            margin-bottom: 3rem;
        }
        
        .jobpulse-logo {
            font-size: 2.5rem;
            font-weight: 700;
            color: #ffffff;
            text-shadow: 0 4px 15px rgba(0,0,0,0.7);
            margin-bottom: 0.5rem;
        }
        
        .lyntrix-attribution {
            font-family: 'Kalam', cursive;
            font-size: 0.9rem;
            color: #A8B8C8;
            font-style: italic;
            margin-bottom: 1rem;
        }
        
        .page-title {
            font-size: 1.8rem;
            font-weight: 600;
            color: #E8F0FF;
            margin-bottom: 0.5rem;
        }
        
        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            .jobpulse-logo {
                font-size: 2rem !important;
            }
            .page-title {
                font-size: 1.5rem !important;
            }
            .monitor-card {
                margin-bottom: 1rem;
            }
            .monitor-card .btn {
                font-size: 0.875rem;
                padding: 0.5rem 0.75rem;
            }
            .activity-table-container {
                max-height: 400px;
            }
            .activity-table-container .table td,
            .activity-table-container .table th {
                max-width: 150px;
                font-size: 0.875rem;
            }
            .container-fluid {
                padding-left: 15px;
                padding-right: 15px;
            }
            .card-body {
                padding: 1rem;
            }
        }

        @media (max-width: 576px) {
            .jobpulse-logo {
                font-size: 1.8rem !important;
            }
            .page-title {
                font-size: 1.3rem !important;
            }
            .monitor-card .btn {
                font-size: 0.8rem;
                padding: 0.4rem 0.6rem;
                margin: 0.2rem;
            }
            .activity-table-container .table td,
            .activity-table-container .table th {
                max-width: 120px;
                font-size: 0.8rem;
            }
            .card-header h5 {
                font-size: 1.1rem;
            }
            .modal-dialog {
                margin: 0.5rem;
            }
        }

        .jobpulse-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            text-align: center;
            padding: 15px 0;
            font-size: 0.85rem;
            color: #8F9BA8;
            pointer-events: none;
            z-index: 1000;
        }
        
        .content-container {
            margin-bottom: 80px;
        }
        
        .nav-pills .nav-link {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: #ffffff;
            margin: 0 0.25rem;
            transition: all 0.3s ease;
        }
        
        .nav-pills .nav-link:hover {
            background: rgba(255,255,255,0.15);
            border-color: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }
        
        .nav-pills .nav-link.active {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            border-color: #e74c3c;
        }
        
        .card {
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.15);
            backdrop-filter: blur(15px);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .card:hover {
            background: rgba(255,255,255,0.12);
            border-color: rgba(255,255,255,0.3);
            transform: translateY(-4px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.2);
        }
    
        /* Resume with pulse line effect */
        .jobpulse-logo {
            position: relative;
            display: inline-block;
        }
        
        .jobpulse-logo i {
            position: relative;
            z-index: 2;
        }
        

    </style>
    <link href="https://fonts.googleapis.com/css2?family=Kalam:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="geometric-bg"></div>
    <div class="container py-5 content-container">
        <div class="row">
            <div class="col-12">
                <!-- JobPulse™ Header -->
                <div class="jobpulse-header">
                    <div class="jobpulse-logo">
                        <i class="fas fa-file-alt me-2" style="animation: spin 4s linear infinite;"></i>
                        JobPulse™
                    </div>
                    <div class="lyntrix-attribution">powered by Lyntrix AI</div>
                    <div class="page-title">ATS Monitoring</div>
                    <p class="lead text-muted">Monitor ATS tearsheets for job changes</p>
                </div>
                
                <!-- Navigation -->
                <div class="text-center mb-4">
                    <ul class="nav nav-pills justify-content-center">
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('bullhorn_dashboard') }}">
                                <i class="fas fa-home me-2"></i>Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('scheduler_dashboard') }}">
                                <i class="fas fa-clock me-2"></i>Schedule
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active">
                                <i class="fas fa-building me-2"></i>ATS Monitor
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('settings') }}">
                                <i class="fas fa-cog me-2"></i>Settings
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('automation_test') }}">
                                <i class="fas fa-play me-2"></i>Test
                            </a>
                        </li>
                    </ul>
                </div>
                
                <!-- Clean User Info and Logout -->
                <div class="text-center mb-4">
                    <div class="d-flex justify-content-center align-items-center gap-3">
                        <div class="text-center">
                            <small class="text-muted d-block mb-1">
                                <i class="fas fa-user me-1"></i>Logged in as
                            </small>
                            <span class="badge bg-primary">{{ current_user.username }}</span>
                        </div>
                        <div class="d-flex gap-2">
                            <a href="{{ url_for('bullhorn_settings') }}" class="btn btn-outline-info d-flex align-items-center justify-content-center">
                                <i class="fas fa-cog me-2"></i>ATS Settings
                            </a>
                            <a href="{{ url_for('logout') }}" class="btn btn-outline-danger btn-sm">
                                <i class="fas fa-sign-out-alt me-1"></i>Logout
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Flash Messages -->
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show" role="alert">
                                <i class="fas fa-{{ 'exclamation-triangle' if category == 'error' else 'check-circle' }} me-2"></i>
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}

                <!-- ATS Selection -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-network-wired me-2"></i>
                            ATS Provider Selection
                        </h5>
                        <p class="text-muted">Choose your ATS provider for monitoring tearsheets and job changes</p>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="ats_provider" id="bullhorn_provider" value="bullhorn" checked>
                                    <label class="form-check-label" for="bullhorn_provider">
                                        <i class="fas fa-building me-2"></i>
                                        <strong>Bullhorn</strong>
                                        <span class="badge bg-{{ 'success' if bullhorn_connected else 'warning' }} ms-2" id="bullhorn_status">
                            {{ 'Connected' if bullhorn_connected else 'Setup Required' }}
                        </span>
                                    </label>
                                    <div class="text-muted small mt-1">
                                        Professional ATS/CRM platform with tearsheet monitoring
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="text-muted">
                                    <i class="fas fa-plus-circle me-2"></i>
                                    More ATS providers coming soon...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Setup Status -->
                {% if not bullhorn_connected %}
                <div class="alert alert-warning mb-4">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Setup Required:</strong> Configure your Bullhorn API credentials in 
                    <a href="{{ url_for('bullhorn_settings') }}" class="alert-link">ATS Settings</a> 
                    before creating monitors.
                </div>
                {% endif %}

                <!-- Active Monitors -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-desktop me-2"></i>
                            Active Monitors ({{ monitors|length }})
                            {% set total_jobs = monitor_job_counts.values() | select('number') | sum %}
                            {% if total_jobs > 0 %}
                                <span class="text-muted">| {{ total_jobs }} jobs in all tearsheets</span>
                            {% endif %}
                        </h5>
                        <div>
                            <button onclick="syncNow()" class="btn btn-success me-2" id="syncNowBtn">
                                <i class="fas fa-file-alt me-2"></i>Sync Now
                            </button>
                            <button onclick="fixAIClassifications()" class="btn btn-outline-warning me-2 ai-fix-btn" id="aiFixBtn" title="Check and fix missing AI classifications">
                                <i class="fas fa-brain me-2"></i>Fix AI Classifications
                            </button>
                            <button onclick="triggerFileCleanup()" class="btn btn-outline-info me-2 cleanup-btn" id="cleanupBtn" title="Clean up temporary and backup files">
                                <i class="fas fa-broom me-2"></i>File Cleanup
                            </button>
                            <button onclick="generateFreshXML()" class="btn btn-success me-2" id="generateXMLBtn" title="Generate fresh XML from all Bullhorn tearsheets and download for manual upload">
                                <i class="fas fa-sync-alt me-2"></i>Generate Fresh XML
                            </button>
                            <a href="{{ url_for('create_bullhorn_monitor') }}" class="btn btn-primary">
                                <i class="fas fa-plus me-2"></i>Create Monitor
                            </a>
                        </div>
                    </div>
                    <div class="card-body">
                        {% if monitors %}
                            <div class="row">
                                {% for monitor in monitors %}
                                <div class="col-md-6 col-lg-4 mb-3">
                                    <div class="card h-100 monitor-card" data-monitor-id="{{ monitor.id }}">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                <h6 class="card-title mb-0">{{ monitor.name }}</h6>
                                                <div class="d-flex gap-2">
                                                    {% if monitor.tearsheet_id == 0 %}
                                                        <span class="badge bg-secondary">Query</span>
                                                    {% else %}
                                                        <span class="badge bg-primary">Tearsheet</span>
                                                    {% endif %}
                                                    {% if monitor_job_counts[monitor.id] is not none %}
                                                        <span class="badge bg-info job-count-badge">{{ monitor_job_counts[monitor.id] }} jobs</span>
                                                        <button class="btn btn-sm btn-link p-0 ms-1" 
                                                                onclick="viewMonitorJobs({{ monitor.id }}, '{{ monitor.name }}')"
                                                                title="View current jobs from Bullhorn"
                                                                style="color: #ffffff !important; text-shadow: 0 0 5px rgba(255, 255, 255, 0.8);">
                                                            <i class="fas fa-list"></i>
                                                        </button>
                                                    {% endif %}
                                                    <!-- Overdue indicator will be added by JavaScript -->
                                                    <span class="badge bg-danger overdue-indicator" style="display: none;">
                                                        <i class="fas fa-exclamation-triangle me-1"></i>OVERDUE
                                                    </span>
                                                </div>
                                            </div>
                                            <p class="card-text text-muted">
                                                <small>
                                                    {% if monitor.tearsheet_id == 0 %}
                                                        <i class="fas fa-search me-1"></i>Query: {{ monitor.tearsheet_name }}<br>
                                                    {% else %}
                                                        <i class="fas fa-clipboard-list me-1"></i>Tearsheet: {{ monitor.tearsheet_name }}<br>
                                                    {% endif %}
                                                    <i class="fas fa-clock me-1"></i>Check every {{ monitor.check_interval_minutes }} minutes<br>
                                                    <i class="fas fa-calendar me-1"></i><span class="last-check">Last check: 
                                                    {% if monitor.last_check %}
                                                        {{ monitor.last_check.strftime('%Y-%m-%d %H:%M') }}
                                                    {% else %}
                                                        Never
                                                    {% endif %}</span><br>
                                                    <i class="fas fa-forward me-1"></i>Next check: 
                                                    {% if monitor.next_check %}
                                                        {{ monitor.next_check.strftime('%Y-%m-%d %H:%M') }}
                                                    {% else %}
                                                        Calculating...
                                                    {% endif %}
                                                </small>
                                            </p>
                                            <div class="d-flex gap-1">
                                                <a href="{{ url_for('bullhorn_monitor_details', monitor_id=monitor.id) }}" 
                                                   class="btn btn-sm btn-outline-info view-btn">
                                                    <i class="fas fa-eye me-1"></i>View
                                                </a>
                                                <button onclick="testMonitor({{ monitor.id }})" 
                                                        class="btn btn-sm btn-outline-warning test-btn">
                                                    <i class="fas fa-vial me-1"></i>Test
                                                </button>
                                                <form method="POST" action="{{ url_for('delete_bullhorn_monitor', monitor_id=monitor.id) }}" 
                                                      class="d-inline" onsubmit="return confirm('Are you sure you want to delete this monitor?')">
                                                    <button type="submit" class="btn btn-sm btn-outline-danger delete-btn">
                                                        <i class="fas fa-trash me-1"></i>Delete
                                                    </button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="text-center py-4">
                                <i class="fas fa-desktop fa-3x text-muted mb-3"></i>
                                <h5>No Active Monitors</h5>
                                <p class="text-muted">Create your first Bullhorn monitor to start tracking tearsheet changes.</p>
                                <a href="{{ url_for('create_bullhorn_monitor') }}" class="btn btn-primary">
                                    <i class="fas fa-plus me-2"></i>Create Your First Monitor
                                </a>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Job Verification Modal -->
                <div class="modal fade" id="jobListModal" tabindex="-1" aria-labelledby="jobListModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="jobListModalLabel">
                                    <i class="fas fa-list me-2"></i>Current Jobs - <span id="monitorNameInModal"></span>
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div id="jobListLoading" class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading jobs...</span>
                                    </div>
                                    <p class="mt-2 text-muted">Fetching current jobs from Bullhorn...</p>
                                </div>
                                <div id="jobListContent" style="display: none;">
                                    <div class="mb-3">
                                        <small class="text-muted">
                                            <i class="fas fa-info-circle me-1"></i>
                                            This shows the current jobs pulled from Bullhorn for verification purposes.
                                        </small>
                                    </div>
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover">
                                            <thead>
                                                <tr>
                                                    <th width="80">Job ID</th>
                                                    <th>Title</th>
                                                    <th>Location</th>
                                                    <th>Type</th>
                                                    <th>Status</th>
                                                    <th>Date Modified</th>
                                                </tr>
                                            </thead>
                                            <tbody id="jobListTableBody">
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div id="jobListError" style="display: none;" class="alert alert-danger">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <strong>Error loading jobs:</strong> <span id="jobListErrorMessage"></span>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="button" class="btn btn-primary" onclick="refreshJobList()">
                                    <i class="fas fa-sync me-1"></i>Refresh
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="card shadow-sm">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-history me-2"></i>
                            Recent Activity
                        </h5>
                        <div class="d-flex align-items-center gap-3">
                            <div id="cycle-sync-status" class="d-flex align-items-center">
                                <div class="badge bg-success">
                                    <i class="fas fa-sync me-1"></i>Synced with Monitor Cycles
                                </div>
                            </div>
                            <small class="text-muted">Last 50 entries</small>
                        </div>
                    </div>
                    <div class="card-body">
                        {% if recent_activities %}
                            <div class="activity-table-container">
                                <table class="table table-hover" id="activity-table">
                                    <thead>
                                        <tr>
                                            <th>Monitor</th>
                                            <th>Activity</th>
                                            <th>Job</th>
                                            <th>Account Manager</th>
                                            <th>Cycle Time</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for activity in recent_activities %}
                                        <tr>
                                            <td>
                                                {% if activity.monitor %}
                                                <a href="{{ url_for('bullhorn_monitor_details', monitor_id=activity.monitor.id) }}">
                                                    {{ activity.monitor.name }}
                                                </a>
                                                {% else %}
                                                <span class="text-muted">Scheduled Processing</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if activity.activity_type == 'job_added' %}
                                                    <span class="badge bg-success">
                                                        <i class="fas fa-plus me-1"></i>Job Added
                                                    </span>
                                                {% elif activity.activity_type == 'job_removed' %}
                                                    <span class="badge bg-danger">
                                                        <i class="fas fa-minus me-1"></i>Job Removed
                                                    </span>
                                                {% elif activity.activity_type == 'check_completed' %}
                                                    <span class="badge bg-info">
                                                        <i class="fas fa-check me-1"></i>Check Completed
                                                    </span>
                                                {% elif activity.activity_type == 'error' %}
                                                    <span class="badge bg-warning">
                                                        <i class="fas fa-exclamation-triangle me-1"></i>Error
                                                    </span>
                                                {% elif activity.activity_type == 'xml_sync_completed' %}
                                                    <span class="badge bg-primary">
                                                        <i class="fas fa-sync me-1"></i>XML Sync
                                                    </span>
                                                {% elif activity.activity_type == 'job_modified' %}
                                                    <span class="badge bg-warning">
                                                        <i class="fas fa-edit me-1"></i>Job Modified
                                                    </span>
                                                {% else %}
                                                    <span class="badge bg-secondary">
                                                        <i class="fas fa-info me-1"></i>{{ activity.activity_type.replace('_', ' ').title() }}
                                                    </span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if activity.job_id %}
                                                    <strong>ID {{ activity.job_id }}:</strong> {{ activity.job_title or 'No title' }}
                                                    {% if activity.activity_type == 'job_modified' and activity.details %}
                                                        <br><small class="text-muted">{{ activity.details }}</small>
                                                    {% endif %}
                                                {% elif activity.activity_type == 'xml_sync_completed' %}
                                                    <span class="text-muted">
                                                        {% if activity.details %}
                                                            {{ activity.details | truncate(60) }}
                                                        {% else %}
                                                            XML sync completed
                                                        {% endif %}
                                                    </span>
                                                {% elif activity.activity_type == 'check_completed' %}
                                                    <span class="text-muted">
                                                        {% if activity.details %}
                                                            {{ activity.details | truncate(60) }}
                                                        {% else %}
                                                            Check completed
                                                        {% endif %}
                                                    </span>
                                                {% else %}
                                                    -
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if activity.account_manager %}
                                                    <span class="badge bg-info">{{ activity.account_manager }}</span>
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <small class="text-muted">
                                                    {{ activity.created_at.strftime('%H:%M:%S') }} UTC
                                                </small>
                                                <br>
                                                <span class="badge bg-light text-dark" style="font-size: 0.7em;">
                                                    {{ activity.created_at.strftime('%m/%d') }}
                                                </span>
                                            </td>
                                            <td>
                                                {% if activity.notification_sent %}
                                                    <i class="fas fa-envelope text-success" title="Email sent"></i>
                                                {% else %}
                                                    <i class="fas fa-envelope-open text-muted" title="No email"></i>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <div class="text-center py-4">
                                <i class="fas fa-history fa-3x text-muted mb-3"></i>
                                <h5>No Recent Activity</h5>
                                <p class="text-muted">Activity will appear here once monitors start running.</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Test Monitor Modal -->
    <div class="modal fade" id="testModal" tabindex="-1" aria-labelledby="testModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="testModalLabel">
                        <i class="fas fa-vial me-2"></i>Testing Monitor
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="testResult">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm me-3" role="status">
                                <span class="visually-hidden">Testing...</span>
                            </div>
                            <div>Testing connection to Bullhorn API...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function testMonitor(monitorId) {
            const modal = new bootstrap.Modal(document.getElementById('testModal'));
            const resultDiv = document.getElementById('testResult');
            
            modal.show();
            
            fetch(`/bullhorn/monitor/${monitorId}/test`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>
                            ${data.message}
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            ${data.message}
                        </div>
                    `;
                }
            })
            .catch(error => {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error testing monitor: ${error.message}
                    </div>
                `;
            });
        }

        // Health monitoring and overdue detection
        function checkSystemHealth() {
            fetch('/api/system/health')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update page title with health status
                        const healthIndicator = document.querySelector('.display-4');
                        if (data.health_status !== 'healthy' && healthIndicator) {
                            healthIndicator.innerHTML = `
                                <i class="fas fa-building me-3"></i>
                                ATS Monitoring 
                                <span class="badge bg-warning ms-2">
                                    <i class="fas fa-exclamation-triangle me-1"></i>Health Issues
                                </span>
                            `;
                        }
                    }
                })
                .catch(error => {});
        }

        function updateMonitorStatus() {
            fetch('/api/bullhorn/monitors')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.monitors) {
                        data.monitors.forEach(monitor => {
                            const monitorCard = document.querySelector(`[data-monitor-id="${monitor.id}"]`);
                            if (monitorCard) {
                                const overdueIndicator = monitorCard.querySelector('.overdue-indicator');
                                
                                if (monitor.is_overdue) {
                                    // Show overdue indicator and style card
                                    overdueIndicator.style.display = 'inline';
                                    monitorCard.classList.add('overdue');
                                    overdueIndicator.title = `Overdue by ${monitor.overdue_minutes} minutes`;
                                } else {
                                    // Hide overdue indicator and remove styling
                                    overdueIndicator.style.display = 'none';
                                    monitorCard.classList.remove('overdue');
                                }
                                
                                // Update job count
                                const jobCountBadge = monitorCard.querySelector('.job-count-badge');
                                if (jobCountBadge && monitor.job_count !== null) {
                                    jobCountBadge.textContent = `${monitor.job_count} jobs`;
                                }
                            }
                        });
                    }
                })
                .catch(error => {});
        }

        function updateRecentActivity() {
            // Show syncing indicator
            const syncStatus = document.getElementById('cycle-sync-status');
            if (syncStatus) {
                syncStatus.innerHTML = `
                    <div class="badge bg-warning">
                        <div class="spinner-border spinner-border-sm me-1" style="width: 0.8rem; height: 0.8rem;"></div>
                        Syncing...
                    </div>
                `;
            }
            
            fetch('/api/bullhorn/activities')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.activities) {
                        const tbody = document.querySelector('#activity-table tbody');
                        if (tbody) {
                            // Store current scroll position
                            const container = document.querySelector('.activity-table-container');
                            const scrollTop = container ? container.scrollTop : 0;
                            
                            // Update table content with enhanced timing display
                            tbody.innerHTML = '';
                            data.activities.forEach(activity => {
                                const row = document.createElement('tr');
                                
                                // Parse activity timestamp
                                const activityTime = new Date(activity.created_at);
                                const timeStr = activityTime.toLocaleTimeString('en-US', { 
                                    hour12: false, 
                                    timeZone: 'UTC',
                                    hour: '2-digit', 
                                    minute: '2-digit',
                                    second: '2-digit'
                                });
                                const dateStr = activityTime.toLocaleDateString('en-US', {
                                    month: 'numeric',
                                    day: 'numeric'
                                });
                                
                                // Determine if this activity is from current monitoring cycle (within last 6 minutes)
                                const now = new Date();
                                const timeDiff = now - activityTime;
                                const isCurrentCycle = timeDiff < (6 * 60 * 1000); // 6 minutes
                                
                                row.innerHTML = `
                                    <td>
                                        <a href="/bullhorn/monitor/${activity.monitor_id}" class="text-decoration-none">
                                            ${activity.monitor_name || 'Scheduled Processing'}
                                        </a>
                                    </td>
                                    <td>
                                        <span class="badge bg-${activity.activity_type === 'check_completed' ? 'info' : 
                                            activity.activity_type === 'job_added' ? 'success' : 
                                            activity.activity_type === 'job_removed' ? 'warning' : 
                                            activity.activity_type === 'job_modified' ? 'primary' :
                                            activity.activity_type === 'xml_sync_completed' ? 'secondary' : 'dark'}">
                                            ${activity.activity_type.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}
                                        </span>
                                        ${isCurrentCycle ? '<span class="badge bg-success ms-1" title="Current monitoring cycle"><i class="fas fa-clock"></i></span>' : ''}
                                    </td>
                                    <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                        ${activity.job_id ? 
                                            `<span class="badge bg-secondary me-2">${activity.job_id}</span>` : ''}
                                        ${activity.details || (activity.job_title || '')}
                                    </td>
                                    <td>
                                        ${activity.account_manager ? 
                                            `<span class="badge bg-info">${activity.account_manager}</span>` : 
                                            '<span class="text-muted">-</span>'}
                                    </td>
                                    <td>
                                        <small class="text-muted">
                                            ${timeStr} UTC
                                        </small>
                                        <br>
                                        <span class="badge bg-light text-dark" style="font-size: 0.7em;">
                                            ${dateStr}
                                        </span>
                                    </td>
                                    <td>
                                        ${activity.notification_sent ? 
                                            '<i class="fas fa-envelope text-success" title="Email sent"></i>' :
                                            '<i class="fas fa-envelope-open text-muted" title="No email"></i>'}
                                    </td>
                                `;
                                tbody.appendChild(row);
                            });
                            
                            // Restore scroll position
                            if (container) {
                                container.scrollTop = scrollTop;
                            }
                        }
                        
                        // Update sync status to success
                        if (syncStatus) {
                            syncStatus.innerHTML = `
                                <div class="badge bg-success">
                                    <i class="fas fa-sync me-1"></i>Synced with Monitor Cycles
                                </div>
                            `;
                        }
                    } else {
                        // Update sync status to error
                        if (syncStatus) {
                            syncStatus.innerHTML = `
                                <div class="badge bg-danger">
                                    <i class="fas fa-exclamation-triangle me-1"></i>Sync Error
                                </div>
                            `;
                        }
                    }
                })
                .catch(error => {
                    // Update sync status to error
                    const syncStatus = document.getElementById('cycle-sync-status');
                    if (syncStatus) {
                        syncStatus.innerHTML = `
                            <div class="badge bg-danger">
                                <i class="fas fa-exclamation-triangle me-1"></i>Sync Error
                            </div>
                        `;
                    }
                });
        }

        // Job list modal functionality
        let currentMonitorId = null;
        let currentMonitorName = null;

        function viewMonitorJobs(monitorId, monitorName) {
            currentMonitorId = monitorId;
            currentMonitorName = monitorName;
            
            // Update modal title
            document.getElementById('monitorNameInModal').textContent = monitorName;
            
            // Show modal and loading state
            const modal = new bootstrap.Modal(document.getElementById('jobListModal'));
            modal.show();
            
            // Reset states
            document.getElementById('jobListLoading').style.display = 'block';
            document.getElementById('jobListContent').style.display = 'none';
            document.getElementById('jobListError').style.display = 'none';
            
            // Load jobs
            loadMonitorJobs(monitorId);
        }

        function loadMonitorJobs(monitorId) {
            fetch(`/api/bullhorn/monitor/${monitorId}/jobs`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('jobListLoading').style.display = 'none';
                    
                    if (data.success) {
                        displayJobList(data.jobs);
                        document.getElementById('jobListContent').style.display = 'block';
                    } else {
                        document.getElementById('jobListErrorMessage').textContent = data.error || 'Unknown error occurred';
                        document.getElementById('jobListError').style.display = 'block';
                    }
                })
                .catch(error => {
                    document.getElementById('jobListLoading').style.display = 'none';
                    document.getElementById('jobListErrorMessage').textContent = 'Network error: ' + error.message;
                    document.getElementById('jobListError').style.display = 'block';
                });
        }

        function displayJobList(jobs) {
            const tbody = document.getElementById('jobListTableBody');
            tbody.innerHTML = '';
            
            if (jobs.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted py-4">
                            <i class="fas fa-inbox fa-2x mb-2"></i><br>
                            No jobs found for this monitor
                        </td>
                    </tr>
                `;
                return;
            }
            
            jobs.forEach(job => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <span class="badge bg-secondary">${job.id}</span>
                    </td>
                    <td>
                        <strong>${job.title || 'No Title'}</strong>
                        ${job.id ? `<br><small class="text-muted">Job ID: ${job.id}</small>` : ''}
                    </td>
                    <td>
                        ${job.city || ''} ${job.state ? ', ' + job.state : ''}
                        ${job.country && job.country !== 'United States' ? '<br>' + job.country : ''}
                    </td>
                    <td>
                        <span class="badge bg-info">${job.employmentType || 'N/A'}</span>
                        ${job.onSite ? `<br><small class="text-muted">${job.onSite}</small>` : ''}
                    </td>
                    <td>
                        <span class="badge bg-${job.status === 'Open' ? 'success' : 'secondary'}">
                            ${job.status || 'Unknown'}
                        </span>
                        ${job.isPublic ? '<br><span class="badge bg-primary">Public</span>' : ''}
                    </td>
                    <td>
                        <small class="text-muted">
                            ${job.dateLastModified ? new Date(job.dateLastModified).toLocaleDateString() + '<br>' + new Date(job.dateLastModified).toLocaleTimeString() : 'N/A'}
                        </small>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function refreshJobList() {
            if (currentMonitorId) {
                // Reset states
                document.getElementById('jobListLoading').style.display = 'block';
                document.getElementById('jobListContent').style.display = 'none';
                document.getElementById('jobListError').style.display = 'none';
                
                // Reload jobs
                loadMonitorJobs(currentMonitorId);
            }
        }

        // Sync Now function
        function syncNow() {
            const btn = document.getElementById('syncNowBtn');
            const originalHtml = btn.innerHTML;
            
            // Show loading state
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-file-alt fa-spin me-2"></i>Syncing...';
            
            // Call the instant sync endpoint
            fetch('/api/trigger/job-sync', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success briefly
                    btn.innerHTML = '<i class="fas fa-check me-2"></i>Sync Complete!';
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-info');
                    
                    // Refresh the activity table
                    updateRecentActivity();
                    
                    // Restore button after 3 seconds
                    setTimeout(() => {
                        btn.innerHTML = originalHtml;
                        btn.disabled = false;
                        btn.classList.remove('btn-info');
                        btn.classList.add('btn-success');
                    }, 3000);
                } else {
                    // Show error
                    btn.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Sync Failed';
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-danger');
                    
                    // Restore button after 3 seconds
                    setTimeout(() => {
                        btn.innerHTML = originalHtml;
                        btn.disabled = false;
                        btn.classList.remove('btn-danger');
                        btn.classList.add('btn-success');
                    }, 3000);
                }
            })
            .catch(error => {
                // Show error
                btn.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Error';
                btn.classList.remove('btn-success');
                btn.classList.add('btn-danger');
                
                // Restore button after 3 seconds
                setTimeout(() => {
                    btn.innerHTML = originalHtml;
                    btn.disabled = false;
                    btn.classList.remove('btn-danger');
                    btn.classList.add('btn-success');
                }, 3000);
            });
        }

        // AI Classification Fix function
        function fixAIClassifications() {
            const btn = document.getElementById('aiFixBtn');
            const originalHtml = btn.innerHTML;
            
            // Show loading state
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-brain fa-spin me-2"></i>Fixing AI Classifications...';
            
            // Call the AI classification fix endpoint
            fetch('/api/trigger/ai-classification-fix', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success briefly
                    btn.innerHTML = '<i class="fas fa-check me-2"></i>AI Classifications Fixed!';
                    btn.classList.remove('btn-outline-warning');
                    btn.classList.add('btn-success');
                    
                    // Show notification with fix results
                    if (data.fixed_count > 0) {
                        showNotification(`Fixed AI classifications for ${data.fixed_count} jobs`, 'success');
                    } else {
                        showNotification('All jobs already have complete AI classifications', 'info');
                    }
                    
                    // Restore button after 3 seconds
                    setTimeout(() => {
                        btn.innerHTML = originalHtml;
                        btn.disabled = false;
                        btn.classList.remove('btn-success');
                        btn.classList.add('btn-outline-warning');
                    }, 3000);
                } else {
                    // Show error
                    btn.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Fix Failed';
                    btn.classList.remove('btn-outline-warning');
                    btn.classList.add('btn-danger');
                    
                    showNotification(data.error || 'Failed to fix AI classifications', 'error');
                    
                    // Restore button after 3 seconds
                    setTimeout(() => {
                        btn.innerHTML = originalHtml;
                        btn.disabled = false;
                        btn.classList.remove('btn-danger');
                        btn.classList.add('btn-outline-warning');
                    }, 3000);
                }
            })
            .catch(error => {
                // Show error
                btn.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Error';
                btn.classList.remove('btn-outline-warning');
                btn.classList.add('btn-danger');
                
                showNotification('Error fixing AI classifications: ' + error.message, 'error');
                
                // Restore button after 3 seconds
                setTimeout(() => {
                    btn.innerHTML = originalHtml;
                    btn.disabled = false;
                    btn.classList.remove('btn-danger');
                    btn.classList.add('btn-outline-warning');
                }, 3000);
            });
        }

        // File cleanup trigger functionality
        function triggerFileCleanup() {
            const cleanupBtn = document.getElementById('cleanupBtn');
            const originalText = cleanupBtn.innerHTML;
            
            // Disable button and show loading
            cleanupBtn.disabled = true;
            cleanupBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Cleaning...';
            
            fetch('/api/trigger/file-cleanup', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const summary = data.results.summary;
                    const filesRemoved = summary.total_files_removed || 0;
                    const sizeFreed = summary.total_size_freed_mb || 0;
                    
                    // Show success message with details
                    cleanupBtn.innerHTML = `<i class="fas fa-check me-2"></i>Cleaned (${filesRemoved} files, ${sizeFreed}MB)`;
                    cleanupBtn.classList.remove('btn-outline-info');
                    cleanupBtn.classList.add('btn-outline-success');
                    
                    showNotification(`File cleanup complete: removed ${filesRemoved} files, freed ${sizeFreed}MB`, 'success');
                    
                    // Reset button after delay
                    setTimeout(() => {
                        cleanupBtn.disabled = false;
                        cleanupBtn.innerHTML = originalText;
                        cleanupBtn.classList.remove('btn-outline-success');
                        cleanupBtn.classList.add('btn-outline-info');
                    }, 5000);
                } else {
                    // Show error
                    cleanupBtn.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Cleanup Failed';
                    cleanupBtn.classList.remove('btn-outline-info');
                    cleanupBtn.classList.add('btn-danger');
                    
                    showNotification(data.error || 'File cleanup failed', 'error');
                    
                    // Reset button after delay
                    setTimeout(() => {
                        cleanupBtn.disabled = false;
                        cleanupBtn.innerHTML = originalText;
                        cleanupBtn.classList.remove('btn-danger');
                        cleanupBtn.classList.add('btn-outline-info');
                    }, 3000);
                }
            })
            .catch(error => {
                // Handle network errors
                cleanupBtn.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Network Error';
                cleanupBtn.classList.remove('btn-outline-info');
                cleanupBtn.classList.add('btn-danger');
                
                showNotification('Error during file cleanup: ' + error.message, 'error');
                
                // Reset button after delay
                setTimeout(() => {
                    cleanupBtn.disabled = false;
                    cleanupBtn.innerHTML = originalText;
                    cleanupBtn.classList.remove('btn-danger');
                    cleanupBtn.classList.add('btn-outline-info');
                }, 3000);
            });
        }

        // Generate Fresh XML with improved download detection
        function generateFreshXML() {
            const generateBtn = document.getElementById('generateXMLBtn');
            const originalHtml = generateBtn.innerHTML;
            
            // Show progress state
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generating XML...';
            
            // Show progress notification
            showNotification('🚀 Generating fresh XML from Bullhorn tearsheets...', 'info');
            
            // Use fetch to trigger download and track completion
            fetch('{{ url_for("download_current_xml") }}')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Server error: ${response.status}`);
                    }
                    
                    // Verify this is actually an XML file download
                    const contentType = response.headers.get('content-type');
                    const contentDisposition = response.headers.get('content-disposition');
                    
                    if (!contentType || (!contentType.includes('xml') && !contentType.includes('octet-stream'))) {
                        if (!contentDisposition || !contentDisposition.includes('attachment')) {
                            throw new Error('Response does not appear to be a downloadable XML file');
                        }
                    }
                    
                    // Update button to show download in progress
                    generateBtn.innerHTML = '<i class="fas fa-download fa-spin me-2"></i>Downloading...';
                    showNotification('📊 Pulling jobs from all tearsheets (1256, 1264, 1499, 1556)...', 'info');
                    
                    return response.blob();
                })
                .then(blob => {
                    // Create download link and trigger download
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `myticas-job-feed-v2_${new Date().toISOString().slice(0, 19).replace(/[:-]/g, '')}.xml`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    
                    // Clean up blob URL after delay to avoid premature cancellation
                    setTimeout(() => {
                        window.URL.revokeObjectURL(url);
                    }, 1000);
                    
                    // Reset button and show success - now we know download actually started
                    generateBtn.disabled = false;
                    generateBtn.innerHTML = originalHtml;
                    showNotification('✅ XML downloaded successfully! File saved to your downloads folder.', 'success');
                })
                .catch(error => {
                    // Handle errors
                    generateBtn.disabled = false;
                    generateBtn.innerHTML = originalHtml;
                    showNotification('❌ Error generating XML: ' + error.message, 'error');
                    console.error('Download error:', error);
                });
        }

        // Helper function to show notifications
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 400px;';
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            // Add to page
            document.body.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 5000);
        }

        // Enhanced monitoring cycle synchronization
        function getNextMonitoringCycleTime() {
            // Monitors run every 5 minutes, typically at :03, :08, :13, :18, etc.
            const now = new Date();
            const minutes = now.getMinutes();
            const seconds = now.getSeconds();
            
            // Find next 5-minute interval
            const nextInterval = Math.ceil(minutes / 5) * 5;
            const nextCycleTime = new Date(now);
            nextCycleTime.setMinutes(nextInterval, 3, 0); // Monitors typically run at :03 seconds
            
            if (nextCycleTime <= now) {
                nextCycleTime.setHours(nextCycleTime.getHours() + 1, 0, 3, 0);
            }
            
            return nextCycleTime;
        }
        
        function syncWithMonitoringCycles() {
            const nextCycle = getNextMonitoringCycleTime();
            const now = new Date();
            const timeUntilNext = nextCycle - now;
            
            // Update immediately if we're within 30 seconds of a cycle
            if (timeUntilNext < 30000) {
                setTimeout(() => {
                    updateMonitorStatus();
                    updateRecentActivity();
                    checkSystemHealth();
                }, timeUntilNext + 5000); // Wait 5 seconds after cycle starts
            }
            
            // Set up the next sync
            setTimeout(syncWithMonitoringCycles, Math.min(timeUntilNext, 60000)); // Check again in max 1 minute
        }

        // Initialize health monitoring
        document.addEventListener('DOMContentLoaded', function() {
            // Initial checks
            checkSystemHealth();
            updateMonitorStatus();
            updateRecentActivity();
            
            // Start synchronized monitoring with cycles
            syncWithMonitoringCycles();
            
            // Periodic monitoring (every 2 minutes)
            setInterval(checkSystemHealth, 120000);
            setInterval(updateMonitorStatus, 120000);
            setInterval(updateRecentActivity, 120000);
        });

    </script>
    
    <!-- JobPulse™ Footer -->
    <div class="jobpulse-footer">
        © 2025 Lyntrix Solutions
    </div>
</body>
</html>