{% extends "base_layout.html" %}

{% block title %}AI Candidate Vetting - JobPulse™{% endblock %}

{% block extra_head %}
<meta http-equiv="refresh" content="60">
<style>
    .settings-card {
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(15px);
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        position: relative;
        overflow: hidden;
    }

    .settings-card:hover {
        background: rgba(255, 255, 255, 0.12);
        border-color: rgba(255, 255, 255, 0.3);
        transform: translateY(-4px);
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
    }

    .activity-table {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
    }

    .activity-table th {
        background: rgba(255, 255, 255, 0.1);
        border-bottom: 1px solid rgba(255, 255, 255, 0.15);
    }

    .activity-table td {
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    }

    .toggle-switch {
        position: relative;
        width: 60px;
        height: 30px;
    }

    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #6c757d;
        transition: .4s;
        border-radius: 30px;
    }

    .toggle-slider:before {
        position: absolute;
        content: "";
        height: 22px;
        width: 22px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
    }

    .toggle-switch input:checked+.toggle-slider {
        background-color: #667eea;
    }

    .toggle-switch input:checked+.toggle-slider:before {
        transform: translateX(30px);
    }

    .stat-card {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 12px;
        padding: 1.5rem;
        text-align: center;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .stat-value {
        font-size: 2rem;
        font-weight: bold;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .accordion-button {
        background-color: transparent !important;
        color: white !important;
    }

    .accordion-button:not(.collapsed)::after {
        filter: brightness(0) invert(1);
    }

    .accordion-button::after {
        filter: brightness(0) invert(1);
    }

    .accordion-body {
        background: rgba(0, 0, 0, 0.2);
    }
</style>
{% endblock %}

{% block page_title %}AI Candidate Vetting{% endblock %}
{% block page_subtitle %}Automated resume-to-job matching for inbound applicants{% endblock %}

{% block header_actions %}
<button onclick="location.reload()" class="btn btn-outline-light btn-sm" title="Refresh data">
    <i class="fas fa-sync-alt me-1"></i>Refresh
</button>
{% endblock %}

{% block content %}
{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
{% for category, message in messages %}
<div class="alert alert-{{ 'success' if category == 'success' else 'danger' if category == 'error' else 'info' }} alert-dismissible fade show"
    role="alert">
    {{ message }}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endfor %}
{% endif %}
{% endwith %}

<div class="row g-4 mb-4">
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-value">{{ stats.total_processed }}</div>
            <div class="text-muted">Total Processed</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-value" style="-webkit-text-fill-color: #28a745;">{{ stats.qualified }}</div>
            <div class="text-muted">Qualified Matches</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-value" style="-webkit-text-fill-color: #17a2b8;">{{ stats.notifications_sent }}
            </div>
            <div class="text-muted">Notifications Sent</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-value" style="-webkit-text-fill-color: #ffc107;">{{ stats.pending }}</div>
            <div class="text-muted">Pending</div>
        </div>
    </div>
</div>

<div class="row g-4">
    <div class="col-md-6">
        <div class="card settings-card h-100">
            <div class="card-header bg-transparent border-bottom border-secondary">
                <h5 class="mb-0">
                    <i class="fas fa-cog me-2"></i>Vetting Settings
                </h5>
            </div>
            <div class="card-body">
                <form action="{{ url_for('save_vetting_settings') }}" method="POST" id="settingsForm"
                    onsubmit="showSavingIndicator()">
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">Enable AI Vetting</h6>
                                <small class="text-muted">Automatically analyze new job applicants</small>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" name="vetting_enabled" {% if settings.vetting_enabled %}checked{%
                                    endif %}>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>

                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">Send Recruiter Emails</h6>
                                <small class="text-muted">
                                    <span class="text-warning"><i class="fas fa-exclamation-triangle me-1"></i></span>
                                    ON: Recruiters receive notifications | OFF: Admin email only (testing mode)
                                </small>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" name="send_recruiter_emails" {% if settings.send_recruiter_emails
                                    %}checked{% endif %}>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label">Match Threshold (%)</label>
                        <div class="input-group">
                            <input type="number" class="form-control" name="match_threshold"
                                value="{{ settings.match_threshold }}" min="50" max="100" step="5">
                            <span class="input-group-text">%</span>
                        </div>
                        <small class="text-muted">Candidates scoring above this threshold will trigger
                            notifications</small>
                    </div>

                    <div class="mb-4">
                        <label class="form-label">Batch Size (per cycle)</label>
                        <div class="input-group">
                            <input type="number" class="form-control" name="batch_size"
                                value="{{ settings.batch_size }}" min="1" max="100" step="1">
                            <span class="input-group-text">candidates</span>
                        </div>
                        <small class="text-muted">Maximum candidates to process per 5-minute cycle
                            (1-100)</small>
                    </div>

                    <div class="mb-4">
                        <label class="form-label">Notification Email (Admin Copy)</label>
                        <input type="email" class="form-control" name="admin_notification_email"
                            value="{{ settings.admin_notification_email }}"
                            placeholder="Optional: Receive a copy of all notifications">
                        <small class="text-muted">Leave blank to only notify assigned recruiters</small>
                    </div>

                    <div class="mb-4">
                        <label class="form-label">Health Alert Email</label>
                        <input type="email" class="form-control" name="health_alert_email"
                            value="{{ settings.health_alert_email }}" placeholder="Email for system health alerts">
                        <small class="text-muted">Receive alerts when Bullhorn, OpenAI, or scheduler issues
                            occur</small>
                    </div>

                    <button type="submit" class="btn btn-primary w-100" id="saveBtn">
                        <span id="saveBtnText"><i class="fas fa-save me-2"></i>Save Settings</span>
                        <span id="saveBtnLoading" style="display: none;">
                            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                            Saving...
                        </span>
                    </button>
                </form>

                <hr class="border-secondary my-4">

                <h6 class="mb-3"><i class="fas fa-envelope-open-text me-2"></i>Test Email Preview</h6>
                <form action="{{ url_for('send_test_vetting_email') }}" method="POST">
                    <div class="mb-3">
                        <label class="form-label">Test Scenario</label>
                        <select class="form-select" name="scenario">
                            <option value="1">1 Match: Applied job only (85% match)</option>
                            <option value="2" selected>2 Matches: Applied + 1 cross-reference</option>
                            <option value="3">3+ Matches: Applied + 2 cross-references</option>
                            <option value="cross_only">Cross-reference only (applied job below threshold)
                            </option>
                            <option value="multi">Multi-Recruiter: Same email to all recruiters</option>
                        </select>
                        <small class="text-muted">Test different notification scenarios</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Recipient Email</label>
                        <input type="email" class="form-control" name="test_email" value="kyleroots00@gmail.com"
                            placeholder="Enter email to receive test">
                        <small class="text-muted">See what notification emails look like</small>
                    </div>
                    <div class="d-flex gap-2">
                        <button type="submit" name="action" value="send" class="btn btn-outline-info flex-grow-1">
                            <i class="fas fa-paper-plane me-2"></i>Send Test
                        </button>
                        <button type="submit" name="action" value="preview"
                            class="btn btn-outline-secondary flex-grow-1">
                            <i class="fas fa-eye me-2"></i>Preview
                        </button>
                    </div>
                </form>

                <div class="mt-3">
                    <a href="{{ url_for('show_sample_notes') }}" class="btn btn-outline-secondary w-100">
                        <i class="fas fa-sticky-note me-2"></i>View Sample Candidate Notes
                    </a>
                    <small class="text-muted d-block mt-1">See what notes look like in Bullhorn</small>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card settings-card h-100">
            <div class="card-header bg-transparent border-bottom border-secondary">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>How It Works
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="d-flex align-items-start mb-2">
                        <span class="badge bg-primary me-3" style="min-width: 30px;">1</span>
                        <div>
                            <strong>Detection</strong>
                            <p class="text-muted mb-0 small">Every 1 minute, the system checks for new
                                candidates with "Online Applicant" status</p>
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <div class="d-flex align-items-start mb-2">
                        <span class="badge bg-primary me-3" style="min-width: 30px;">2</span>
                        <div>
                            <strong>Resume Analysis</strong>
                            <p class="text-muted mb-0 small">GPT-4o extracts and analyzes the candidate's resume
                                against all open positions in monitored tearsheets</p>
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <div class="d-flex align-items-start mb-2">
                        <span class="badge bg-primary me-3" style="min-width: 30px;">3</span>
                        <div>
                            <strong>Match Scoring</strong>
                            <p class="text-muted mb-0 small">Each candidate-job pair receives a compatibility
                                score based on skills, experience, and qualifications</p>
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <div class="d-flex align-items-start mb-2">
                        <span class="badge bg-success me-3" style="min-width: 30px;">4</span>
                        <div>
                            <strong>Note Creation</strong>
                            <p class="text-muted mb-0 small">A detailed note is added to every candidate record
                                with the analysis results</p>
                        </div>
                    </div>
                </div>

                <div>
                    <div class="d-flex align-items-start">
                        <span class="badge bg-info me-3" style="min-width: 30px;">5</span>
                        <div>
                            <strong>Recruiter Alerts</strong>
                            <p class="text-muted mb-0 small">For candidates scoring {{ settings.match_threshold
                                }}%+, the assigned recruiter receives an email notification</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Job Requirements Drill-Down -->
<div class="card settings-card mt-4">
    <div class="card-header bg-transparent border-bottom border-secondary d-flex justify-content-between align-items-center"
        style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#jobRequirementsPanel" aria-expanded="true">
        <h5 class="mb-0 d-flex align-items-center">
            <i class="fas fa-briefcase me-2"></i>Job Requirements
            {% if job_requirements %}
            <span class="badge bg-info ms-2">{{ job_requirements|length }} Active Jobs</span>
            {% endif %}
            <i class="fas fa-chevron-down ms-3 section-toggle-icon"
                style="transition: transform 0.3s ease; font-size: 0.8rem;"></i>
        </h5>
        <div class="d-flex gap-2" onclick="event.stopPropagation();">
            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="toggleAllAccordions(true)"
                title="Expand all job requirements">
                <i class="fas fa-expand-alt me-1"></i>Expand All
            </button>
            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="toggleAllAccordions(false)"
                title="Collapse all job requirements">
                <i class="fas fa-compress-alt me-1"></i>Collapse All
            </button>
            <form action="{{ url_for('sync_job_requirements') }}" method="POST" class="d-inline">
                <button type="submit" class="btn btn-outline-primary btn-sm"
                    onclick="this.disabled=true; this.innerHTML='<i class=\'fas fa-spinner fa-spin me-1\'></i>Syncing...'; this.form.submit();">
                    <i class="fas fa-sync me-1"></i>Sync Jobs
                </button>
            </form>
        </div>
    </div>
    <div class="collapse show" id="jobRequirementsPanel">
        <div class="card-body">
            {% if job_requirements %}
            <p class="text-muted small mb-3">
                <i class="fas fa-info-circle me-1"></i>
                AI interprets requirements from job descriptions. Adjust per-job thresholds to override the global
                default
                ({{ settings.match_threshold }}%).
            </p>
            <div class="accordion" id="jobRequirementsAccordion">
                {% for job in job_requirements %}
                <div class="accordion-item"
                    style="background: rgba(255,255,255,0.03); border-color: rgba(255,255,255,0.1); margin-bottom: 0.5rem;">
                    <h2 class="accordion-header" id="heading{{ job.bullhorn_job_id }}">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                            data-bs-target="#collapse{{ job.bullhorn_job_id }}" aria-expanded="false"
                            aria-controls="collapse{{ job.bullhorn_job_id }}"
                            style="background: rgba(30, 41, 59, 0.9); color: #f1f5f9; border-radius: 6px;">
                            <div class="d-flex justify-content-between w-100 me-3 align-items-center">
                                <div>
                                    <strong style="color: #ffffff; font-size: 1rem;">{{ job.job_title or 'Untitled Job'
                                        }}</strong>
                                    <span class="badge bg-secondary ms-2" style="font-size: 0.7rem;">ID: {{
                                        job.bullhorn_job_id }}</span>
                                </div>
                                <div class="d-flex align-items-center gap-2">
                                    {% if job.job_location %}
                                    <span class="badge" style="background: rgba(255,255,255,0.15); color: #e2e8f0;">{{
                                        job.job_location }}</span>
                                    {% endif %}
                                    {% if job.vetting_threshold %}
                                    <span class="badge bg-warning text-dark">{{ job.vetting_threshold }}%
                                        threshold</span>
                                    {% endif %}
                                </div>
                            </div>
                        </button>
                    </h2>
                    <div id="collapse{{ job.bullhorn_job_id }}" class="accordion-collapse collapse"
                        aria-labelledby="heading{{ job.bullhorn_job_id }}" data-bs-parent="#jobRequirementsAccordion">
                        <div class="accordion-body"
                            style="background: rgba(15, 23, 42, 0.6); border-top: 1px solid rgba(255,255,255,0.1);">
                            <!-- Job header reminder when expanded -->
                            <div
                                class="mb-3 pb-2 border-bottom border-secondary d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="mb-0 text-white">{{ job.job_title or 'Untitled Job' }}</h5>
                                    <small class="text-muted">ID: {{ job.bullhorn_job_id }} {% if job.job_location %}•
                                        {{
                                        job.job_location }}{% endif %}</small>
                                </div>
                                {% if job.job_work_type %}
                                <span class="badge bg-info">{{ job.job_work_type }}</span>
                                {% endif %}
                            </div>

                            <div class="row">
                                <div class="col-md-7">
                                    <h6 class="text-info mb-2"><i class="fas fa-robot me-1"></i>AI-Interpreted
                                        Requirements
                                    </h6>
                                    {% if job.ai_interpreted_requirements %}
                                    <div class="p-3 rounded mb-3"
                                        style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.2);">
                                        <pre
                                            style="white-space: pre-wrap; font-size: 0.85rem; color: #e2e8f0; margin: 0;">{{ job.ai_interpreted_requirements }}</pre>
                                    </div>
                                    {% else %}
                                    <p class="text-muted"><i class="fas fa-exclamation-circle me-1"></i>No AI
                                        interpretation
                                        yet. Click "Sync Jobs" to extract requirements.</p>
                                    {% endif %}
                                </div>
                                <div class="col-md-5">
                                    <h6 class="text-success mb-2"><i class="fas fa-user-edit me-1"></i>Custom Override
                                    </h6>
                                    <form class="job-override-form" data-job-id="{{ job.bullhorn_job_id }}">
                                        <textarea class="form-control form-control-sm mb-2 custom-requirements-input"
                                            rows="5"
                                            placeholder="Enter custom requirements to override AI interpretation..."
                                            style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); color: #e2e8f0; font-size: 0.85rem;">{{ job.custom_requirements or '' }}</textarea>
                                        <small class="text-muted d-block mb-2">Custom requirements take priority over
                                            AI-interpreted ones during vetting.</small>

                                        <div class="d-flex gap-2 align-items-center mb-3">
                                            <div class="input-group input-group-sm" style="max-width: 150px;">
                                                <span class="input-group-text"><i class="fas fa-percentage"></i></span>
                                                <input type="number" class="form-control job-threshold-input"
                                                    data-job-id="{{ job.bullhorn_job_id }}"
                                                    value="{{ job.vetting_threshold or '' }}"
                                                    placeholder="{{ settings.match_threshold }}" min="0" max="100">
                                            </div>
                                            <small class="text-muted">Threshold (blank = global {{
                                                settings.match_threshold
                                                }}%)</small>
                                        </div>

                                        <button type="submit" class="btn btn-success btn-sm">
                                            <i class="fas fa-save me-1"></i>Save Changes
                                        </button>
                                    </form>

                                    {% if job.last_ai_interpretation %}
                                    <div class="text-muted small mt-3">
                                        <i class="fas fa-clock me-1"></i>
                                        Last AI interpretation: {{ job.last_ai_interpretation.strftime('%b %d, %Y') }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-4">
                <i class="fas fa-briefcase fa-3x text-muted mb-3"></i>
                <h5>No Job Requirements Data</h5>
                <p class="text-muted">Click "Sync Jobs" to extract requirements from active tearsheet jobs.</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Vetting Audit Dashboard -->
    <div class="card settings-card mt-4">
        <div class="card-header bg-transparent border-bottom border-secondary">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">
                    <i class="fas fa-chart-bar me-2"></i>Vetting Audit Dashboard
                </h5>
                <div class="d-flex gap-2">
                    <form action="{{ url_for('full_clean_slate') }}" method="POST" class="d-inline">
                        <button type="submit" class="btn btn-danger btn-sm"
                            onclick="return confirm('⚠️ FULL CLEAN SLATE ⚠️\n\nThis will DELETE ALL vetting data:\n- All vetting logs\n- All job matches\n- Reset timestamp to now\n\nDashboard will show all zeros.\n\nThis cannot be undone. Continue?')">
                            <i class="fas fa-trash-alt me-1"></i>Full Clean Slate
                        </button>
                    </form>
                    <form action="{{ url_for('reset_recent_vetting') }}" method="POST" class="d-inline">
                        <button type="submit" class="btn btn-warning btn-sm"
                            onclick="return confirm('This will reset vetting status for all applications from the last 6 hours. They will be re-processed in the next cycle. Continue?')">
                            <i class="fas fa-undo me-1"></i>Reset Recent (6h)
                        </button>
                    </form>
                    <form action="{{ url_for('run_vetting_now') }}" method="POST" class="d-inline">
                        <button type="submit" class="btn btn-primary btn-sm" {% if not settings.vetting_enabled
                            %}disabled{% endif %}>
                            <i class="fas fa-play me-1"></i>Run Vetting Now
                        </button>
                    </form>
                </div>
            </div>
            <!-- Pipeline Overview -->
            <div class="row mb-4 g-3">
                <div class="col-md-3">
                    <div class="p-3 rounded"
                        style="background: rgba(13, 202, 240, 0.1); border: 1px solid rgba(13, 202, 240, 0.3);">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-clock fa-2x text-info me-3 opacity-75"></i>
                            <div>
                                <div class="h4 mb-0 text-info">{{ stats.pending }}</div>
                                <small class="text-muted">Awaiting Vetting</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="p-3 rounded"
                        style="background: rgba(25, 135, 84, 0.1); border: 1px solid rgba(25, 135, 84, 0.3);">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-check-circle fa-2x text-success me-3 opacity-75"></i>
                            <div>
                                <div class="h4 mb-0 text-success">{{ stats.qualified }}</div>
                                <small class="text-muted">Recommended ({{ settings.match_threshold }}%+)</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="p-3 rounded"
                        style="background: rgba(108, 117, 125, 0.1); border: 1px solid rgba(108, 117, 125, 0.3);">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-times-circle fa-2x text-secondary me-3 opacity-75"></i>
                            <div>
                                <div class="h4 mb-0 text-secondary">{{ stats.total_processed - stats.qualified }}</div>
                                <small class="text-muted">Not Recommended</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="p-3 rounded"
                        style="background: rgba(111, 66, 193, 0.1); border: 1px solid rgba(111, 66, 193, 0.3);">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-envelope fa-2x me-3 opacity-75" style="color: #6f42c1;"></i>
                            <div>
                                <div class="h4 mb-0" style="color: #6f42c1;">{{ stats.notifications_sent }}</div>
                                <small class="text-muted">Emails Sent</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="card-body">
            <p class="text-muted text-center">
                <i class="fas fa-info-circle me-1"></i>
                View detailed candidate vetting history in the tabs above. Data refreshes every 60 seconds.
            </p>
        </div>
    </div>
    {% endblock %}

    {% block extra_scripts %}
    <script>
        // Show loading indicator when saving settings
        function showSavingIndicator() {
            var saveBtn = document.getElementById('saveBtn');
            var saveBtnText = document.getElementById('saveBtnText');
            var saveBtnLoading = document.getElementById('saveBtnLoading');

            saveBtn.disabled = true;
            saveBtnText.style.display = 'none';
            saveBtnLoading.style.display = 'inline';
        }

        // Auto-save job threshold changes
        document.querySelectorAll('.job-threshold-input').forEach(function (input) {
            let originalValue = input.value;
            input.addEventListener('change', function () {
                const jobId = this.dataset.jobId;
                const threshold = this.value.trim();
                const inputEl = this;

                if (threshold === originalValue) return;

                inputEl.classList.add('is-warning');
                inputEl.style.borderColor = '#ffc107';

                fetch(`/vetting/job/${jobId}/threshold`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ threshold: threshold || null })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            originalValue = threshold;
                            inputEl.classList.remove('is-warning');
                            inputEl.classList.add('is-valid');
                            inputEl.style.borderColor = '#198754';
                            setTimeout(() => {
                                inputEl.classList.remove('is-valid');
                                inputEl.style.borderColor = '';
                            }, 2000);
                        } else {
                            inputEl.classList.add('is-invalid');
                            inputEl.style.borderColor = '#dc3545';
                            alert('Error saving threshold: ' + data.error);
                        }
                    })
                    .catch(error => {
                        inputEl.classList.add('is-invalid');
                        inputEl.style.borderColor = '#dc3545';
                        console.error('Error:', error);
                    });
            });
        });

        // Toggle all accordions expand/collapse
        function toggleAllAccordions(expand) {
            const accordion = document.getElementById('jobRequirementsAccordion');
            const collapses = accordion.querySelectorAll('.accordion-collapse');
            const buttons = accordion.querySelectorAll('.accordion-button');

            collapses.forEach((collapse, index) => {
                if (expand) {
                    collapse.classList.add('show');
                    buttons[index].classList.remove('collapsed');
                    buttons[index].setAttribute('aria-expanded', 'true');
                } else {
                    collapse.classList.remove('show');
                    buttons[index].classList.add('collapsed');
                    buttons[index].setAttribute('aria-expanded', 'false');
                }
            });
        }

        // Handle job override form submissions
        document.querySelectorAll('.job-override-form').forEach(function (form) {
            form.addEventListener('submit', function (e) {
                e.preventDefault();

                const jobId = this.dataset.jobId;
                const customRequirements = this.querySelector('.custom-requirements-input').value.trim();
                const threshold = this.querySelector('.job-threshold-input').value.trim();
                const submitBtn = this.querySelector('button[type="submit"]');
                const originalBtnHTML = submitBtn.innerHTML;

                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Saving...';

                fetch(`/vetting/job/${jobId}/requirements`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        custom_requirements: customRequirements || null,
                        threshold: threshold || null
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        submitBtn.disabled = false;
                        if (data.success) {
                            submitBtn.innerHTML = '<i class="fas fa-check me-1"></i>Saved!';
                            submitBtn.classList.remove('btn-success');
                            submitBtn.classList.add('btn-outline-success');
                            setTimeout(() => {
                                submitBtn.innerHTML = originalBtnHTML;
                                submitBtn.classList.remove('btn-outline-success');
                                submitBtn.classList.add('btn-success');
                            }, 2000);
                        } else {
                            submitBtn.innerHTML = '<i class="fas fa-times me-1"></i>Error';
                            submitBtn.classList.remove('btn-success');
                            submitBtn.classList.add('btn-danger');
                            alert('Error saving: ' + data.error);
                            setTimeout(() => {
                                submitBtn.innerHTML = originalBtnHTML;
                                submitBtn.classList.remove('btn-danger');
                                submitBtn.classList.add('btn-success');
                            }, 2000);
                        }
                    })
                    .catch(error => {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalBtnHTML;
                        alert('Error saving requirements. Please try again.');
                        console.error('Error:', error);
                    });
            });
        });

        // Handle parent-level collapse chevron rotation
        const jobRequirementsPanel = document.getElementById('jobRequirementsPanel');
        if (jobRequirementsPanel) {
            jobRequirementsPanel.addEventListener('hide.bs.collapse', function () {
                const icon = document.querySelector('[data-bs-target="#jobRequirementsPanel"] .section-toggle-icon');
                if (icon) icon.style.transform = 'rotate(-90deg)';
            });
            jobRequirementsPanel.addEventListener('show.bs.collapse', function () {
                const icon = document.querySelector('[data-bs-target="#jobRequirementsPanel"] .section-toggle-icon');
                if (icon) icon.style.transform = 'rotate(0deg)';
            });
        }
    </script>
    {% endblock %}