{% extends "base_layout.html" %}

{% block title %}AI Candidate Vetting - JobPulse™{% endblock %}

{% block extra_head %}
<meta http-equiv="refresh" content="60">
<style>
    .settings-card {
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(15px);
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        position: relative;
        overflow: hidden;
    }

    .settings-card:hover {
        background: rgba(255, 255, 255, 0.12);
        border-color: rgba(255, 255, 255, 0.3);
        transform: translateY(-4px);
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
    }

    .activity-table {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
    }

    .activity-table th {
        background: rgba(255, 255, 255, 0.1);
        border-bottom: 1px solid rgba(255, 255, 255, 0.15);
    }

    .activity-table td {
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    }

    .toggle-switch {
        position: relative;
        width: 60px;
        height: 30px;
    }

    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #6c757d;
        transition: .4s;
        border-radius: 30px;
    }

    .toggle-slider:before {
        position: absolute;
        content: "";
        height: 22px;
        width: 22px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
    }

    .toggle-switch input:checked+.toggle-slider {
        background-color: #667eea;
    }

    .toggle-switch input:checked+.toggle-slider:before {
        transform: translateX(30px);
    }

    /* stat-card styles removed - now using global metric-card from base_layout.html */

    .accordion-button {
        background-color: transparent !important;
        color: white !important;
    }

    .accordion-button:not(.collapsed)::after {
        filter: brightness(0) invert(1);
    }

    .accordion-button::after {
        filter: brightness(0) invert(1);
    }

    .accordion-body {
        background: rgba(0, 0, 0, 0.2);
    }
</style>
{% endblock %}

{% block page_title %}AI Candidate Vetting{% endblock %}
{% block page_subtitle %}Automated resume-to-job matching for inbound applicants{% endblock %}

{% block header_actions %}
<button onclick="location.reload()" class="btn btn-outline-light btn-sm" title="Refresh data">
    <i class="fas fa-sync-alt me-1"></i>Refresh
</button>
{% endblock %}

{% block content %}
{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
{% for category, message in messages %}
<div class="alert alert-{{ 'success' if category == 'success' else 'danger' if category == 'error' else 'info' }} alert-dismissible fade show"
    role="alert">
    {{ message }}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endfor %}
{% endif %}
{% endwith %}

<!-- Metrics Row - Horizontal Cards (matching Dashboard style) -->
<div class="metrics-row">
    <div class="metric-card blue">
        <div class="metric-icon">
            <i class="fas fa-clipboard-check"></i>
        </div>
        <div class="metric-label">Total Processed</div>
        <div class="metric-value">{{ stats.total_processed }}</div>
        <div class="metric-subtext">Candidates Vetted</div>
        <div class="metric-trend neutral">
            <i class="fas fa-chart-line"></i>
            All time
        </div>
    </div>

    <div class="metric-card green">
        <div class="metric-icon">
            <i class="fas fa-check-circle"></i>
        </div>
        <div class="metric-label">Qualified Matches</div>
        <div class="metric-value">{{ stats.qualified }}</div>
        <div class="metric-subtext">{{ settings.match_threshold }}%+ Score</div>
        <div class="metric-trend up">
            <i class="fas fa-arrow-up"></i>
            Recommended
        </div>
    </div>

    <div class="metric-card purple">
        <div class="metric-icon">
            <i class="fas fa-envelope"></i>
        </div>
        <div class="metric-label">Notifications Sent</div>
        <div class="metric-value">{{ stats.notifications_sent }}</div>
        <div class="metric-subtext">Email Alerts</div>
        <div class="metric-trend neutral">
            <i class="fas fa-paper-plane"></i>
            Recruiter alerts
        </div>
    </div>

    <div class="metric-card orange">
        <div class="metric-icon">
            <i class="fas fa-hourglass-half"></i>
        </div>
        <div class="metric-label">Pending</div>
        <div class="metric-value">{{ stats.pending }}</div>
        <div class="metric-subtext">Awaiting Vetting</div>
        <div class="metric-trend neutral">
            <i class="fas fa-clock"></i>
            In queue
        </div>
    </div>
</div>


<div class="row g-4">
    <div class="col-md-6">
        <div class="card settings-card h-100">
            <div class="card-header bg-transparent border-bottom border-secondary">
                <h5 class="mb-0">
                    <i class="fas fa-cog me-2"></i>Vetting Settings
                </h5>
            </div>
            <div class="card-body">
                <form action="{{ url_for('vetting.save_vetting_settings') }}" method="POST" id="settingsForm"
                    onsubmit="showSavingIndicator()">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">Enable AI Vetting</h6>
                                <small class="text-muted">Automatically analyze new job applicants</small>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" name="vetting_enabled" {% if settings.vetting_enabled %}checked{%
                                    endif %}>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>

                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">Send Recruiter Emails</h6>
                                <small class="text-muted">
                                    <span class="text-warning"><i class="fas fa-exclamation-triangle me-1"></i></span>
                                    ON: Recruiters receive notifications | OFF: Admin email only (testing mode)
                                </small>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" name="send_recruiter_emails" {% if settings.send_recruiter_emails
                                    %}checked{% endif %}>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label">Match Threshold (%)</label>
                        <div class="input-group">
                            <input type="number" class="form-control" name="match_threshold"
                                value="{{ settings.match_threshold }}" min="50" max="100" step="5">
                            <span class="input-group-text">%</span>
                        </div>
                        <small class="text-muted">Candidates scoring above this threshold will trigger
                            notifications</small>
                    </div>

                    <div class="mb-4">
                        <label class="form-label">Batch Size (per cycle)</label>
                        <div class="input-group">
                            <input type="number" class="form-control" name="batch_size"
                                value="{{ settings.batch_size }}" min="1" max="100" step="1">
                            <span class="input-group-text">candidates</span>
                        </div>
                        <small class="text-muted">Maximum candidates to process per 5-minute cycle
                            (1-100)</small>
                    </div>

                    <div class="mb-4">
                        <label class="form-label">Notification Email (Admin Copy)</label>
                        <input type="email" class="form-control" name="admin_notification_email"
                            value="{{ settings.admin_notification_email }}"
                            placeholder="Optional: Receive a copy of all notifications">
                        <small class="text-muted">Leave blank to only notify assigned recruiters</small>
                    </div>

                    <div class="mb-4">
                        <label class="form-label">Health Alert Email</label>
                        <input type="email" class="form-control" name="health_alert_email"
                            value="{{ settings.health_alert_email }}" placeholder="Email for system health alerts">
                        <small class="text-muted">Receive alerts when Bullhorn, OpenAI, or scheduler issues
                            occur</small>
                    </div>

                    <button type="submit" class="btn btn-primary w-100" id="saveBtn">
                        <span id="saveBtnText"><i class="fas fa-save me-2"></i>Save Settings</span>
                        <span id="saveBtnLoading" style="display: none;">
                            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                            Saving...
                        </span>
                    </button>
                </form>

                <hr class="border-secondary my-4">

                <h6 class="mb-3"><i class="fas fa-envelope-open-text me-2"></i>Test Email Preview</h6>
                <form action="{{ url_for('vetting.send_test_vetting_email') }}" method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="mb-3">
                        <label class="form-label">Test Scenario</label>
                        <select class="form-select" name="scenario">
                            <option value="1">1 Match: Applied job only (85% match)</option>
                            <option value="2" selected>2 Matches: Applied + 1 cross-reference</option>
                            <option value="3">3+ Matches: Applied + 2 cross-references</option>
                            <option value="cross_only">Cross-reference only (applied job below threshold)
                            </option>
                            <option value="multi">Multi-Recruiter: Same email to all recruiters</option>
                        </select>
                        <small class="text-muted">Test different notification scenarios</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Recipient Email</label>
                        <input type="email" class="form-control" name="test_email" value="kyleroots00@gmail.com"
                            placeholder="Enter email to receive test">
                        <small class="text-muted">See what notification emails look like</small>
                    </div>
                    <div class="d-flex gap-2">
                        <button type="submit" name="action" value="send" class="btn btn-outline-info flex-grow-1">
                            <i class="fas fa-paper-plane me-2"></i>Send Test
                        </button>
                        <button type="submit" name="action" value="preview"
                            class="btn btn-outline-secondary flex-grow-1">
                            <i class="fas fa-eye me-2"></i>Preview
                        </button>
                    </div>
                </form>

                <div class="mt-3">
                    <a href="{{ url_for('vetting.show_sample_notes') }}" class="btn btn-outline-secondary w-100">
                        <i class="fas fa-sticky-note me-2"></i>View Sample Candidate Notes
                    </a>
                    <small class="text-muted d-block mt-1">See what notes look like in Bullhorn</small>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card settings-card h-100">
            <div class="card-header bg-transparent border-bottom border-secondary">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>How It Works
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="d-flex align-items-start mb-2">
                        <span class="badge bg-primary me-3" style="min-width: 30px;">1</span>
                        <div>
                            <strong>Detection</strong>
                            <p class="text-muted mb-0 small">Every 1 minute, the system checks for new
                                candidates with "Online Applicant" status</p>
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <div class="d-flex align-items-start mb-2">
                        <span class="badge bg-primary me-3" style="min-width: 30px;">2</span>
                        <div>
                            <strong>Resume Analysis</strong>
                            <p class="text-muted mb-0 small">GPT-4o extracts and analyzes the candidate's resume
                                against all open positions in monitored tearsheets</p>
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <div class="d-flex align-items-start mb-2">
                        <span class="badge bg-primary me-3" style="min-width: 30px;">3</span>
                        <div>
                            <strong>Match Scoring</strong>
                            <p class="text-muted mb-0 small">Each candidate-job pair receives a compatibility
                                score based on skills, experience, and qualifications</p>
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <div class="d-flex align-items-start mb-2">
                        <span class="badge bg-success me-3" style="min-width: 30px;">4</span>
                        <div>
                            <strong>Note Creation</strong>
                            <p class="text-muted mb-0 small">A detailed note is added to every candidate record
                                with the analysis results</p>
                        </div>
                    </div>
                </div>

                <div>
                    <div class="d-flex align-items-start">
                        <span class="badge bg-info me-3" style="min-width: 30px;">5</span>
                        <div>
                            <strong>Recruiter Alerts</strong>
                            <p class="text-muted mb-0 small">For candidates scoring {{ settings.match_threshold
                                }}%+, the assigned recruiter receives an email notification</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Job Requirements Drill-Down -->
<div class="card settings-card mt-4">
    <div class="card-header bg-transparent border-bottom border-secondary d-flex justify-content-between align-items-center"
        style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#jobRequirementsPanel" aria-expanded="true">
        <h5 class="mb-0 d-flex align-items-center">
            <i class="fas fa-briefcase me-2"></i>Job Requirements
            {% if job_requirements %}
            <span class="badge bg-info ms-2">{{ job_requirements|length }} Active Jobs</span>
            {% endif %}
            <i class="fas fa-chevron-down ms-3 section-toggle-icon"
                style="transition: transform 0.3s ease; font-size: 0.8rem;"></i>
        </h5>
        <div class="d-flex gap-2" onclick="event.stopPropagation();">
            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="toggleAllAccordions(true)"
                title="Expand all job requirements">
                <i class="fas fa-expand-alt me-1"></i>Expand All
            </button>
            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="toggleAllAccordions(false)"
                title="Collapse all job requirements">
                <i class="fas fa-compress-alt me-1"></i>Collapse All
            </button>
            <form action="{{ url_for('vetting.sync_job_requirements') }}" method="POST" class="d-inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="btn btn-outline-primary btn-sm"
                    onclick="this.disabled=true; this.innerHTML='<i class=\'fas fa-spinner fa-spin me-1\'></i>Syncing...'; this.form.submit();">
                    <i class="fas fa-sync me-1"></i>Sync Jobs
                </button>
            </form>
        </div>
    </div>
    <div class="collapse show" id="jobRequirementsPanel">
        <div class="card-body">
            {% if job_requirements %}
            <p class="text-muted small mb-3">
                <i class="fas fa-info-circle me-1"></i>
                AI interprets requirements from job descriptions. Adjust per-job thresholds to override the global
                default
                ({{ settings.match_threshold }}%).
            </p>
            <div class="accordion" id="jobRequirementsAccordion">
                {% for job in job_requirements %}
                <div class="accordion-item"
                    style="background: rgba(255,255,255,0.03); border-color: rgba(255,255,255,0.1); margin-bottom: 0.5rem;">
                    <h2 class="accordion-header" id="heading{{ job.bullhorn_job_id }}">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                            data-bs-target="#collapse{{ job.bullhorn_job_id }}" aria-expanded="false"
                            aria-controls="collapse{{ job.bullhorn_job_id }}"
                            style="background: rgba(30, 41, 59, 0.9); color: #f1f5f9; border-radius: 6px;">
                            <div class="d-flex justify-content-between w-100 me-3 align-items-center">
                                <div>
                                    <strong style="color: #ffffff; font-size: 1rem;">{{ job.job_title or 'Untitled Job'
                                        }}</strong>
                                    <span class="badge bg-secondary ms-2" style="font-size: 0.7rem;">ID: {{
                                        job.bullhorn_job_id }}</span>
                                </div>
                                <div class="d-flex align-items-center gap-2">
                                    {% if job.job_location %}
                                    <span class="badge" style="background: rgba(255,255,255,0.15); color: #e2e8f0;">{{
                                        job.job_location }}</span>
                                    {% endif %}
                                    {% if job.vetting_threshold %}
                                    <span class="badge bg-warning text-dark">{{ job.vetting_threshold }}%
                                        threshold</span>
                                    {% endif %}
                                </div>
                            </div>
                        </button>
                    </h2>
                    <div id="collapse{{ job.bullhorn_job_id }}" class="accordion-collapse collapse"
                        aria-labelledby="heading{{ job.bullhorn_job_id }}" data-bs-parent="#jobRequirementsAccordion">
                        <div class="accordion-body"
                            style="background: rgba(15, 23, 42, 0.6); border-top: 1px solid rgba(255,255,255,0.1);">
                            <!-- Job header reminder when expanded -->
                            <div
                                class="mb-3 pb-2 border-bottom border-secondary d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="mb-0 text-white">{{ job.job_title or 'Untitled Job' }}</h5>
                                    <small class="text-muted">ID: {{ job.bullhorn_job_id }} {% if job.job_location %}•
                                        {{
                                        job.job_location }}{% endif %}</small>
                                </div>
                                {% if job.job_work_type %}
                                <span class="badge bg-info">{{ job.job_work_type }}</span>
                                {% endif %}
                            </div>

                            <div class="row">
                                <div class="col-md-7">
                                    <h6 class="text-info mb-2"><i class="fas fa-robot me-1"></i>AI-Interpreted
                                        Requirements
                                    </h6>
                                    {% if job.ai_interpreted_requirements %}
                                    <div class="p-3 rounded mb-3"
                                        style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.2);">
                                        <pre
                                            style="white-space: pre-wrap; font-size: 0.85rem; color: #e2e8f0; margin: 0;">{{ job.ai_interpreted_requirements }}</pre>
                                    </div>
                                    {% else %}
                                    <p class="text-muted"><i class="fas fa-exclamation-circle me-1"></i>No AI
                                        interpretation
                                        yet. Click "Sync Jobs" to extract requirements.</p>
                                    {% endif %}
                                </div>
                                <div class="col-md-5">
                                    <h6 class="text-success mb-2"><i class="fas fa-user-edit me-1"></i>Custom Override
                                    </h6>
                                    <form class="job-override-form" data-job-id="{{ job.bullhorn_job_id }}">
                                        <textarea class="form-control form-control-sm mb-2 custom-requirements-input"
                                            rows="5"
                                            placeholder="Enter custom requirements to override AI interpretation..."
                                            style="background: rgba(85, 124, 91, 0.1); border: 1px solid rgba(85, 124, 91, 0.3); color: #e2e8f0; font-size: 0.85rem;">{{ job.custom_requirements or '' }}</textarea>
                                        <small class="text-muted d-block mb-2">Custom requirements take priority over
                                            AI-interpreted ones during vetting.</small>

                                        <div class="d-flex gap-2 align-items-center mb-3">
                                            <div class="input-group input-group-sm" style="max-width: 150px;">
                                                <span class="input-group-text"><i class="fas fa-percentage"></i></span>
                                                <input type="number" class="form-control job-threshold-input"
                                                    data-job-id="{{ job.bullhorn_job_id }}"
                                                    value="{{ job.vetting_threshold or '' }}"
                                                    placeholder="{{ settings.match_threshold }}" min="0" max="100">
                                            </div>
                                            <small class="text-muted">Threshold (blank = global {{
                                                settings.match_threshold
                                                }}%)</small>
                                        </div>

                                        <button type="submit" class="btn btn-success btn-sm">
                                            <i class="fas fa-save me-1"></i>Save Changes
                                        </button>
                                    </form>

                                    {% if job.last_ai_interpretation %}
                                    <div class="text-muted small mt-3">
                                        <i class="fas fa-clock me-1"></i>
                                        Last AI interpretation: {{ job.last_ai_interpretation.strftime('%b %d, %Y') }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-4">
                <i class="fas fa-briefcase fa-3x text-muted mb-3"></i>
                <h5>No Job Requirements Data</h5>
                <p class="text-muted">Click "Sync Jobs" to extract requirements from active tearsheet jobs.</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Vetting Audit Dashboard -->
    <div class="card settings-card mt-4">
        <div class="card-header bg-transparent border-bottom border-secondary d-flex justify-content-between align-items-center"
            style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#vettingAuditPanel" aria-expanded="true">
            <h5 class="mb-0 d-flex align-items-center">
                <i class="fas fa-chart-bar me-2"></i>Vetting Audit Dashboard
                <i class="fas fa-chevron-down ms-3 vetting-toggle-icon"
                    style="transition: transform 0.3s ease; font-size: 0.8rem;"></i>
            </h5>
            <div class="d-flex gap-2" onclick="event.stopPropagation();">
                <form action="{{ url_for('vetting.full_clean_slate') }}" method="POST" class="d-inline">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-danger btn-sm"
                        onclick="return confirm('⚠️ FULL CLEAN SLATE ⚠️\n\nThis will DELETE ALL vetting data:\n- All vetting logs\n- All job matches\n- Reset timestamp to now\n\nDashboard will show all zeros.\n\nThis cannot be undone. Continue?')">
                        <i class="fas fa-trash-alt me-1"></i>Full Clean Slate
                    </button>
                </form>
                <form action="{{ url_for('vetting.reset_recent_vetting') }}" method="POST" class="d-inline">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-warning btn-sm"
                        onclick="return confirm('This will reset vetting status for all applications from the last 6 hours. They will be re-processed in the next cycle. Continue?')">
                        <i class="fas fa-undo me-1"></i>Reset Recent (6h)
                    </button>
                </form>
                <form action="{{ url_for('vetting.run_vetting_now') }}" method="POST" class="d-inline">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-primary btn-sm" {% if not settings.vetting_enabled %}disabled{%
                        endif %}>
                        <i class="fas fa-play me-1"></i>Run Vetting Now
                    </button>
                </form>
            </div>
        </div>
        <div class="collapse show" id="vettingAuditPanel">
            <!-- Pipeline Overview (Metric Cards) -->
            <div class="card-header bg-transparent border-bottom border-secondary">
                <div class="row g-3 mb-4">
                    <div class="col-md-4">
                        <div class="p-3 rounded vetting-filter-card active" data-filter="pending"
                            style="background: rgba(13, 202, 240, 0.15); border: 2px solid rgba(13, 202, 240, 0.5); cursor: pointer; transition: all 0.3s ease;">
                            <div class="d-flex align-items-center justify-content-between">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-clock fa-2x text-info me-3 opacity-75"></i>
                                    <div>
                                        <div class="h3 mb-0 text-info">{{ stats.pending }}</div>
                                        <small class="text-light">Awaiting Vetting</small>
                                    </div>
                                </div>
                                <i class="fas fa-chevron-right text-info opacity-50"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="p-3 rounded vetting-filter-card" data-filter="recommended"
                            style="background: rgba(25, 135, 84, 0.1); border: 2px solid rgba(25, 135, 84, 0.3); cursor: pointer; transition: all 0.3s ease;">
                            <div class="d-flex align-items-center justify-content-between">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-check-circle fa-2x text-success me-3 opacity-75"></i>
                                    <div>
                                        <div class="h3 mb-0 text-success">{{ stats.qualified }}</div>
                                        <small class="text-light">Recommended ({{ settings.match_threshold }}%+)</small>
                                    </div>
                                </div>
                                <i class="fas fa-chevron-right text-success opacity-50"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="p-3 rounded vetting-filter-card" data-filter="not-recommended"
                            style="background: rgba(220, 53, 69, 0.1); border: 2px solid rgba(220, 53, 69, 0.3); cursor: pointer; transition: all 0.3s ease;">
                            <div class="d-flex align-items-center justify-content-between">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-times-circle fa-2x text-danger me-3 opacity-75"></i>
                                    <div>
                                        <div class="h3 mb-0 text-danger">{{ stats.total_processed - stats.qualified }}
                                        </div>
                                        <small class="text-light">Not Recommended</small>
                                    </div>
                                </div>
                                <i class="fas fa-chevron-right text-danger opacity-50"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Candidate List - Filtered by Card Selection -->
            <div class="card-body">
                <h6 class="mb-3" id="filterTitle">
                    <i class="fas fa-clock text-info me-2"></i>
                    <span id="filterTitleText">Awaiting Vetting</span>
                    <span class="badge bg-info ms-2" id="filterCount">{{ stats.pending }}</span>
                </h6>

                <!-- Pending Candidates Section -->
                <div id="pending-section" class="candidate-filter-section">
                    {% if pending_candidates and pending_candidates|length > 0 %}
                    <div class="accordion" id="pendingAccordion">
                        {% for candidate in pending_candidates[:30] %}
                        <div class="accordion-item candidate-item" data-status="pending"
                            style="background: rgba(255,255,255,0.03); border-color: rgba(255,255,255,0.1); margin-bottom: 0.5rem;">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#pendingCandidate{{ loop.index }}"
                                    style="background: rgba(30, 41, 59, 0.7); color: #f1f5f9; border-radius: 6px; padding: 0.75rem 1rem;">
                                    <div class="d-flex justify-content-between w-100 me-3 align-items-center">
                                        <div>
                                            <strong>{{ candidate.candidate_name or 'Unknown' }}</strong>
                                            <span class="badge bg-info ms-2" style="font-size: 0.7rem;">ID: {{
                                                candidate.bullhorn_candidate_id }}</span>
                                        </div>
                                        <div class="d-flex align-items-center gap-2">
                                            <span class="badge bg-info">Pending</span>
                                            <small class="text-muted">{{ candidate.detected_at.strftime('%b %d, %H:%M')
                                                if candidate.detected_at else '' }}</small>
                                        </div>
                                    </div>
                                </button>
                            </h2>
                            <div id="pendingCandidate{{ loop.index }}" class="accordion-collapse collapse">
                                <div class="accordion-body"
                                    style="background: rgba(15, 23, 42, 0.6); border-top: 1px solid rgba(255,255,255,0.1);">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6 class="text-info mb-2"><i class="fas fa-briefcase me-1"></i>Applied Job
                                            </h6>
                                            {% if candidate.applied_job_id %}
                                            <p class="mb-2">
                                                <a href="https://www.bullhornstaffing.com/BullhornStaffing/OpenWindow.cfm?entity=JobOrder&id={{ candidate.applied_job_id }}"
                                                    target="_blank" class="text-info text-decoration-none">
                                                    {{ candidate.applied_job_title or 'N/A' }} <i
                                                        class="fas fa-external-link-alt ms-1 small"></i>
                                                </a>
                                                <small class="text-muted">(ID: {{ candidate.applied_job_id }})</small>
                                            </p>
                                            {% else %}
                                            <p class="mb-2">{{ candidate.applied_job_title or 'N/A' }}</p>
                                            {% endif %}

                                            <h6 class="text-info mb-2 mt-3"><i
                                                    class="fas fa-info-circle me-1"></i>Status</h6>
                                            <p class="text-muted mb-0">Awaiting AI analysis</p>
                                        </div>
                                        <div class="col-md-6">
                                            <h6 class="text-info mb-2"><i class="fas fa-calendar me-1"></i>Detected</h6>
                                            <p class="mb-0">{{ candidate.detected_at.strftime('%B %d, %Y at %I:%M %p')
                                                if candidate.detected_at else 'N/A' }}</p>
                                        </div>
                                    </div>
                                    <div class="mt-3 pt-2 border-top border-secondary">
                                        <a href="https://www.bullhornstaffing.com/BullhornStaffing/OpenWindow.cfm?entity=Candidate&id={{ candidate.bullhorn_candidate_id }}"
                                            target="_blank" class="btn btn-outline-info btn-sm">
                                            <i class="fas fa-external-link-alt me-1"></i>View in Bullhorn
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% if pending_candidates|length > 30 %}
                    <p class="text-muted text-center mt-2 mb-0"><small>Showing 30 of {{ pending_candidates|length }}
                            pending candidates</small></p>
                    {% endif %}
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-inbox fa-2x text-muted mb-2"></i>
                        <p class="text-muted mb-0">No candidates currently awaiting vetting</p>
                    </div>
                    {% endif %}
                </div>

                <!-- Recommended Candidates Section -->
                <div id="recommended-section" class="candidate-filter-section" style="display: none;">
                    {% if recommended_candidates and recommended_candidates|length > 0 %}
                    <div class="accordion" id="recommendedAccordion">
                        {% for log in recommended_candidates[:30] %}
                        <div class="accordion-item candidate-item" data-status="recommended"
                            style="background: rgba(255,255,255,0.03); border-color: rgba(255,255,255,0.1); margin-bottom: 0.5rem;">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#recommendedCandidate{{ loop.index }}"
                                    style="background: rgba(30, 41, 59, 0.7); color: #f1f5f9; border-radius: 6px; padding: 0.75rem 1rem;">
                                    <div class="d-flex justify-content-between w-100 me-3 align-items-center">
                                        <div>
                                            <strong>{{ log.candidate_name or 'Unknown' }}</strong>
                                            <span class="badge bg-success ms-2" style="font-size: 0.7rem;">ID: {{
                                                log.bullhorn_candidate_id }}</span>
                                        </div>
                                        <div class="d-flex align-items-center gap-2">
                                            <span class="badge bg-success">{{ log.highest_match_score|int }}%</span>
                                            <small class="text-muted">{{ log.analyzed_at.strftime('%b %d, %H:%M') if
                                                log.analyzed_at else '' }}</small>
                                        </div>
                                    </div>
                                </button>
                            </h2>
                            <div id="recommendedCandidate{{ loop.index }}" class="accordion-collapse collapse">
                                <div class="accordion-body"
                                    style="background: rgba(15, 23, 42, 0.6); border-top: 1px solid rgba(255,255,255,0.1);">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6 class="text-info mb-2"><i class="fas fa-briefcase me-1"></i>Applied Job
                                            </h6>
                                            {% if log.applied_job_id %}
                                            <p class="mb-2">
                                                <a href="https://www.bullhornstaffing.com/BullhornStaffing/OpenWindow.cfm?entity=JobOrder&id={{ log.applied_job_id }}"
                                                    target="_blank" class="text-success text-decoration-none">
                                                    {{ log.applied_job_title or 'N/A' }} <i
                                                        class="fas fa-external-link-alt ms-1 small"></i>
                                                </a>
                                                <small class="text-muted">(ID: {{ log.applied_job_id }})</small>
                                            </p>
                                            {% else %}
                                            <p class="mb-2">{{ log.applied_job_title or 'N/A' }}</p>
                                            {% endif %}

                                            <h6 class="text-info mb-2 mt-3"><i class="fas fa-chart-line me-1"></i>Match
                                                Score</h6>
                                            <div class="progress mb-2"
                                                style="height: 20px; background: rgba(255,255,255,0.1);">
                                                <div class="progress-bar bg-success" role="progressbar"
                                                    style="width: {{ log.highest_match_score or 0 }}%;">
                                                    {{ log.highest_match_score|int if log.highest_match_score else 0 }}%
                                                </div>
                                            </div>
                                            <small class="text-muted">Threshold: {{ settings.match_threshold }}%</small>
                                        </div>
                                        <div class="col-md-6">
                                            <h6 class="text-success mb-2"><i class="fas fa-robot me-1"></i>AI Summary
                                            </h6>
                                            {% set best_match = log.job_matches|sort(attribute='match_score',
                                            reverse=true)|first %}
                                            {% if best_match and best_match.match_summary %}
                                            <div class="p-2 rounded"
                                                style="background: rgba(85, 124, 91, 0.1); border: 1px solid rgba(85, 124, 91, 0.2); max-height: 150px; overflow-y: auto;">
                                                <small style="white-space: pre-wrap;">{{ best_match.match_summary[:500]
                                                    }}{% if best_match.match_summary|length > 500 %}...{% endif
                                                    %}</small>
                                            </div>
                                            {% else %}
                                            <p class="text-muted"><small>No AI summary available</small></p>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="mt-3 pt-2 border-top border-secondary">
                                        <a href="https://www.bullhornstaffing.com/BullhornStaffing/OpenWindow.cfm?entity=Candidate&id={{ log.bullhorn_candidate_id }}"
                                            target="_blank" class="btn btn-outline-success btn-sm">
                                            <i class="fas fa-external-link-alt me-1"></i>View in Bullhorn
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% if recommended|length > 30 %}
                    <p class="text-muted text-center mt-2 mb-0"><small>Showing 30 of {{ recommended|length }}
                            recommended candidates</small></p>
                    {% endif %}
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-check-circle fa-2x text-muted mb-2"></i>
                        <p class="text-muted mb-0">No recommended candidates to display</p>
                    </div>
                    {% endif %}
                </div>

                <!-- Not Recommended Candidates Section -->
                <div id="not-recommended-section" class="candidate-filter-section" style="display: none;">
                    {% if not_recommended_candidates and not_recommended_candidates|length > 0 %}
                    <div class="accordion" id="notRecommendedAccordion">
                        {% for log in not_recommended_candidates[:30] %}
                        <div class="accordion-item candidate-item" data-status="not-recommended"
                            style="background: rgba(255,255,255,0.03); border-color: rgba(255,255,255,0.1); margin-bottom: 0.5rem;">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#notRecommendedCandidate{{ loop.index }}"
                                    style="background: rgba(30, 41, 59, 0.7); color: #f1f5f9; border-radius: 6px; padding: 0.75rem 1rem;">
                                    <div class="d-flex justify-content-between w-100 me-3 align-items-center">
                                        <div>
                                            <strong>{{ log.candidate_name or 'Unknown' }}</strong>
                                            <span class="badge bg-secondary ms-2" style="font-size: 0.7rem;">ID: {{
                                                log.bullhorn_candidate_id }}</span>
                                        </div>
                                        <div class="d-flex align-items-center gap-2">
                                            <span class="badge bg-danger">{{ log.highest_match_score|int if
                                                log.highest_match_score else 0 }}%</span>
                                            <small class="text-muted">{{ log.analyzed_at.strftime('%b %d, %H:%M') if
                                                log.analyzed_at else '' }}</small>
                                        </div>
                                    </div>
                                </button>
                            </h2>
                            <div id="notRecommendedCandidate{{ loop.index }}" class="accordion-collapse collapse">
                                <div class="accordion-body"
                                    style="background: rgba(15, 23, 42, 0.6); border-top: 1px solid rgba(255,255,255,0.1);">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6 class="text-info mb-2"><i class="fas fa-briefcase me-1"></i>Applied Job
                                            </h6>
                                            {% if log.applied_job_id %}
                                            <p class="mb-2">
                                                <a href="https://www.bullhornstaffing.com/BullhornStaffing/OpenWindow.cfm?entity=JobOrder&id={{ log.applied_job_id }}"
                                                    target="_blank" class="text-danger text-decoration-none">
                                                    {{ log.applied_job_title or 'N/A' }} <i
                                                        class="fas fa-external-link-alt ms-1 small"></i>
                                                </a>
                                                <small class="text-muted">(ID: {{ log.applied_job_id }})</small>
                                            </p>
                                            {% else %}
                                            <p class="mb-2">{{ log.applied_job_title or 'N/A' }}</p>
                                            {% endif %}

                                            <h6 class="text-info mb-2 mt-3"><i class="fas fa-chart-line me-1"></i>Match
                                                Score</h6>
                                            <div class="progress mb-2"
                                                style="height: 20px; background: rgba(255,255,255,0.1);">
                                                <div class="progress-bar bg-danger" role="progressbar"
                                                    style="width: {{ log.highest_match_score or 0 }}%;">
                                                    {{ log.highest_match_score|int if log.highest_match_score else 0 }}%
                                                </div>
                                            </div>
                                            <small class="text-muted">Threshold: {{ settings.match_threshold }}%</small>
                                        </div>
                                        <div class="col-md-6">
                                            <h6 class="text-warning mb-2"><i class="fas fa-robot me-1"></i>AI Summary
                                            </h6>
                                            {% set best_match = log.job_matches|sort(attribute='match_score',
                                            reverse=true)|first %}
                                            {% if best_match and best_match.match_summary %}
                                            <div class="p-2 rounded"
                                                style="background: rgba(220, 53, 69, 0.1); border: 1px solid rgba(220, 53, 69, 0.2); max-height: 150px; overflow-y: auto;">
                                                <small style="white-space: pre-wrap;">{{ best_match.match_summary[:500]
                                                    }}{% if best_match.match_summary|length > 500 %}...{% endif
                                                    %}</small>
                                            </div>
                                            {% else %}
                                            <p class="text-muted"><small>No AI summary available</small></p>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="mt-3 pt-2 border-top border-secondary">
                                        <a href="https://www.bullhornstaffing.com/BullhornStaffing/OpenWindow.cfm?entity=Candidate&id={{ log.bullhorn_candidate_id }}"
                                            target="_blank" class="btn btn-outline-danger btn-sm">
                                            <i class="fas fa-external-link-alt me-1"></i>View in Bullhorn
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% if not_recommended|length > 30 %}
                    <p class="text-muted text-center mt-2 mb-0"><small>Showing 30 of {{ not_recommended|length }} not
                            recommended candidates</small></p>
                    {% endif %}
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-times-circle fa-2x text-muted mb-2"></i>
                        <p class="text-muted mb-0">No candidates below threshold to display</p>
                    </div>
                    {% endif %}
                </div>

                <p class="text-muted text-center mt-3 mb-0">
                    <i class="fas fa-info-circle me-1"></i>
                    Click on a candidate to view details. Click the metric cards above to filter.
                </p>
            </div>
        </div>
    </div>
    {% endblock %}

    {% block extra_scripts %}
    <script>
        // Vetting filter card click handling
        document.addEventListener('DOMContentLoaded', function () {
            const filterCards = document.querySelectorAll('.vetting-filter-card');
            const pendingSection = document.getElementById('pending-section');
            const recommendedSection = document.getElementById('recommended-section');
            const notRecommendedSection = document.getElementById('not-recommended-section');
            const filterTitleIcon = document.querySelector('#filterTitle i');
            const filterTitleText = document.getElementById('filterTitleText');
            const filterCount = document.getElementById('filterCount');

            const filterConfig = {
                'pending': {
                    section: pendingSection,
                    title: 'Awaiting Vetting',
                    iconClass: 'fas fa-clock text-info',
                    badgeClass: 'bg-info',
                    count: {{ stats.pending }}
                },
            'recommended': {
            section: recommendedSection,
            title: 'Recommended ({{ settings.match_threshold }}%+)',
            iconClass: 'fas fa-check-circle text-success',
            badgeClass: 'bg-success',
            count: {{ stats.qualified }}
                },
            'not-recommended': {
            section: notRecommendedSection,
            title: 'Not Recommended',
            iconClass: 'fas fa-times-circle text-danger',
            badgeClass: 'bg-danger',
            count: {{ stats.total_processed - stats.qualified }}
                }
            };
        filterCards.forEach(card => {
            card.addEventListener('click', function () {
                const filter = this.dataset.filter;
                const config = filterConfig[filter];

                // Update active state
                filterCards.forEach(c => {
                    c.classList.remove('active');
                    c.style.transform = 'scale(1)';
                });
                this.classList.add('active');
                this.style.transform = 'scale(1.02)';

                // Update title
                filterTitleIcon.className = config.iconClass + ' me-2';
                filterTitleText.textContent = config.title;
                filterCount.className = 'badge ms-2 ' + config.badgeClass;
                filterCount.textContent = config.count;

                // Show/hide sections
                pendingSection.style.display = filter === 'pending' ? 'block' : 'none';
                recommendedSection.style.display = filter === 'recommended' ? 'block' : 'none';
                notRecommendedSection.style.display = filter === 'not-recommended' ? 'block' : 'none';
            });

            // Add hover effects
            card.addEventListener('mouseenter', function () {
                if (!this.classList.contains('active')) {
                    this.style.transform = 'scale(1.02)';
                }
            });
            card.addEventListener('mouseleave', function () {
                if (!this.classList.contains('active')) {
                    this.style.transform = 'scale(1)';
                }
            });
        });
        });

        // Show loading indicator when saving settings
        function showSavingIndicator() {
            var saveBtn = document.getElementById('saveBtn');
            var saveBtnText = document.getElementById('saveBtnText');
            var saveBtnLoading = document.getElementById('saveBtnLoading');

            saveBtn.disabled = true;
            saveBtnText.style.display = 'none';
            saveBtnLoading.style.display = 'inline';
        }

        // Auto-save job threshold changes
        document.querySelectorAll('.job-threshold-input').forEach(function (input) {
            let originalValue = input.value;
            input.addEventListener('change', function () {
                const jobId = this.dataset.jobId;
                const threshold = this.value.trim();
                const inputEl = this;

                if (threshold === originalValue) return;

                inputEl.classList.add('is-warning');
                inputEl.style.borderColor = '#ffc107';

                fetch(`/vetting/job/${jobId}/threshold`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ threshold: threshold || null })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            originalValue = threshold;
                            inputEl.classList.remove('is-warning');
                            inputEl.classList.add('is-valid');
                            inputEl.style.borderColor = '#198754';
                            setTimeout(() => {
                                inputEl.classList.remove('is-valid');
                                inputEl.style.borderColor = '';
                            }, 2000);
                        } else {
                            inputEl.classList.add('is-invalid');
                            inputEl.style.borderColor = '#dc3545';
                            alert('Error saving threshold: ' + data.error);
                        }
                    })
                    .catch(error => {
                        inputEl.classList.add('is-invalid');
                        inputEl.style.borderColor = '#dc3545';
                        console.error('Error:', error);
                    });
            });
        });

        // Toggle all accordions expand/collapse
        function toggleAllAccordions(expand) {
            const accordion = document.getElementById('jobRequirementsAccordion');
            const collapses = accordion.querySelectorAll('.accordion-collapse');
            const buttons = accordion.querySelectorAll('.accordion-button');

            collapses.forEach((collapse, index) => {
                if (expand) {
                    collapse.classList.add('show');
                    buttons[index].classList.remove('collapsed');
                    buttons[index].setAttribute('aria-expanded', 'true');
                } else {
                    collapse.classList.remove('show');
                    buttons[index].classList.add('collapsed');
                    buttons[index].setAttribute('aria-expanded', 'false');
                }
            });
        }

        // Handle job override form submissions
        document.querySelectorAll('.job-override-form').forEach(function (form) {
            form.addEventListener('submit', function (e) {
                e.preventDefault();

                const jobId = this.dataset.jobId;
                const customRequirements = this.querySelector('.custom-requirements-input').value.trim();
                const threshold = this.querySelector('.job-threshold-input').value.trim();
                const submitBtn = this.querySelector('button[type="submit"]');
                const originalBtnHTML = submitBtn.innerHTML;

                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Saving...';

                fetch(`/vetting/job/${jobId}/requirements`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        custom_requirements: customRequirements || null,
                        threshold: threshold || null
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        submitBtn.disabled = false;
                        if (data.success) {
                            submitBtn.innerHTML = '<i class="fas fa-check me-1"></i>Saved!';
                            submitBtn.classList.remove('btn-success');
                            submitBtn.classList.add('btn-outline-success');
                            setTimeout(() => {
                                submitBtn.innerHTML = originalBtnHTML;
                                submitBtn.classList.remove('btn-outline-success');
                                submitBtn.classList.add('btn-success');
                            }, 2000);
                        } else {
                            submitBtn.innerHTML = '<i class="fas fa-times me-1"></i>Error';
                            submitBtn.classList.remove('btn-success');
                            submitBtn.classList.add('btn-danger');
                            alert('Error saving: ' + data.error);
                            setTimeout(() => {
                                submitBtn.innerHTML = originalBtnHTML;
                                submitBtn.classList.remove('btn-danger');
                                submitBtn.classList.add('btn-success');
                            }, 2000);
                        }
                    })
                    .catch(error => {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalBtnHTML;
                        alert('Error saving requirements. Please try again.');
                        console.error('Error:', error);
                    });
            });
        });

        // Handle parent-level collapse chevron rotation
        const jobRequirementsPanel = document.getElementById('jobRequirementsPanel');
        if (jobRequirementsPanel) {
            jobRequirementsPanel.addEventListener('hide.bs.collapse', function () {
                const icon = document.querySelector('[data-bs-target="#jobRequirementsPanel"] .section-toggle-icon');
                if (icon) icon.style.transform = 'rotate(-90deg)';
            });
            jobRequirementsPanel.addEventListener('show.bs.collapse', function () {
                const icon = document.querySelector('[data-bs-target="#jobRequirementsPanel"] .section-toggle-icon');
                if (icon) icon.style.transform = 'rotate(0deg)';
            });
        }

        // Handle Vetting Audit Dashboard collapse chevron rotation
        const vettingAuditPanel = document.getElementById('vettingAuditPanel');
        if (vettingAuditPanel) {
            vettingAuditPanel.addEventListener('hide.bs.collapse', function () {
                const icon = document.querySelector('[data-bs-target="#vettingAuditPanel"] .vetting-toggle-icon');
                if (icon) icon.style.transform = 'rotate(-90deg)';
            });
            vettingAuditPanel.addEventListener('show.bs.collapse', function () {
                const icon = document.querySelector('[data-bs-target="#vettingAuditPanel"] .vetting-toggle-icon');
                if (icon) icon.style.transform = 'rotate(0deg)';
            });
        }
    </script>
    {% endblock %}