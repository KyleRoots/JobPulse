{% extends "base_layout.html" %}

{% block title %}Email Delivery Logs - JobPulseâ„¢{% endblock %}

{% block page_title %}Email Delivery Logs{% endblock %}
{% block page_subtitle %}Track all email notifications sent by the system{% endblock %}

{% block header_actions %}
<select class="form-select form-select-sm" id="typeFilter" style="width: auto;">
    <option value="">All Types</option>
    <option value="job_added">Job Added</option>
    <option value="job_removed">Job Removed</option>
    <option value="job_modified">Job Modified</option>
    <option value="scheduled_processing">Scheduled Processing</option>
</select>
<button class="btn btn-outline-light btn-sm" onclick="refreshLogs()">
    <i class="fas fa-refresh me-1"></i>Refresh
</button>
{% endblock %}

{% block content %}
<!-- Metrics Row - Horizontal Cards (matching Dashboard style) -->
<div class="metrics-row">
    <div class="metric-card green">
        <div class="metric-icon">
            <i class="fas fa-check-circle"></i>
        </div>
        <div class="metric-label">Sent</div>
        <div class="metric-value" id="sentCount">
            {{ logs.items | selectattr('delivery_status', 'equalto', 'sent') | list | length }}
        </div>
        <div class="metric-subtext">Successfully Delivered</div>
        <div class="metric-trend up">
            <i class="fas fa-paper-plane"></i>
            Delivered
        </div>
    </div>

    <div class="metric-card orange">
        <div class="metric-icon">
            <i class="fas fa-times-circle"></i>
        </div>
        <div class="metric-label">Failed</div>
        <div class="metric-value" id="failedCount">
            {{ logs.items | selectattr('delivery_status', 'equalto', 'failed') | list | length }}
        </div>
        <div class="metric-subtext">Delivery Errors</div>
        <div class="metric-trend neutral">
            <i class="fas fa-exclamation"></i>
            Check logs
        </div>
    </div>

    <div class="metric-card blue">
        <div class="metric-icon">
            <i class="fas fa-envelope"></i>
        </div>
        <div class="metric-label">Total</div>
        <div class="metric-value" id="totalCount">{{ logs.total }}</div>
        <div class="metric-subtext">All Notifications</div>
        <div class="metric-trend neutral">
            <i class="fas fa-chart-line"></i>
            All time
        </div>
    </div>

    <div class="metric-card purple">
        <div class="metric-icon">
            <i class="fas fa-hourglass-half"></i>
        </div>
        <div class="metric-label">Pending</div>
        <div class="metric-value" id="pendingCount">
            {{ logs.items | selectattr('delivery_status', 'equalto', 'pending') | list | length }}
        </div>
        <div class="metric-subtext">Awaiting Send</div>
        <div class="metric-trend neutral">
            <i class="fas fa-clock"></i>
            In queue
        </div>
    </div>
</div>


<!-- Email Logs Table -->
<div class="card glass-card">
    <div class="card-body">
        {% if logs.items %}
        <div class="table-responsive">
            <table class="table table-dark table-hover">
                <thead>
                    <tr>
                        <th>Timestamp</th>
                        <th>Type</th>
                        <th>Job</th>
                        <th>Recipient</th>
                        <th>Status</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in logs.items %}
                    <tr>
                        <td>
                            <small>{{ log.sent_at | eastern_time('%Y-%m-%d %I:%M:%S %p %Z') }}</small>
                        </td>
                        <td>
                            {% if log.notification_type == 'job_added' %}
                            <span class="badge bg-success">
                                <i class="fas fa-plus"></i> Added
                            </span>
                            {% elif log.notification_type == 'job_removed' %}
                            <span class="badge bg-danger">
                                <i class="fas fa-minus"></i> Removed
                            </span>
                            {% elif log.notification_type == 'job_modified' %}
                            <span class="badge bg-warning">
                                <i class="fas fa-edit"></i> Modified
                            </span>
                            {% elif log.notification_type == 'scheduled_processing' %}
                            <span class="badge bg-info">
                                <i class="fas fa-clock"></i> Scheduled
                            </span>
                            {% endif %}
                        </td>
                        <td>
                            {% if log.job_id %}
                            <div>
                                <strong>{{ log.job_id }}</strong>
                                {% if log.job_title %}
                                <br><small class="text-muted">{{ log.job_title[:50] }}{% if log.job_title|length > 50
                                    %}...{% endif %}</small>
                                {% endif %}
                            </div>
                            {% else %}
                            <span class="text-muted">N/A</span>
                            {% endif %}
                        </td>
                        <td>
                            <small>{{ log.recipient_email }}</small>
                        </td>
                        <td>
                            {% if log.delivery_status == 'sent' %}
                            <span class="badge bg-success">
                                <i class="fas fa-check"></i> Sent
                            </span>
                            {% elif log.delivery_status == 'failed' %}
                            <span class="badge bg-danger">
                                <i class="fas fa-times"></i> Failed
                            </span>
                            {% elif log.delivery_status == 'pending' %}
                            <span class="badge bg-warning">
                                <i class="fas fa-hourglass-half"></i> Pending
                            </span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group">
                                {% if log.sendgrid_message_id %}
                                <button class="btn btn-sm btn-outline-info"
                                    title="Copy SendGrid ID: {{ log.sendgrid_message_id }}"
                                    onclick="copyToClipboard('{{ log.sendgrid_message_id }}')">
                                    <i class="fas fa-copy"></i>
                                </button>
                                {% endif %}
                                {% if log.error_message %}
                                <button class="btn btn-sm btn-outline-danger" title="Error: {{ log.error_message }}"
                                    data-bs-toggle="tooltip">
                                    <i class="fas fa-exclamation-triangle"></i>
                                </button>
                                {% endif %}
                                {% if log.changes_summary %}
                                <button class="btn btn-sm btn-outline-secondary"
                                    title="Changes: {{ log.changes_summary }}" data-bs-toggle="tooltip">
                                    <i class="fas fa-info-circle"></i>
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        {% if logs.pages > 1 %}
        <nav aria-label="Email logs pagination">
            <ul class="pagination justify-content-center">
                <li class="page-item {% if not logs.has_prev %}disabled{% endif %}">
                    <a class="page-link"
                        href="{{ url_for('email_logs', page=logs.prev_num) if logs.has_prev }}">Previous</a>
                </li>
                {% for page_num in logs.iter_pages() %}
                {% if page_num %}
                {% if page_num != logs.page %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('email_logs', page=page_num) }}">{{ page_num }}</a>
                </li>
                {% else %}
                <li class="page-item active">
                    <span class="page-link">{{ page_num }}</span>
                </li>
                {% endif %}
                {% else %}
                <li class="page-item disabled">
                    <span class="page-link">...</span>
                </li>
                {% endif %}
                {% endfor %}
                <li class="page-item {% if not logs.has_next %}disabled{% endif %}">
                    <a class="page-link"
                        href="{{ url_for('email_logs', page=logs.next_num) if logs.has_next }}">Next</a>
                </li>
            </ul>
        </nav>
        {% endif %}

        {% else %}
        <div class="text-center py-5">
            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">No email logs found</h5>
            <p class="text-muted">Email notifications will appear here once the system starts sending them.</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    })

    function refreshLogs() {
        window.location.reload();
    }

    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(function () {
            var btn = event.target.closest('button');
            var originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check"></i>';
            btn.classList.add('btn-success');
            btn.classList.remove('btn-outline-info');

            setTimeout(function () {
                btn.innerHTML = originalHTML;
                btn.classList.remove('btn-success');
                btn.classList.add('btn-outline-info');
            }, 2000);
        });
    }

    // Type filter functionality
    document.getElementById('typeFilter').addEventListener('change', function () {
        var selectedType = this.value;
        var currentUrl = new URL(window.location.href);

        if (selectedType) {
            currentUrl.searchParams.set('type', selectedType);
        } else {
            currentUrl.searchParams.delete('type');
        }

        window.location.href = currentUrl.toString();
    });

    // Set current filter value
    var urlParams = new URLSearchParams(window.location.search);
    var currentType = urlParams.get('type');
    if (currentType) {
        document.getElementById('typeFilter').value = currentType;
    }
</script>
{% endblock %}