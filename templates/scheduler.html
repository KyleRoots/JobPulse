{% extends "base_layout.html" %}
{% block body_attrs %}data-module="inbound"{% endblock %}

{% block title %}Schedule Automation - JobPulse™{% endblock %}

{% block extra_head %}
<style>
    /* Responsive layout adjustments (page-specific) */
    @media (max-width: 768px) {
        .schedule-card {
            padding: 1rem;
        }

        .schedule-card .row {
            text-align: center;
        }

        .schedule-card .col-sm-3 {
            margin-bottom: 1rem;
        }

        .schedule-card .d-flex {
            flex-direction: column !important;
            gap: 1rem;
        }

        .schedule-card .dropdown {
            align-self: center;
        }

        .file-picker-area {
            padding: 1.5rem 1rem;
        }
    }

    @media (max-width: 576px) {
        .schedule-card {
            padding: 0.75rem;
        }

        .schedule-card h5 {
            font-size: 1rem;
        }

        .file-picker-area {
            padding: 1rem 0.5rem;
        }
    }
</style>
{% endblock %}

{% block page_title %}Schedule Automation{% endblock %}
{% block page_subtitle %}Automate XML reference number updates on a schedule{% endblock %}

{% block header_actions %}
<button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#newScheduleModal">
    <i class="fas fa-plus me-1"></i>New Schedule
</button>
<button type="button" class="btn btn-warning btn-sm" id="refreshAllBtn" onclick="refreshAllReferenceNumbers()">
    <i class="fas fa-sync-alt me-1"></i>Refresh All
</button>
{% endblock %}

{% block content %}
<!-- Metrics Row - Horizontal Cards (matching Dashboard style) -->
<div class="metrics-row">
    <div class="metric-card blue">
        <div class="metric-icon">
            <i class="fas fa-file-code"></i>
        </div>
        <div class="metric-label">Active XML Files</div>
        <div class="metric-value">{{ active_xml_files|length if active_xml_files else 0 }}</div>
        <div class="metric-subtext">Auto-Synced</div>
        <div class="metric-trend neutral">
            <i class="fas fa-sync-alt"></i>
            Live updates
        </div>
    </div>

    <div class="metric-card green">
        <div class="metric-icon">
            <i class="fas fa-calendar-check"></i>
        </div>
        <div class="metric-label">Schedules</div>
        <div class="metric-value">{{ schedules|length if schedules else 0 }}</div>
        <div class="metric-subtext">Configured</div>
        <div class="metric-trend up">
            <i class="fas fa-check"></i>
            Active
        </div>
    </div>

    <div class="metric-card orange">
        <div class="metric-icon">
            <i class="fas fa-clock"></i>
        </div>
        <div class="metric-label">Next Refresh</div>
        <div class="metric-value" style="font-size: 1.3rem;">
            {% if next_refresh_info and next_refresh_info.hours_until_next %}
            {% if next_refresh_info.hours_until_next < 24 %} {{ next_refresh_info.hours_until_next | round | int }}h {%
                else %} {{ (next_refresh_info.hours_until_next / 24) | round | int }}d {% endif %} {% else %} -- {%
                endif %} </div>
                <div class="metric-subtext">Until next refresh</div>
                <div class="metric-trend neutral">
                    <i class="fas fa-hourglass-half"></i>
                    120h cycle
                </div>
        </div>

        <div class="metric-card purple">
            <div class="metric-icon">
                <i class="fas fa-server"></i>
            </div>
            <div class="metric-label">Automation</div>
            <div class="metric-value" style="font-size: 1.3rem;">Active</div>
            <div class="metric-subtext">Background sync</div>
            <div class="metric-trend up">
                <i class="fas fa-check-circle"></i>
                Running
            </div>
        </div>
    </div>

    <!-- Actively Monitored XML Files -->
    <div class="card glass-card mb-4">
        <div class="card-header bg-transparent border-bottom border-secondary">
            <h5 class="mb-0">
                <i class="fas fa-sync-alt me-2"></i>Live XML Files (Auto-Synced with Bullhorn)
            </h5>
        </div>
        <div class="card-body">
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                These files are automatically updated every 5 minutes when job changes are detected in Bullhorn.
            </div>

            {% if active_xml_files %}
            {% for xml_file in active_xml_files %}
            <div class="schedule-card mb-2">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-1">
                            <i class="fas fa-file-code me-2"></i>
                            {{ xml_file.filename }}
                        </h6>
                    </div>
                    <div class="text-end">
                        <small class="text-muted d-block">Last Updated</small>
                        <strong class="text-success">
                            {% if xml_file.server_time %}
                            {{ xml_file.server_time }}
                            {% else %}
                            {{ xml_file.last_modified.strftime('%Y-%m-%d %H:%M:%S') }}
                            {% endif %}
                        </strong>
                        <small class="ms-3 text-warning">
                            {{ xml_file.display_size }}
                        </small>
                    </div>
                </div>
            </div>
            {% endfor %}
            {% else %}
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                No active XML files found.
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Next Reference Number Refresh Info -->
    {% if next_refresh_info %}
    <div class="card glass-card mb-4 bg-primary bg-opacity-10">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <div class="d-flex align-items-center mb-2">
                        <i class="fas fa-clock me-3" style="font-size: 1.2rem;"></i>
                        <div>
                            <h6 class="mb-1" style="font-weight: 600;">
                                120-Hour Automatic Reference Refresh
                            </h6>
                            <p class="mb-0 text-muted" style="font-size: 0.9rem;">
                                All job reference numbers are automatically refreshed every 120 hours
                            </p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 text-md-end">
                    {% if next_refresh_info.next_run %}
                    <div class="mb-2">
                        <small class="text-muted d-block">Next Refresh</small>
                        <strong class="text-success" style="font-size: 1rem;">
                            {{ next_refresh_info.next_run | eastern_time('%b %d, %Y') }}
                        </strong>
                        <br>
                        <small class="text-success" style="font-weight: 500;">
                            {{ next_refresh_info.next_run | eastern_time('%I:%M %p %Z') }}
                        </small>
                    </div>
                    {% if next_refresh_info.hours_until_next > 0 %}
                    <small style="font-weight: 500;">
                        <i class="fas fa-hourglass-half me-1"></i>
                        {% if next_refresh_info.hours_until_next < 1 %} {{ (next_refresh_info.hours_until_next * 60) |
                            round | int }} minutes remaining {% elif next_refresh_info.hours_until_next < 24 %} {{
                            next_refresh_info.hours_until_next | round(1) }} hours remaining {% else %} {{
                            (next_refresh_info.hours_until_next / 24) | round(1) }} days remaining {% endif %} </small>
                            {% endif %}
                            {% endif %}
                </div>
            </div>
            {% if next_refresh_info.last_run %}
            <div class="row mt-2 pt-2" style="border-top: 1px solid rgba(255,255,255,0.1);">
                <div class="col-12">
                    <small class="text-muted">
                        <i class="fas fa-check-circle me-2"></i>
                        Last refresh completed:
                        <strong>{{ next_refresh_info.last_run | eastern_time }}</strong>
                    </small>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Scheduled Reference Number Updates -->
    <div class="card glass-card">
        <div
            class="card-header bg-transparent border-bottom border-secondary d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="fas fa-calendar-check me-2"></i>Scheduled Reference Number Updates
            </h5>
        </div>
        <div class="card-body">
            {% if schedules %}
            {% for schedule in schedules %}
            <div class="schedule-card schedule-active" data-schedule-id="{{ schedule.id }}">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <h5 class="mb-2">{{ schedule.name }}</h5>
                        <p class="text-muted mb-3">
                            <i class="fas fa-file me-2"></i>
                            {{ schedule.file_path }}
                        </p>
                        <div class="row text-center">
                            <div class="col-6 col-sm-2">
                                <small class="text-muted d-block">Frequency</small>
                                <strong>Every {{ schedule.schedule_days }} days</strong>
                            </div>
                            <div class="col-6 col-sm-2">
                                <small class="text-muted d-block">Last Run</small>
                                <strong>
                                    {% if schedule.last_run %}
                                    {{ schedule.last_run | eastern_time('%b %d, %Y') }}
                                    {% else %}
                                    Never
                                    {% endif %}
                                </strong>
                            </div>
                            <div class="col-6 col-sm-2">
                                <small class="text-muted d-block">Next Run</small>
                                <strong class="text-success">
                                    {{ schedule.next_run | eastern_time('%b %d, %Y') }}
                                    <br><small class="text-muted">{{ schedule.next_run | eastern_time('%I:%M %p %Z')
                                        }}</small>
                                </strong>
                            </div>
                            <div class="col-4 col-sm-2">
                                <small class="text-muted d-block">Last Upload</small>
                                <strong class="text-info">
                                    {% if schedule.actual_last_modified %}
                                    {{ schedule.actual_last_modified | eastern_time('%b %d, %Y') }}
                                    <br><small class="text-muted">{{ schedule.actual_last_modified | eastern_time('%I:%M
                                        %p
                                        %Z') }}</small>
                                    {% elif schedule.last_file_upload %}
                                    {{ schedule.last_file_upload | eastern_time('%b %d, %Y') }}
                                    <br><small class="text-muted">{{ schedule.last_file_upload | eastern_time('%I:%M %p
                                        %Z')
                                        }}</small>
                                    {% else %}
                                    Never
                                    {% endif %}
                                </strong>
                            </div>
                            <div class="col-4 col-sm-2">
                                <small class="text-muted d-block">Filesize</small>
                                <strong class="text-warning">
                                    {% if schedule.actual_file_size %}
                                    {{ (schedule.actual_file_size / 1024) | round(1) }} KB
                                    {% elif schedule.file_size %}
                                    {{ schedule.file_size }}
                                    {% else %}
                                    N/A
                                    {% endif %}
                                </strong>
                            </div>
                            <div class="col-4 col-sm-2">
                                <small class="text-muted d-block">Last Processed</small>
                                <strong>
                                    {% set last_log = schedule.processing_logs | selectattr('success', 'equalto', True)
                                    |
                                    list | last %}
                                    {% if last_log %}
                                    {{ last_log.jobs_processed }}
                                    {% else %}
                                    0
                                    {% endif %}
                                </strong>
                            </div>
                        </div>
                    </div>
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="dropdown">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item run-now-btn" href="#" data-schedule-id="{{ schedule.id }}">
                                    <i class="fas fa-play me-2"></i>Run Now
                                </a></li>
                            <li><a class="dropdown-item replace-file-btn" href="#" data-schedule-id="{{ schedule.id }}">
                                    <i class="fas fa-file-upload me-2"></i>Replace File
                                </a></li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item text-danger delete-schedule-btn" href="#"
                                    data-schedule-id="{{ schedule.id }}">
                                    <i class="fas fa-trash me-2"></i>Delete
                                </a></li>
                        </ul>
                    </div>
                </div>
            </div>
            {% endfor %}
            {% else %}
            <div class="text-center py-5">
                <i class="fas fa-calendar-plus fa-3x text-muted mb-3"></i>
                <h5>No Schedules Created Yet</h5>
                <p class="text-muted mb-3">Create your first automated schedule to get started</p>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newScheduleModal">
                    <i class="fas fa-plus me-2"></i>Create First Schedule
                </button>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Recent Activity Sidebar -->
    <div class="row mt-4">
        <div class="col-lg-6">
            <div class="card glass-card">
                <div class="card-header bg-transparent border-bottom border-secondary">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>Schedule Options
                    </h5>
                </div>
                <div class="card-body">
                    <h6>Available Frequencies:</h6>
                    <ul class="list-unstyled mb-0">
                        <li><i class="fas fa-check text-success me-2"></i>Every 3 days</li>
                        <li><i class="fas fa-check text-success me-2"></i>Every 7 days (Weekly)</li>
                        <li><i class="fas fa-check text-success me-2"></i>Every 10 days</li>
                        <li><i class="fas fa-check text-success me-2"></i>Every 14 days (Bi-weekly)</li>
                        <li><i class="fas fa-check text-success me-2"></i>Every 21 days</li>
                        <li><i class="fas fa-check text-success me-2"></i>Every 30 days (Monthly)</li>
                    </ul>
                    <div class="alert alert-info mt-3 mb-0">
                        <small>
                            <i class="fas fa-lightbulb me-2"></i>
                            Schedules run automatically in the background. You can also trigger manual runs anytime.
                        </small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card glass-card">
                <div class="card-header bg-transparent border-bottom border-secondary">
                    <h5 class="mb-0">
                        <i class="fas fa-history me-2"></i>Recent Activity
                    </h5>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        {% if recent_logs %}
                        {% for log in recent_logs[:5] %}
                        <div class="list-group-item bg-transparent">
                            <div class="d-flex justify-content-between">
                                <small class="{% if log.success %}text-success{% else %}text-danger{% endif %}">
                                    <i
                                        class="fas {% if log.success %}fa-check-circle{% else %}fa-exclamation-triangle{% endif %} me-2"></i>
                                    {% if log.success %}
                                    {{ log.processing_type|title }} run: {{ log.jobs_processed }} jobs
                                    {% else %}
                                    {{ log.processing_type|title }} failed: {{ log.error_message[:30] }}...
                                    {% endif %}
                                </small>
                                <small class="text-muted">{{ log.processed_at.strftime('%m/%d %H:%M') }}</small>
                            </div>
                        </div>
                        {% endfor %}
                        {% else %}
                        <div class="list-group-item bg-transparent">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-2"></i>
                                No processing activity yet
                            </small>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- New Schedule Modal -->
    <div class="modal fade" id="newScheduleModal" tabindex="-1" aria-labelledby="newScheduleModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="newScheduleModalLabel">
                        <i class="fas fa-plus me-2"></i>Create New Schedule
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="newScheduleForm">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="scheduleName" class="form-label">Schedule Name</label>
                            <input type="text" class="form-control" id="scheduleName"
                                placeholder="e.g., Weekly Job Feed Update" required>
                        </div>

                        <div class="mb-3">
                            <label for="xmlFilePath" class="form-label">XML File to Monitor</label>
                            <div class="file-picker-area" id="filePickerArea">
                                <i class="fas fa-file-code fa-2x text-muted mb-2"></i>
                                <p class="mb-2">Click to select XML file or drag and drop</p>
                                <small class="text-muted">The file you want to update automatically</small>
                                <input type="file" id="xmlFileInput" accept=".xml" class="d-none">
                            </div>
                            <div id="selectedFileInfo" class="mt-2" style="display: none;">
                                <small class="text-muted">
                                    <i class="fas fa-file me-2"></i>
                                    <span id="selectedFileName"></span>
                                </small>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="scheduleFrequency" class="form-label">Update Frequency</label>
                            <select class="form-select" id="scheduleFrequency" required>
                                <option value="">Select frequency...</option>
                                <option value="3">Every 3 days</option>
                                <option value="7" selected>Every 7 days (Weekly)</option>
                                <option value="10">Every 10 days</option>
                                <option value="14">Every 14 days (Bi-weekly)</option>
                                <option value="21">Every 21 days</option>
                                <option value="30">Every 30 days (Monthly)</option>
                            </select>
                        </div>

                        <div class="alert alert-info">
                            <h6 class="alert-heading">
                                <i class="fas fa-magic me-2"></i>Automated Features
                            </h6>
                            <ul class="mb-0">
                                <li><strong>Email Notifications:</strong> Automated alerts sent to email configured in
                                    Global Settings</li>
                                <li><strong>SFTP Upload:</strong> Automatically uploads processed files to your server
                                </li>
                                <li><strong>File Backup:</strong> Creates backup copies before processing</li>
                            </ul>
                            <small class="text-muted mt-2 d-block">
                                Configure SFTP and email credentials in <a href="/settings" class="alert-link">Global
                                    Settings</a>.
                            </small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>Create Schedule
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Replace File Modal -->
    <div class="modal fade" id="replaceFileModal" tabindex="-1" aria-labelledby="replaceFileModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="replaceFileModalLabel">
                        <i class="fas fa-file-upload me-2"></i>Replace XML File
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        This will replace the current XML file for this schedule. The schedule settings and timing will
                        remain unchanged.
                    </div>
                    <form id="replaceFileForm" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="replacementFile" class="form-label">Select New XML File</label>
                            <input type="file" class="form-control" id="replacementFile" name="file" accept=".xml"
                                required>
                            <div class="form-text">Only XML files are accepted. Maximum file size: 50MB.</div>
                        </div>
                        <input type="hidden" id="replaceScheduleId" name="schedule_id">
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmReplaceBtn">
                        <i class="fas fa-upload me-2"></i>Replace File
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Modal -->
    <div class="modal fade" id="progressModal" tabindex="-1" aria-labelledby="progressModalLabel" aria-hidden="true"
        data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="progressModalLabel">
                        <i class="fas fa-cog fa-spin me-2"></i>Processing XML File
                    </h5>
                </div>
                <div class="modal-body text-center">
                    <div class="progress mb-3" style="height: 25px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"
                            style="width: 33%" id="progressBar">
                            <span id="progressText">Processing XML...</span>
                        </div>
                    </div>
                    <div class="mt-3">
                        <div id="step1" class="mb-2">
                            <i class="fas fa-hourglass-half text-warning me-2"></i>
                            <span>Step 1: Processing XML file and updating reference numbers</span>
                        </div>
                        <div id="step2" class="mb-2" style="color: #6c757d;">
                            <i class="fas fa-hourglass-half text-muted me-2"></i>
                            <span>Step 2: Sending email notification</span>
                        </div>
                        <div id="step3" class="mb-2" style="color: #6c757d;">
                            <i class="fas fa-hourglass-half text-muted me-2"></i>
                            <span>Step 3: Uploading to WP Engine server</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endblock %}

    {% block extra_scripts %}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const filePickerArea = document.getElementById('filePickerArea');
            const xmlFileInput = document.getElementById('xmlFileInput');
            const selectedFileInfo = document.getElementById('selectedFileInfo');
            const selectedFileName = document.getElementById('selectedFileName');

            // File picker functionality
            filePickerArea.addEventListener('click', function () {
                xmlFileInput.click();
            });

            xmlFileInput.addEventListener('change', function (e) {
                const file = e.target.files[0];
                if (file) {
                    selectedFileName.textContent = file.name;
                    selectedFileInfo.style.display = 'block';
                }
            });

            // Drag and drop
            filePickerArea.addEventListener('dragover', function (e) {
                e.preventDefault();
                filePickerArea.style.borderColor = 'var(--module-accent, var(--bs-success))';
            });

            filePickerArea.addEventListener('dragleave', function (e) {
                e.preventDefault();
                filePickerArea.style.borderColor = 'var(--bs-border-color)';
            });

            filePickerArea.addEventListener('drop', function (e) {
                e.preventDefault();
                filePickerArea.style.borderColor = 'var(--bs-border-color)';

                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const file = files[0];
                    if (file.name.endsWith('.xml')) {
                        xmlFileInput.files = files;
                        selectedFileName.textContent = file.name;
                        selectedFileInfo.style.display = 'block';
                    } else {
                        alert('Please select an XML file');
                    }
                }
            });

            // Form submission
            document.getElementById('newScheduleForm').addEventListener('submit', function (e) {
                e.preventDefault();

                const formData = new FormData();
                const fileInput = document.getElementById('xmlFileInput');

                if (!fileInput.files[0]) {
                    alert('Please select an XML file');
                    return;
                }

                formData.append('file', fileInput.files[0]);

                fetch('/api/upload-schedule-file', {
                    method: 'POST',
                    body: formData
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const scheduleData = {
                                name: document.getElementById('scheduleName').value,
                                file_path: data.file_path,
                                original_filename: data.original_filename,
                                schedule_days: document.getElementById('scheduleFrequency').value
                            };

                            return fetch('/api/schedules', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify(scheduleData)
                            });
                        } else {
                            throw new Error(data.error);
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('Schedule created successfully!');
                            location.reload();
                        } else {
                            throw new Error(data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error creating schedule: ' + error.message);
                    });
            });

            // Run now functionality
            document.addEventListener('click', function (e) {
                if (e.target.classList.contains('run-now-btn') || e.target.closest('.run-now-btn')) {
                    e.preventDefault();
                    const scheduleId = e.target.closest('.run-now-btn').dataset.scheduleId;

                    if (confirm('Are you sure you want to run this schedule now?')) {
                        showProgressModal(scheduleId);

                        fetch(`/api/schedules/${scheduleId}/run`, {
                            method: 'POST'
                        })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    startProgressPolling(scheduleId);
                                } else {
                                    hideProgressModal();
                                    alert('Error starting processing: ' + data.error);
                                }
                            })
                            .catch(error => {
                                hideProgressModal();
                                console.error('Error:', error);
                                alert('Error running schedule: ' + error.message);
                            });
                    }
                }
            });

            // Delete schedule functionality
            document.addEventListener('click', function (e) {
                if (e.target.classList.contains('delete-schedule-btn') || e.target.closest('.delete-schedule-btn')) {
                    e.preventDefault();
                    const scheduleId = e.target.closest('.delete-schedule-btn').dataset.scheduleId;

                    if (confirm('Are you sure you want to delete this schedule? This action cannot be undone.')) {
                        fetch(`/api/schedules/${scheduleId}`, {
                            method: 'DELETE'
                        })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    alert('Schedule deleted successfully');
                                    location.reload();
                                } else {
                                    alert('Error deleting schedule: ' + data.error);
                                }
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                alert('Error deleting schedule: ' + error.message);
                            });
                    }
                }
            });

            // Replace file functionality
            document.addEventListener('click', function (e) {
                if (e.target.classList.contains('replace-file-btn') || e.target.closest('.replace-file-btn')) {
                    e.preventDefault();
                    const scheduleId = e.target.closest('.replace-file-btn').dataset.scheduleId;
                    document.getElementById('replaceScheduleId').value = scheduleId;
                    const modal = new bootstrap.Modal(document.getElementById('replaceFileModal'));
                    modal.show();
                }
            });

            // Confirm replace file button
            document.getElementById('confirmReplaceBtn').addEventListener('click', function () {
                const fileInput = document.getElementById('replacementFile');
                const scheduleId = document.getElementById('replaceScheduleId').value;

                if (!fileInput.files.length) {
                    alert('Please select a file to upload.');
                    return;
                }

                const file = fileInput.files[0];
                if (!file.name.toLowerCase().endsWith('.xml')) {
                    alert('Please select a valid XML file.');
                    return;
                }

                if (file.size > 50 * 1024 * 1024) {
                    alert('File size must be less than 50MB.');
                    return;
                }

                const formData = new FormData();
                formData.append('file', file);
                formData.append('schedule_id', scheduleId);

                this.disabled = true;
                this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Replacing...';

                fetch('/api/schedules/replace-file', {
                    method: 'POST',
                    body: formData
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('File replaced successfully!');
                            const modal = bootstrap.Modal.getInstance(document.getElementById('replaceFileModal'));
                            modal.hide();
                            location.reload();
                        } else {
                            alert('Error: ' + data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error replacing file: ' + error.message);
                    })
                    .finally(() => {
                        this.disabled = false;
                        this.innerHTML = '<i class="fas fa-upload me-2"></i>Replace File';
                    });
            });
        });

        // Progress tracking variables
        let progressInterval = null;
        let currentScheduleId = null;

        function showProgressModal(scheduleId) {
            currentScheduleId = scheduleId;
            const modal = new bootstrap.Modal(document.getElementById('progressModal'));
            modal.show();
            updateProgress(10, 'Starting processing...', 1);
        }

        function startProgressPolling(scheduleId) {
            if (progressInterval) {
                clearInterval(progressInterval);
            }

            progressInterval = setInterval(() => {
                fetch(`/api/schedules/${scheduleId}/progress`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const step = data.step || 1;
                            const message = data.message || 'Processing...';

                            let percent = 10;
                            if (step === 1) percent = 33;
                            else if (step === 2) percent = 66;
                            else if (step === 3) percent = 90;
                            else if (step === 4) percent = 100;

                            updateProgress(percent, message, step);

                            if (data.completed) {
                                clearInterval(progressInterval);
                                progressInterval = null;

                                setTimeout(() => {
                                    hideProgressModal();
                                    if (data.error) {
                                        alert('Processing failed: ' + data.error);
                                    } else {
                                        alert('Processing completed successfully!');
                                    }
                                    location.reload();
                                }, 2000);
                            }
                        } else {
                            clearInterval(progressInterval);
                            progressInterval = null;
                            hideProgressModal();
                            alert('Error checking progress: ' + data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Progress polling error:', error);
                        clearInterval(progressInterval);
                        progressInterval = null;
                        hideProgressModal();
                        alert('Error monitoring progress: ' + error.message);
                    });
            }, 1000);
        }

        function updateProgress(percent, text, step) {
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');

            progressBar.style.width = percent + '%';
            progressText.textContent = text;

            for (let i = 1; i <= 3; i++) {
                const stepElement = document.getElementById('step' + i);
                const icon = stepElement.querySelector('i');

                if (i < step) {
                    icon.className = 'fas fa-check-circle text-success me-2';
                    stepElement.style.color = '#198754';
                } else if (i === step) {
                    icon.className = 'fas fa-hourglass-half text-warning me-2';
                    stepElement.style.color = '#ffc107';
                } else {
                    icon.className = 'fas fa-hourglass-half text-muted me-2';
                    stepElement.style.color = '#6c757d';
                }
            }
        }

        function hideProgressModal() {
            if (progressInterval) {
                clearInterval(progressInterval);
                progressInterval = null;
            }

            const modal = bootstrap.Modal.getInstance(document.getElementById('progressModal'));
            if (modal) {
                modal.hide();
            }
        }

        function refreshAllReferenceNumbers() {
            if (!confirm('Are you sure you want to refresh ALL reference numbers?\n\nThis will:\n• Generate new reference numbers for all jobs\n• Preserve all other job data\n• Upload updated file to server\n• NOT affect scheduled automation timing\n\nContinue?')) {
                return;
            }

            const button = document.getElementById('refreshAllBtn');
            const originalText = button.innerHTML;

            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Refreshing...';

            fetch('/api/refresh-reference-numbers', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then(response => response.json())
                .then(data => {
                    button.disabled = false;
                    button.innerHTML = originalText;

                    if (data.success) {
                        alert(`✅ Reference Number Refresh Complete!\n\n• Processed: ${data.jobs_processed} jobs\n• Server Upload: ${data.upload_success ? 'Success' : 'Failed'}\n• Email notification sent`);
                        location.reload();
                    } else {
                        alert('❌ Refresh Failed: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    button.disabled = false;
                    button.innerHTML = originalText;
                    console.error('Error:', error);
                    alert('❌ Network Error: ' + error.message);
                });
        }
    </script>
    {% endblock %}