<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ATS Settings - XML Processor</title>
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <!-- Header -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h1 class="display-5 mb-0">
                            <i class="fas fa-cog me-3"></i>
                            ATS API Settings
                        </h1>
                        <p class="lead text-muted">Configure your ATS/CRM API credentials</p>
                    </div>
                    <div>
                        <a href="{{ url_for('bullhorn_dashboard') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Back to ATS Monitoring
                        </a>
                    </div>
                </div>

                <!-- Flash Messages -->
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show" role="alert">
                                <i class="fas fa-{{ 'exclamation-triangle' if category == 'error' else 'check-circle' }} me-2"></i>
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}

                <!-- Bullhorn API Settings -->
                <div class="card shadow-sm">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-key me-2"></i>
                            API Credentials
                        </h5>
                    </div>
                    <div class="card-body">
                        <form method="POST" id="bullhornSettingsForm">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="bullhorn_client_id" class="form-label">
                                            <i class="fas fa-id-card me-1"></i>Client ID
                                        </label>
                                        <input type="text" class="form-control" id="bullhorn_client_id" 
                                               name="bullhorn_client_id" value="{{ settings.bullhorn_client_id or '' }}"
                                               placeholder="Your Bullhorn OAuth Client ID">
                                        <div class="form-text">
                                            OAuth Client ID provided by Bullhorn
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="bullhorn_client_secret" class="form-label">
                                            <i class="fas fa-lock me-1"></i>Client Secret
                                        </label>
                                        <input type="password" class="form-control" id="bullhorn_client_secret" 
                                               name="bullhorn_client_secret" value="{{ settings.bullhorn_client_secret or '' }}"
                                               placeholder="Your Bullhorn OAuth Client Secret">
                                        <div class="form-text">
                                            OAuth Client Secret provided by Bullhorn
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="bullhorn_username" class="form-label">
                                            <i class="fas fa-user me-1"></i>Username
                                        </label>
                                        <input type="text" class="form-control" id="bullhorn_username" 
                                               name="bullhorn_username" value="{{ settings.bullhorn_username or '' }}"
                                               placeholder="Your Bullhorn username">
                                        <div class="form-text">
                                            Your Bullhorn system username
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="bullhorn_password" class="form-label">
                                            <i class="fas fa-key me-1"></i>Password
                                        </label>
                                        <input type="password" class="form-control" id="bullhorn_password" 
                                               name="bullhorn_password" value="{{ settings.bullhorn_password or '' }}"
                                               placeholder="Your Bullhorn password">
                                        <div class="form-text">
                                            Your Bullhorn system password
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>Save Settings
                                </button>
                                <button type="button" class="btn btn-outline-info" onclick="testConnection()">
                                    <i class="fas fa-vial me-2"></i>Test Connection
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Connection Test Result -->
                <div id="connectionTestResult" class="mt-3" style="display: none;"></div>

                <!-- Help Section -->
                <div class="card shadow-sm mt-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-question-circle me-2"></i>
                            Setting Up Bullhorn API Access
                        </h5>
                    </div>
                    <div class="card-body">
                        <h6>1. Contact Bullhorn Support</h6>
                        <p>
                            To get API access, you'll need to contact Bullhorn Support and request OAuth API credentials. 
                            They will provide you with:
                        </p>
                        <ul>
                            <li><strong>Client ID</strong> - OAuth application identifier</li>
                            <li><strong>Client Secret</strong> - OAuth application secret key</li>
                            <li><strong>API Access</strong> - Permission to use REST API endpoints</li>
                        </ul>

                        <h6 class="mt-4">2. Required Redirect URIs</h6>
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Important:</strong> Provide both URLs below to Bullhorn Support so you won't need to update them later:
                        </div>
                        
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title">Current Development URL</h6>
                                <p class="card-text text-muted">For immediate testing and development</p>
                                <div class="input-group mb-3">
                                    <input type="text" class="form-control" id="devRedirectUri" value="{{ request.url_root }}bullhorn/oauth/callback" readonly>
                                    <button class="btn btn-outline-secondary" onclick="copyToClipboard('devRedirectUri', this)">
                                        <i class="fas fa-copy"></i> Copy
                                    </button>
                                </div>
                                
                                <h6 class="card-title mt-4">Production URL</h6>
                                <p class="card-text text-muted">Configure your planned production domain</p>
                                <div class="input-group mb-3">
                                    <input type="text" class="form-control" id="prodRedirectUri" 
                                           placeholder="https://your-domain.com/bullhorn/oauth/callback"
                                           value="https://workspace.kyleroots00.replit.app/bullhorn/oauth/callback">
                                    <button class="btn btn-outline-secondary" onclick="copyToClipboard('prodRedirectUri', this)">
                                        <i class="fas fa-copy"></i> Copy
                                    </button>
                                </div>
                                
                                <div class="alert alert-info mb-0">
                                    <i class="fas fa-lightbulb me-2"></i>
                                    <strong>Pro Tip:</strong> Copy both URLs and include them in your Bullhorn Support request. 
                                    This way, you can test immediately with the development URL and switch to production later without needing another support ticket.
                                </div>
                            </div>
                        </div>

                        <h6 class="mt-4">3. Required Information</h6>
                        <p>When contacting Bullhorn Support, provide:</p>
                        <ul>
                            <li>Your company name and Bullhorn account details</li>
                            <li>Intended use case (monitoring tearsheet job changes)</li>
                            <li><strong>Both redirect URIs shown above</strong> (development and production)</li>
                            <li>Technical contact information</li>
                            <li>Request OAuth API access with tearsheet monitoring permissions</li>
                        </ul>

                        <h6 class="mt-4">4. Security Notes</h6>
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Important:</strong> Your API credentials are stored securely and used only for 
                            accessing your Bullhorn data. Never share these credentials with unauthorized parties.
                        </div>

                        <h6 class="mt-4">5. Support Resources</h6>
                        <ul>
                            <li><a href="https://bullhorn.github.io/rest-api-docs/" target="_blank" class="text-decoration-none">
                                Bullhorn REST API Documentation <i class="fas fa-external-link-alt"></i>
                            </a></li>
                            <li><a href="https://supportforums.bullhorn.com/" target="_blank" class="text-decoration-none">
                                Bullhorn Support Forums <i class="fas fa-external-link-alt"></i>
                            </a></li>
                            <li><strong>Bullhorn Support:</strong> Contact through your Bullhorn account portal</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function testConnection() {
            const resultDiv = document.getElementById('connectionTestResult');
            
            // Show loading state
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `
                <div class="alert alert-info">
                    <div class="d-flex align-items-center">
                        <div class="spinner-border spinner-border-sm me-3" role="status">
                            <span class="visually-hidden">Testing...</span>
                        </div>
                        <div>Testing connection to Bullhorn API...</div>
                    </div>
                </div>
            `;

            // Test the connection
            fetch('/api/bullhorn/test-connection', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>
                            ${data.message}
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            ${data.message}
                        </div>
                    `;
                }
            })
            .catch(error => {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Connection test failed: ${error.message}
                    </div>
                `;
            });
        }
        
        function copyToClipboard(inputId, button) {
            const input = document.getElementById(inputId);
            const value = input.value;
            
            navigator.clipboard.writeText(value).then(function() {
                // Show success feedback
                const originalHtml = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check"></i> Copied!';
                button.classList.remove('btn-outline-secondary');
                button.classList.add('btn-success');
                
                setTimeout(function() {
                    button.innerHTML = originalHtml;
                    button.classList.remove('btn-success');
                    button.classList.add('btn-outline-secondary');
                }, 2000);
            });
        }
    </script>
</body>
</html>