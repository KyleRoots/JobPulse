{% extends "base_layout.html" %}
{% block body_attrs %}data-module="inbound"{% endblock %}

{% block title %}ATS Monitoring - JobPulse‚Ñ¢{% endblock %}

{% block extra_head %}
<style>
    .activity-table-container {
        max-height: 750px;
        overflow-y: auto;
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.12);
        backdrop-filter: blur(10px);
    }

    .activity-table-container::-webkit-scrollbar {
        width: 8px;
    }

    .activity-table-container::-webkit-scrollbar-track {
        background: var(--bs-dark);
        border-radius: 4px;
    }

    .activity-table-container::-webkit-scrollbar-thumb {
        background: var(--bs-secondary);
        border-radius: 4px;
    }

    .activity-table-container::-webkit-scrollbar-thumb:hover {
        background: var(--bs-primary);
    }

    .activity-table-container .table {
        margin-bottom: 0;
    }

    .activity-table-container .table thead th {
        position: sticky;
        top: 0;
        background: rgba(52, 58, 64, 0.95);
        backdrop-filter: blur(10px);
        z-index: 10;
        border-bottom: 2px solid rgba(255, 255, 255, 0.15);
    }

    .activity-table-container .table td,
    .activity-table-container .table th {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 200px;
        vertical-align: middle;
    }

    .activity-table-container .badge {
        white-space: nowrap;
        font-size: 0.75rem;
    }

    .activity-table-container td a {
        color: #fff;
        text-decoration: none;
        display: block;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .activity-table-container td a:hover {
        color: #3498db;
        text-decoration: underline;
    }

    .monitor-card {
        background: linear-gradient(145deg, rgba(22, 42, 31, 0.9), rgba(10, 22, 16, 0.95));
        border: 1px solid rgba(74, 150, 120, 0.15);
        backdrop-filter: blur(20px);
        border-radius: 12px;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    }

    .monitor-card:hover {
        background: linear-gradient(145deg, rgba(30, 58, 42, 0.95), rgba(15, 35, 25, 0.98));
        border-color: rgba(74, 150, 120, 0.35);
        transform: translateY(-4px);
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.25), 0 0 25px rgba(74, 150, 120, 0.1);
    }

    .monitor-card.overdue {
        border-left: 4px solid var(--bs-danger) !important;
        background: linear-gradient(145deg, rgba(220, 53, 69, 0.2), rgba(22, 42, 31, 0.9));
    }

    .overdue-indicator {
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% {
            opacity: 1;
        }

        50% {
            opacity: 0.5;
        }

        100% {
            opacity: 1;
        }
    }

    @media (max-width: 768px) {
        .monitor-card {
            margin-bottom: 1rem;
        }

        .monitor-card .btn {
            font-size: 0.875rem;
            padding: 0.5rem 0.75rem;
        }

        .activity-table-container {
            max-height: 400px;
        }

        .activity-table-container .table td,
        .activity-table-container .table th {
            max-width: 150px;
            font-size: 0.875rem;
        }
    }

    @media (max-width: 576px) {
        .monitor-card .btn {
            font-size: 0.8rem;
            padding: 0.4rem 0.6rem;
            margin: 0.2rem;
        }

        .activity-table-container .table td,
        .activity-table-container .table th {
            max-width: 120px;
            font-size: 0.8rem;
        }
    }
</style>
{% endblock %}

{% block page_title %}ATS Monitoring{% endblock %}
{% block page_subtitle %}Monitor ATS tearsheets for job changes{% endblock %}

{% block header_actions %}
<a href="{{ url_for('ats_integration.ats_integration_settings') }}" class="btn btn-outline-info btn-sm">
    <i class="fas fa-cog me-1"></i>ATS Settings
</a>
{% endblock %}

{% block content %}
<!-- Flash Messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
{% for category, message in messages %}
<div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show" role="alert">
    <i class="fas fa-{{ 'exclamation-triangle' if category == 'error' else 'check-circle' }} me-2"></i>
    {{ message }}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endfor %}
{% endif %}
{% endwith %}

<!-- Metrics Row - Horizontal Cards (matching Dashboard style) -->
<div class="metrics-row">
    <div class="metric-card blue">
        <div class="metric-icon">
            <i class="fas fa-desktop"></i>
        </div>
        <div class="metric-label">Active Monitors</div>
        <div class="metric-value">{{ monitors|length }}</div>
        <div class="metric-subtext">Tearsheets Tracked</div>
        <div class="metric-trend neutral">
            <i class="fas fa-eye"></i>
            Watching
        </div>
    </div>

    <div class="metric-card green">
        <div class="metric-icon">
            <i class="fas fa-briefcase"></i>
        </div>
        <div class="metric-label">Total Jobs</div>
        {% set total_jobs = monitor_job_counts.values() | select('number') | sum %}
        <div class="metric-value">{{ total_jobs }}</div>
        <div class="metric-subtext">Across All Tearsheets</div>
        <div class="metric-trend up">
            <i class="fas fa-arrow-up"></i>
            Active
        </div>
    </div>

    <div class="metric-card orange">
        <div class="metric-icon">
            <i class="fas fa-sync-alt"></i>
        </div>
        <div class="metric-label">Last Sync</div>
        <div class="metric-value" style="font-size: 1.5rem;">Now</div>
        <div class="metric-subtext">Auto-refresh enabled</div>
        <div class="metric-trend neutral">
            <i class="fas fa-clock"></i>
            5 min cycle
        </div>
    </div>

    <div class="metric-card purple">
        <div class="metric-icon">
            <i class="fas fa-plug"></i>
        </div>
        <div class="metric-label">Connection</div>
        <div class="metric-value" style="font-size: 1.5rem;">{{ 'Live' if bullhorn_connected else 'Offline' }}</div>
        <div class="metric-subtext">Bullhorn API</div>
        <div class="metric-trend {{ 'up' if bullhorn_connected else 'neutral' }}">
            <i class="fas fa-{{ 'check' if bullhorn_connected else 'exclamation-triangle' }}"></i>
            {{ 'Connected' if bullhorn_connected else 'Setup Required' }}
        </div>
    </div>
</div>

<!-- ATS Selection -->
<div class="card glass-card mb-4">
    <div class="card-body">
        <h5 class="card-title">
            <i class="fas fa-network-wired me-2"></i>
            ATS Provider Selection
        </h5>
        <p class="text-muted">Choose your ATS provider for monitoring tearsheets and job changes</p>

        <div class="row">
            <div class="col-md-6">
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="ats_provider" id="bullhorn_provider"
                        value="bullhorn" checked>
                    <label class="form-check-label" for="bullhorn_provider">
                        <i class="fas fa-building me-2"></i>
                        <strong>Bullhorn</strong>
                        <span class="badge bg-{{ 'success' if bullhorn_connected else 'warning' }} ms-2"
                            id="bullhorn_status">
                            {{ 'Connected' if bullhorn_connected else 'Setup Required' }}
                        </span>
                    </label>
                    <div class="text-muted small mt-1">
                        Professional ATS/CRM platform with tearsheet monitoring
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="text-muted">
                    <i class="fas fa-plus-circle me-2"></i>
                    More ATS providers coming soon...
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Setup Status -->
{% if not bullhorn_connected %}
<div class="alert alert-warning mb-4">
    <i class="fas fa-exclamation-triangle me-2"></i>
    <strong>Setup Required:</strong> Configure your Bullhorn API credentials in
    <a href="{{ url_for('ats_integration.ats_integration_settings') }}" class="alert-link">ATS Settings</a>
    before creating monitors.
</div>
{% endif %}

<!-- Active Monitors -->
<div class="card glass-card mb-4">
    <div
        class="card-header bg-transparent border-bottom border-secondary d-flex justify-content-between align-items-center flex-wrap gap-2">
        <h5 class="card-title mb-0">
            <i class="fas fa-desktop me-2"></i>
            Active Monitors ({{ monitors|length }})
            {% set total_jobs = monitor_job_counts.values() | select('number') | sum %}
            {% if total_jobs > 0 %}
            <span class="text-muted">| {{ total_jobs }} jobs in all tearsheets</span>
            {% endif %}
        </h5>
        <div class="d-flex flex-wrap gap-2">
            <button onclick="syncNow()" class="btn btn-success btn-sm" id="syncNowBtn">
                <i class="fas fa-file-alt me-2"></i>Sync Now
            </button>
            <button onclick="fixAIClassifications()" class="btn btn-outline-warning btn-sm" id="aiFixBtn"
                title="Check and fix missing AI classifications">
                <i class="fas fa-brain me-1"></i>Fix AI
            </button>
            <button onclick="triggerFileCleanup()" class="btn btn-outline-info btn-sm" id="cleanupBtn"
                title="Clean up temporary and backup files">
                <i class="fas fa-broom me-1"></i>Cleanup
            </button>
            <button onclick="generateFreshXML()" class="btn btn-primary btn-sm" id="generateXMLBtn"
                title="Generate fresh XML from all Bullhorn tearsheets">
                <i class="fas fa-sync-alt me-1"></i>Fresh XML
            </button>
            <a href="{{ url_for('ats_integration.create_ats_monitor') }}" class="btn btn-primary btn-sm">
                <i class="fas fa-plus me-1"></i>Create Monitor
            </a>
        </div>
    </div>
    <div class="card-body">
        {% if monitors %}
        <div class="row">
            {% for monitor in monitors %}
            <div class="col-md-6 col-lg-4 mb-3">
                <div class="card h-100 monitor-card" data-monitor-id="{{ monitor.id }}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="card-title mb-0">{{ monitor.name }}</h6>
                            <div class="d-flex gap-1 flex-wrap">
                                {% if monitor_job_counts[monitor.id] is not none %}
                                <span class="badge bg-info job-count-badge">{{ monitor_job_counts[monitor.id] }}
                                    jobs</span>
                                <button class="btn btn-sm btn-link p-0"
                                    onclick="viewMonitorJobs({{ monitor.id }}, '{{ monitor.name }}')"
                                    title="View current jobs from Bullhorn" style="color: #ffffff !important;">
                                    <i class="fas fa-list"></i>
                                </button>
                                {% endif %}
                                <span class="badge bg-danger overdue-indicator" style="display: none;">
                                    <i class="fas fa-exclamation-triangle me-1"></i>OVERDUE
                                </span>
                            </div>
                        </div>
                        <p class="card-text text-muted">
                            <small>
                                {% if monitor.tearsheet_id == 0 %}
                                <i class="fas fa-search me-1"></i>Query: {{ monitor.tearsheet_name }}<br>
                                {% else %}
                                <i class="fas fa-clipboard-list me-1"></i>Tearsheet: {{ monitor.tearsheet_name }}<br>
                                {% endif %}
                                <i class="fas fa-clock me-1"></i>Check every {{ monitor.check_interval_minutes }}
                                minutes<br>
                                <i class="fas fa-calendar me-1"></i><span class="last-check">Last check:
                                    {% if monitor.last_check %}
                                    {{ monitor.last_check.strftime('%Y-%m-%d %H:%M') }}
                                    {% else %}
                                    Never
                                    {% endif %}</span><br>
                                <i class="fas fa-forward me-1"></i>Next check:
                                {% if monitor.next_check %}
                                {{ monitor.next_check.strftime('%Y-%m-%d %H:%M') }}
                                {% else %}
                                Calculating...
                                {% endif %}
                            </small>
                        </p>
                        <div class="d-flex gap-1 flex-wrap">
                            <a href="{{ url_for('ats_integration.ats_monitor_details', monitor_id=monitor.id) }}"
                                class="btn btn-sm btn-outline-info">
                                <i class="fas fa-eye me-1"></i>View
                            </a>
                            <button onclick="testMonitor({{ monitor.id }})" class="btn btn-sm btn-outline-warning">
                                <i class="fas fa-vial me-1"></i>Test
                            </button>
                            <form method="POST"
                                action="{{ url_for('ats_integration.delete_ats_monitor', monitor_id=monitor.id) }}"
                                class="d-inline"
                                onsubmit="return confirm('Are you sure you want to delete this monitor?')">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button type="submit" class="btn btn-sm btn-outline-danger">
                                    <i class="fas fa-trash me-1"></i>Delete
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-4">
            <i class="fas fa-desktop fa-3x text-muted mb-3"></i>
            <h5>No Active Monitors</h5>
            <p class="text-muted">Create your first Bullhorn monitor to start tracking tearsheet changes.</p>
            <a href="{{ url_for('ats_integration.create_ats_monitor') }}" class="btn btn-primary">
                <i class="fas fa-plus me-2"></i>Create Your First Monitor
            </a>
        </div>
        {% endif %}
    </div>
</div>

<!-- Job Verification Modal -->
<div class="modal fade" id="jobListModal" tabindex="-1" aria-labelledby="jobListModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="jobListModalLabel">
                    <i class="fas fa-list me-2"></i>Current Jobs - <span id="monitorNameInModal"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="jobListLoading" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading jobs...</span>
                    </div>
                    <p class="mt-2 text-muted">Fetching current jobs from Bullhorn...</p>
                </div>
                <div id="jobListContent" style="display: none;">
                    <div class="mb-3">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            This shows the current jobs pulled from Bullhorn for verification purposes.
                        </small>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th width="80">Job ID</th>
                                    <th>Title</th>
                                    <th>Location</th>
                                    <th>Type</th>
                                    <th>Status</th>
                                    <th>Date Modified</th>
                                </tr>
                            </thead>
                            <tbody id="jobListTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
                <div id="jobListError" style="display: none;" class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Error loading jobs:</strong> <span id="jobListErrorMessage"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="refreshJobList()">
                    <i class="fas fa-sync me-1"></i>Refresh
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Test Monitor Modal -->
<div class="modal fade" id="testModal" tabindex="-1" aria-labelledby="testModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="testModalLabel">
                    <i class="fas fa-vial me-2"></i>Testing Monitor
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="testResult">
                    <div class="d-flex align-items-center">
                        <div class="spinner-border spinner-border-sm me-3" role="status">
                            <span class="visually-hidden">Testing...</span>
                        </div>
                        <div>Testing connection to Bullhorn API...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // HTML escaping utility to prevent XSS
    function escapeHTML(str) {
        if (typeof str !== 'string') return str;
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    // JavaScript version of the activity detail formatter
    function formatActivityDetails(activityType, detailsJson) {
        if (!detailsJson) return "No details available";

        let details;
        try {
            details = typeof detailsJson === 'string' ? JSON.parse(detailsJson) : detailsJson;
        } catch (e) {
            return typeof detailsJson === 'string' ? detailsJson : "No details available";
        }

        switch (activityType) {
            case 'email_notification':
                const monitorType = details.monitor_type || 'Unknown';
                const changes = details.changes_detected || 0;
                const added = details.added_jobs || 0;
                const removed = details.removed_jobs || 0;
                const modified = details.modified_jobs || 0;

                if (changes === 0) return `${monitorType}: No changes detected`;

                const changeParts = [];
                if (added > 0) changeParts.push(`+${added} added`);
                if (removed > 0) changeParts.push(`-${removed} removed`);
                if (modified > 0) changeParts.push(`~${modified} modified`);

                const changeSummary = changeParts.length > 0 ? changeParts.join(', ') : 'processed';
                return `${monitorType}: ${changes} jobs (${changeSummary})`;

            case 'xml_sync_completed':
                const jobsProcessed = details.jobs_processed || details.total_jobs || 0;
                const cycleTime = details.cycle_time || 0;
                const timeInfo = cycleTime > 0 ? ` in ${cycleTime.toFixed(1)}s` : '';
                return `XML Sync: ${jobsProcessed} jobs processed${timeInfo}`;

            case 'check_completed':
                const results = details.results || {};
                const monitorName = details.monitor_name || 'Monitor';
                const jobsFound = results.jobs_found || results.total_jobs || 0;
                return `${monitorName}: ${jobsFound} jobs verified`;

            case 'job_added':
                const jobTitle = details.job_title || details.title || 'Unknown Job';
                const company = details.company || '';
                const location = details.location || '';

                let parts = [jobTitle];
                if (company) parts.push(`at ${company}`);
                if (location) parts.push(`in ${location}`);
                return parts.join(' ');

            case 'job_removed':
                const removedTitle = details.job_title || details.title || 'Unknown Job';
                const reason = details.reason || 'No longer active';
                return `${removedTitle} - ${reason}`;

            case 'job_modified':
                const modificationChanges = details.changes || {};
                if (typeof modificationChanges === 'object' && Object.keys(modificationChanges).length > 0) {
                    const changeList = [];
                    for (const field in modificationChanges) {
                        const changeInfo = modificationChanges[field];
                        if (typeof changeInfo === 'object' && changeInfo.old && changeInfo.new) {
                            changeList.push(`${field} updated`);
                        } else {
                            changeList.push(field);
                        }
                    }
                    if (changeList.length > 0) {
                        return `Updated: ${changeList.join(', ')}`;
                    }
                }
                return details.description || 'Job details updated';

            case 'error':
                const errorMsg = details.error || details.message || 'Unknown error';
                return `Error: ${errorMsg}`;

            default:
                if (details.message) return details.message;
                if (details.description) return details.description;
                if (details.total_jobs) return `Processed ${details.total_jobs} jobs`;
                if (details.jobs_count) return `Processed ${details.jobs_count} jobs`;

                const detailStr = JSON.stringify(details);
                return detailStr.length > 100 ? detailStr.substring(0, 100) + '...' : detailStr;
        }
    }

    function testMonitor(monitorId) {
        const modal = new bootstrap.Modal(document.getElementById('testModal'));
        const resultDiv = document.getElementById('testResult');

        modal.show();

        fetch(`/ats-integration/monitor/${monitorId}/test`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle me-2"></i>
                        ${data.message}
                    </div>
                `;
                } else {
                    resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        ${data.message}
                    </div>
                `;
                }
            })
            .catch(error => {
                resultDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Error testing monitor: ${error.message}
                </div>
            `;
            });
    }

    function checkSystemHealth() {
        fetch('/api/system/health')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.health_status !== 'healthy') {
                    const healthIndicator = document.querySelector('.display-4');
                    if (healthIndicator) {
                        healthIndicator.innerHTML = `
                            <i class="fas fa-building me-3"></i>
                            ATS Monitoring 
                            <span class="badge bg-warning ms-2">
                                <i class="fas fa-exclamation-triangle me-1"></i>Health Issues
                            </span>
                        `;
                    }
                }
            })
            .catch(error => { });
    }

    function updateMonitorStatus() {
        fetch('/api/ats-integration/monitors')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.monitors) {
                    data.monitors.forEach(monitor => {
                        const monitorCard = document.querySelector(`[data-monitor-id="${monitor.id}"]`);
                        if (monitorCard) {
                            const overdueIndicator = monitorCard.querySelector('.overdue-indicator');

                            if (monitor.is_overdue) {
                                overdueIndicator.style.display = 'inline';
                                monitorCard.classList.add('overdue');
                                overdueIndicator.title = `Overdue by ${monitor.overdue_minutes} minutes`;
                            } else {
                                overdueIndicator.style.display = 'none';
                                monitorCard.classList.remove('overdue');
                            }

                            const jobCountBadge = monitorCard.querySelector('.job-count-badge');
                            if (jobCountBadge && monitor.job_count !== null) {
                                jobCountBadge.textContent = `${monitor.job_count} jobs`;
                            }
                        }
                    });
                }
            })
            .catch(error => { });
    }

    function updateRecentActivity() {
        const syncStatus = document.getElementById('cycle-sync-status');
        if (syncStatus) {
            syncStatus.innerHTML = `
                <div class="badge bg-warning">
                    <div class="spinner-border spinner-border-sm me-1" style="width: 0.8rem; height: 0.8rem;"></div>
                    Syncing...
                </div>
            `;
        }

        fetch('/api/ats-integration/activities')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.activities) {
                    const tbody = document.querySelector('#activity-table tbody');
                    if (tbody) {
                        const container = document.querySelector('.activity-table-container');
                        const scrollTop = container ? container.scrollTop : 0;

                        tbody.innerHTML = '';
                        data.activities.forEach(activity => {
                            const row = document.createElement('tr');

                            const activityTime = new Date(activity.created_at);
                            const timeStr = activityTime.toLocaleTimeString('en-US', {
                                hour12: false,
                                timeZone: 'UTC',
                                hour: '2-digit',
                                minute: '2-digit',
                                second: '2-digit'
                            });
                            const dateStr = activityTime.toLocaleDateString('en-US', {
                                month: 'numeric',
                                day: 'numeric'
                            });

                            const now = new Date();
                            const timeDiff = now - activityTime;
                            const isCurrentCycle = timeDiff < (6 * 60 * 1000);

                            const badgeClass = activity.activity_type === 'check_completed' ? 'info' :
                                activity.activity_type === 'job_added' ? 'success' :
                                    activity.activity_type === 'job_removed' ? 'warning' :
                                        activity.activity_type === 'job_modified' ? 'primary' :
                                            activity.activity_type === 'xml_sync_completed' ? 'secondary' : 'dark';

                            const td1 = document.createElement('td');
                            const link = document.createElement('a');
                            link.className = 'text-decoration-none';
                            link.href = `/ats-integration/monitor/${activity.monitor_id}`;
                            link.textContent = activity.monitor_name || 'Scheduled Processing';
                            td1.appendChild(link);

                            const td2 = document.createElement('td');
                            const badge = document.createElement('span');
                            badge.className = `badge bg-${badgeClass}`;
                            badge.textContent = activity.activity_type.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
                            td2.appendChild(badge);

                            if (isCurrentCycle) {
                                const currentBadge = document.createElement('span');
                                currentBadge.className = 'badge bg-success ms-1';
                                currentBadge.title = 'Current monitoring cycle';
                                currentBadge.innerHTML = '<i class="fas fa-clock"></i>';
                                td2.appendChild(currentBadge);
                            }

                            const td3 = document.createElement('td');
                            td3.style.maxWidth = '300px';
                            td3.style.overflow = 'hidden';
                            td3.style.textOverflow = 'ellipsis';
                            td3.style.whiteSpace = 'nowrap';

                            if (activity.job_id) {
                                const jobBadge = document.createElement('span');
                                jobBadge.className = 'badge bg-secondary me-2';
                                jobBadge.textContent = activity.job_id;
                                td3.appendChild(jobBadge);
                            }

                            const detailsText = formatActivityDetails(activity.activity_type, activity.details) || activity.job_title || '';
                            const detailsSpan = document.createElement('span');
                            detailsSpan.textContent = detailsText;
                            td3.appendChild(detailsSpan);

                            const td4 = document.createElement('td');
                            const timeSmall = document.createElement('small');
                            timeSmall.className = 'text-muted';
                            timeSmall.textContent = `${timeStr} UTC`;
                            td4.appendChild(timeSmall);
                            td4.appendChild(document.createElement('br'));

                            const dateBadge = document.createElement('span');
                            dateBadge.className = 'badge bg-light text-dark';
                            dateBadge.style.fontSize = '0.7em';
                            dateBadge.textContent = dateStr;
                            td4.appendChild(dateBadge);

                            const td5 = document.createElement('td');
                            const icon = document.createElement('i');
                            if (activity.notification_sent) {
                                icon.className = 'fas fa-envelope text-success';
                                icon.title = 'Email sent';
                            } else {
                                icon.className = 'fas fa-envelope-open text-muted';
                                icon.title = 'No email';
                            }
                            td5.appendChild(icon);

                            row.appendChild(td1);
                            row.appendChild(td2);
                            row.appendChild(td3);
                            row.appendChild(td4);
                            row.appendChild(td5);
                            tbody.appendChild(row);
                        });

                        if (container) {
                            container.scrollTop = scrollTop;
                        }
                    }

                    if (syncStatus) {
                        syncStatus.innerHTML = `
                            <div class="badge bg-success">
                                <i class="fas fa-sync me-1"></i>Synced with Monitor Cycles
                            </div>
                        `;
                    }
                } else {
                    if (syncStatus) {
                        syncStatus.innerHTML = `
                            <div class="badge bg-danger">
                                <i class="fas fa-exclamation-triangle me-1"></i>Sync Error
                            </div>
                        `;
                    }
                }
            })
            .catch(error => {
                const syncStatus = document.getElementById('cycle-sync-status');
                if (syncStatus) {
                    syncStatus.innerHTML = `
                        <div class="badge bg-danger">
                            <i class="fas fa-exclamation-triangle me-1"></i>Sync Error
                        </div>
                    `;
                }
            });
    }

    let currentMonitorId = null;
    let currentMonitorName = null;

    function viewMonitorJobs(monitorId, monitorName) {
        currentMonitorId = monitorId;
        currentMonitorName = monitorName;

        document.getElementById('monitorNameInModal').textContent = monitorName;

        const modal = new bootstrap.Modal(document.getElementById('jobListModal'));
        modal.show();

        document.getElementById('jobListLoading').style.display = 'block';
        document.getElementById('jobListContent').style.display = 'none';
        document.getElementById('jobListError').style.display = 'none';

        loadMonitorJobs(monitorId);
    }

    function loadMonitorJobs(monitorId) {
        fetch(`/api/ats-integration/monitor/${monitorId}/jobs`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('jobListLoading').style.display = 'none';

                if (data.success) {
                    displayJobList(data.jobs);
                    document.getElementById('jobListContent').style.display = 'block';
                } else {
                    document.getElementById('jobListErrorMessage').textContent = data.error || 'Unknown error occurred';
                    document.getElementById('jobListError').style.display = 'block';
                }
            })
            .catch(error => {
                document.getElementById('jobListLoading').style.display = 'none';
                document.getElementById('jobListErrorMessage').textContent = 'Network error: ' + error.message;
                document.getElementById('jobListError').style.display = 'block';
            });
    }

    function displayJobList(jobs) {
        const tbody = document.getElementById('jobListTableBody');
        tbody.innerHTML = '';

        if (jobs.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center text-muted py-4">
                        <i class="fas fa-inbox fa-2x mb-2"></i><br>
                        No jobs found for this monitor
                    </td>
                </tr>
            `;
            return;
        }

        jobs.forEach(job => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>
                    <span class="badge bg-secondary">${job.id}</span>
                </td>
                <td>
                    <strong>${job.title || 'No Title'}</strong>
                    ${job.id ? `<br><small class="text-muted">Job ID: ${job.id}</small>` : ''}
                </td>
                <td>
                    ${job.city || ''} ${job.state ? ', ' + job.state : ''}
                    ${job.country && job.country !== 'United States' ? '<br>' + job.country : ''}
                </td>
                <td>
                    <span class="badge bg-info">${job.employmentType || 'N/A'}</span>
                    ${job.onSite ? `<br><small class="text-muted">${job.onSite}</small>` : ''}
                </td>
                <td>
                    <span class="badge bg-${job.status === 'Open' ? 'success' : 'secondary'}">
                        ${job.status || 'Unknown'}
                    </span>
                    ${job.isPublic ? '<br><span class="badge bg-primary">Public</span>' : ''}
                </td>
                <td>
                    <small class="text-muted">
                        ${job.dateLastModified ? new Date(job.dateLastModified).toLocaleDateString() + '<br>' + new Date(job.dateLastModified).toLocaleTimeString() : 'N/A'}
                    </small>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    function refreshJobList() {
        if (currentMonitorId) {
            document.getElementById('jobListLoading').style.display = 'block';
            document.getElementById('jobListContent').style.display = 'none';
            document.getElementById('jobListError').style.display = 'none';

            loadMonitorJobs(currentMonitorId);
        }
    }

    function syncNow() {
        const btn = document.getElementById('syncNowBtn');
        const originalHtml = btn.innerHTML;

        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-file-alt fa-spin me-2"></i>Syncing...';

        fetch('/api/trigger/job-sync', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    btn.innerHTML = '<i class="fas fa-check me-2"></i>Sync Complete!';
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-info');

                    updateRecentActivity();

                    setTimeout(() => {
                        btn.innerHTML = originalHtml;
                        btn.disabled = false;
                        btn.classList.remove('btn-info');
                        btn.classList.add('btn-success');
                    }, 3000);
                } else {
                    btn.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Sync Failed';
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-danger');

                    setTimeout(() => {
                        btn.innerHTML = originalHtml;
                        btn.disabled = false;
                        btn.classList.remove('btn-danger');
                        btn.classList.add('btn-success');
                    }, 3000);
                }
            })
            .catch(error => {
                btn.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Error';
                btn.classList.remove('btn-success');
                btn.classList.add('btn-danger');

                setTimeout(() => {
                    btn.innerHTML = originalHtml;
                    btn.disabled = false;
                    btn.classList.remove('btn-danger');
                    btn.classList.add('btn-success');
                }, 3000);
            });
    }

    function fixAIClassifications() {
        const btn = document.getElementById('aiFixBtn');
        const originalHtml = btn.innerHTML;

        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-brain fa-spin me-2"></i>Fixing...';

        fetch('/api/trigger/ai-classification-fix', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    btn.innerHTML = '<i class="fas fa-check me-2"></i>Fixed!';
                    btn.classList.remove('btn-outline-warning');
                    btn.classList.add('btn-success');

                    if (data.fixed_count > 0) {
                        showNotification(`Fixed AI classifications for ${data.fixed_count} jobs`, 'success');
                    } else {
                        showNotification('All jobs already have complete AI classifications', 'info');
                    }

                    setTimeout(() => {
                        btn.innerHTML = originalHtml;
                        btn.disabled = false;
                        btn.classList.remove('btn-success');
                        btn.classList.add('btn-outline-warning');
                    }, 3000);
                } else {
                    btn.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Failed';
                    btn.classList.remove('btn-outline-warning');
                    btn.classList.add('btn-danger');

                    showNotification(data.error || 'Failed to fix AI classifications', 'error');

                    setTimeout(() => {
                        btn.innerHTML = originalHtml;
                        btn.disabled = false;
                        btn.classList.remove('btn-danger');
                        btn.classList.add('btn-outline-warning');
                    }, 3000);
                }
            })
            .catch(error => {
                btn.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Error';
                btn.classList.remove('btn-outline-warning');
                btn.classList.add('btn-danger');

                showNotification('Error fixing AI classifications: ' + error.message, 'error');

                setTimeout(() => {
                    btn.innerHTML = originalHtml;
                    btn.disabled = false;
                    btn.classList.remove('btn-danger');
                    btn.classList.add('btn-outline-warning');
                }, 3000);
            });
    }

    function triggerFileCleanup() {
        const cleanupBtn = document.getElementById('cleanupBtn');
        const originalText = cleanupBtn.innerHTML;

        cleanupBtn.disabled = true;
        cleanupBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Cleaning...';

        fetch('/api/trigger/file-cleanup', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const summary = data.results.summary;
                    const filesRemoved = summary.total_files_removed || 0;
                    const sizeFreed = summary.total_size_freed_mb || 0;

                    cleanupBtn.innerHTML = `<i class="fas fa-check me-2"></i>Done`;
                    cleanupBtn.classList.remove('btn-outline-info');
                    cleanupBtn.classList.add('btn-outline-success');

                    showNotification(`File cleanup complete: removed ${filesRemoved} files, freed ${sizeFreed}MB`, 'success');

                    setTimeout(() => {
                        cleanupBtn.disabled = false;
                        cleanupBtn.innerHTML = originalText;
                        cleanupBtn.classList.remove('btn-outline-success');
                        cleanupBtn.classList.add('btn-outline-info');
                    }, 5000);
                } else {
                    cleanupBtn.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Failed';
                    cleanupBtn.classList.remove('btn-outline-info');
                    cleanupBtn.classList.add('btn-danger');

                    showNotification(data.error || 'File cleanup failed', 'error');

                    setTimeout(() => {
                        cleanupBtn.disabled = false;
                        cleanupBtn.innerHTML = originalText;
                        cleanupBtn.classList.remove('btn-danger');
                        cleanupBtn.classList.add('btn-outline-info');
                    }, 3000);
                }
            })
            .catch(error => {
                cleanupBtn.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Error';
                cleanupBtn.classList.remove('btn-outline-info');
                cleanupBtn.classList.add('btn-danger');

                showNotification('Error during file cleanup: ' + error.message, 'error');

                setTimeout(() => {
                    cleanupBtn.disabled = false;
                    cleanupBtn.innerHTML = originalText;
                    cleanupBtn.classList.remove('btn-danger');
                    cleanupBtn.classList.add('btn-outline-info');
                }, 3000);
            });
    }

    function generateFreshXML() {
        const generateBtn = document.getElementById('generateXMLBtn');
        const originalHtml = generateBtn.innerHTML;

        generateBtn.disabled = true;
        generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generating...';

        showNotification('üöÄ Generating fresh XML from Bullhorn tearsheets...', 'info');

        fetch('{{ url_for("xml_routes.download_current_xml") }}')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }

                const contentType = response.headers.get('content-type');
                const contentDisposition = response.headers.get('content-disposition');

                if (!contentType || (!contentType.includes('xml') && !contentType.includes('octet-stream'))) {
                    if (!contentDisposition || !contentDisposition.includes('attachment')) {
                        throw new Error('Response does not appear to be a downloadable XML file');
                    }
                }

                generateBtn.innerHTML = '<i class="fas fa-download fa-spin me-2"></i>Downloading...';

                return response.blob();
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `myticas-job-feed-v2_${new Date().toISOString().slice(0, 19).replace(/[:-]/g, '')}.xml`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);

                setTimeout(() => {
                    window.URL.revokeObjectURL(url);
                }, 1000);

                generateBtn.disabled = false;
                generateBtn.innerHTML = originalHtml;
                showNotification('‚úÖ XML downloaded successfully!', 'success');
            })
            .catch(error => {
                generateBtn.disabled = false;
                generateBtn.innerHTML = originalHtml;
                showNotification('‚ùå Error generating XML: ' + error.message, 'error');
                console.error('Download error:', error);
            });
    }

    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 400px;';
        notification.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;

        document.body.appendChild(notification);

        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 5000);
    }

    function getNextMonitoringCycleTime() {
        const now = new Date();
        const minutes = now.getMinutes();

        const nextInterval = Math.ceil(minutes / 5) * 5;
        const nextCycleTime = new Date(now);
        nextCycleTime.setMinutes(nextInterval, 3, 0);

        if (nextCycleTime <= now) {
            nextCycleTime.setHours(nextCycleTime.getHours() + 1, 0, 3, 0);
        }

        return nextCycleTime;
    }

    function syncWithMonitoringCycles() {
        const nextCycle = getNextMonitoringCycleTime();
        const now = new Date();
        const timeUntilNext = nextCycle - now;

        if (timeUntilNext < 30000) {
            setTimeout(() => {
                updateMonitorStatus();
                updateRecentActivity();
                checkSystemHealth();
            }, timeUntilNext + 5000);
        }

        setTimeout(syncWithMonitoringCycles, Math.min(timeUntilNext, 60000));
    }

    document.addEventListener('DOMContentLoaded', function () {
        checkSystemHealth();
        updateMonitorStatus();
        updateRecentActivity();

        syncWithMonitoringCycles();

        setInterval(checkSystemHealth, 120000);
        setInterval(updateMonitorStatus, 120000);
        setInterval(updateRecentActivity, 120000);
    });
</script>
{% endblock %}