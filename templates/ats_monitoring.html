{% extends "base_layout.html" %}
{% block body_attrs %}data-module="inbound"{% endblock %}

{% block title %}ATS Monitoring - Scout Inboundâ„¢{% endblock %}

{% block extra_head %}
<style>
    /* Button sizing override (page-specific) */
    .btn-group-sm .btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }
</style>
{% endblock %}

{% block page_title %}ATS Monitoring Dashboard{% endblock %}
{% block page_subtitle %}Monitor Bullhorn tearsheets and job changes in real-time{% endblock %}

{% block header_actions %}
<button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#createMonitorModal">
    <i class="fas fa-plus me-1"></i>Add Monitor
</button>
{% endblock %}

{% block content %}
<!-- System Status -->
<div class="card glass-card mb-4">
    <div class="card-body">
        <h5 class="card-title"><i class="fas fa-heartbeat me-2"></i>System Status</h5>
        <div id="systemStatus" class="d-flex align-items-center">
            <div class="loading-spinner spinner-border spinner-border-sm me-2" role="status"></div>
            <span>Loading system status...</span>
        </div>
    </div>
</div>

<!-- Active Monitors -->
<div class="card glass-card mb-4">
    <div
        class="card-header bg-transparent border-bottom border-secondary d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="fas fa-eye me-2"></i>Active Monitors<span id="totalJobCount"
                class="ms-2 badge bg-primary" style="font-size: 0.75rem; vertical-align: middle; display: none;"></span>
        </h5>
        <button class="btn btn-sm btn-outline-info" onclick="refreshMonitors()">
            <i class="fas fa-refresh me-1"></i>Refresh
        </button>
    </div>
    <div class="card-body">
        <div id="monitorsContainer" class="row">
            <div class="col-12 text-center py-4">
                <div class="loading-spinner spinner-border" role="status"></div>
                <div>Loading monitors...</div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Activity -->
<div class="card glass-card mb-4">
    <div
        class="card-header bg-transparent border-bottom border-secondary d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="fas fa-history me-2"></i>Recent Activity</h5>
        <button class="btn btn-sm btn-outline-info" onclick="refreshActivities()">
            <i class="fas fa-refresh me-1"></i>Refresh
        </button>
    </div>
    <div class="card-body p-0">
        <div class="activity-table">
            <table class="table table-striped table-hover mb-0">
                <thead class="table-dark sticky-top">
                    <tr>
                        <th>Time</th>
                        <th>Monitor</th>
                        <th>Type</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody id="activitiesTableBody">
                    <tr>
                        <td colspan="4" class="text-center py-4">
                            <div class="loading-spinner spinner-border" role="status"></div>
                            <div>Loading activities...</div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Create Monitor Modal -->
<div class="modal fade" id="createMonitorModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content feedback-modal-content">
            <div class="modal-header border-bottom border-secondary">
                <h5 class="modal-title">Add New Monitor</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createMonitorForm">
                    <div class="mb-3">
                        <label for="monitorName" class="form-label">Monitor Name</label>
                        <input type="text" class="form-control" id="monitorName" required>
                    </div>
                    <div class="mb-3">
                        <label for="tearsheetName" class="form-label">Tearsheet/Query</label>
                        <input type="text" class="form-control" id="tearsheetName" required>
                        <div class="form-text">Enter tearsheet name or Bullhorn query (e.g., "status:Open AND
                            isPublic:1")</div>
                    </div>
                    <div class="mb-3">
                        <label for="tearsheetId" class="form-label">Tearsheet ID (Optional)</label>
                        <input type="number" class="form-control" id="tearsheetId" value="0">
                        <div class="form-text">Leave as 0 for query-based monitoring</div>
                    </div>
                    <div class="mb-3">
                        <label for="intervalMinutes" class="form-label">Check Interval (minutes)</label>
                        <select class="form-control" id="intervalMinutes">
                            <option value="5" selected>5 minutes</option>
                            <option value="10">10 minutes</option>
                            <option value="15">15 minutes</option>
                            <option value="30">30 minutes</option>
                            <option value="60">60 minutes</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-top border-secondary">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createMonitor()">Create Monitor</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    let refreshInterval;

    document.addEventListener('DOMContentLoaded', function () {
        loadSystemStatus();
        loadMonitors();
        loadActivities();

        // Set up auto-refresh every 5 minutes
        refreshInterval = setInterval(function () {
            loadSystemStatus();
            loadMonitors();
            loadActivities();
        }, 300000); // 5 minutes
    });

    function loadSystemStatus() {
        fetch('/api/system/health')
            .then(response => response.json())
            .then(data => {
                const statusDiv = document.getElementById('systemStatus');
                const status = data.health_status || data.status || 'unknown';
                const healthy = (data.timing_accuracy && data.timing_accuracy.healthy_monitors) ??
                    data.healthy_monitors ?? 0;
                const total = (data.timing_accuracy && data.timing_accuracy.total_monitors) ??
                    data.total_monitors ?? 0;
                const statusClass = status === 'healthy' ? 'text-success' :
                    status === 'warning' ? 'text-warning' : 'text-danger';
                const statusIcon = status === 'healthy' ? 'fas fa-check-circle' :
                    status === 'warning' ? 'fas fa-exclamation-triangle' : 'fas fa-times-circle';

                statusDiv.innerHTML = `
                    <i class="${statusIcon} ${statusClass} me-2"></i>
                    <span class="${statusClass}">
                        ${status.charAt(0).toUpperCase() + status.slice(1)} - 
                        ${healthy}/${total} monitors healthy
                    </span>
                `;
            })
            .catch(error => {
                document.getElementById('systemStatus').innerHTML =
                    '<i class="fas fa-times-circle text-danger me-2"></i><span class="text-danger">Error loading status</span>';
            });
    }

    function loadMonitors() {
        fetch('/api/monitors')
            .then(response => response.json())
            .then(monitors => {
                const container = document.getElementById('monitorsContainer');

                if (monitors.length === 0) {
                    container.innerHTML = `
                        <div class="col-12 text-center py-4">
                            <i class="fas fa-eye-slash fa-3x text-muted mb-3"></i>
                            <p>No monitors configured</p>
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createMonitorModal">
                                <i class="fas fa-plus"></i> Add First Monitor
                            </button>
                        </div>
                    `;
                    document.getElementById('totalJobCount').style.display = 'none';
                    return;
                }

                container.innerHTML = monitors.map(monitor => `
                    <div class="col-lg-6 col-xl-4 mb-3">
                        <div class="card monitor-card ${monitor.is_active ? '' : 'inactive'}">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="card-title mb-0">${monitor.name}</h6>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-secondary" onclick="toggleMonitor(${monitor.id})" 
                                                title="${monitor.is_active ? 'Deactivate' : 'Activate'}">
                                            <i class="fas fa-${monitor.is_active ? 'pause' : 'play'}"></i>
                                        </button>
                                        <button class="btn btn-outline-danger" onclick="deleteMonitor(${monitor.id})" 
                                                title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="small text-muted mb-2">
                                    <div><i class="fas fa-list"></i> ${monitor.tearsheet_name}</div>
                                    <div><i class="fas fa-clock"></i> Every ${monitor.interval_minutes} minutes</div>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="badge bg-primary job-count-badge">
                                        ${monitor.job_count} jobs
                                    </span>
                                    <div class="text-end small">
                                        <div class="d-flex align-items-center">
                                            <span class="status-indicator status-${monitor.is_active ? 'active' : 'inactive'}"></span>
                                            ${monitor.is_active ? 'Active' : 'Inactive'}
                                        </div>
                                        <div class="text-muted">
                                            Next check: ${monitor.next_check ? new Date(monitor.next_check).toLocaleTimeString() : 'N/A'}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');

                // Update total job count badge in header
                const totalJobs = monitors.reduce((sum, m) => sum + (m.job_count || 0), 0);
                const badge = document.getElementById('totalJobCount');
                badge.textContent = `${totalJobs} jobs total`;
                badge.style.display = 'inline-block';
            })
            .catch(error => {
                document.getElementById('monitorsContainer').innerHTML =
                    '<div class="col-12 text-center py-4 text-danger">Error loading monitors</div>';
            });
    }

    function loadActivities() {
        fetch('/api/activities')
            .then(response => response.json())
            .then(activities => {
                const tbody = document.getElementById('activitiesTableBody');

                if (activities.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4">No recent activity</td></tr>';
                    return;
                }

                tbody.innerHTML = activities.map(activity => `
                    <tr>
                        <td class="activity-timestamp">${new Date(activity.timestamp).toLocaleString()}</td>
                        <td>${activity.monitor_name}</td>
                        <td><span class="activity-type type-${activity.activity_type}">${activity.activity_type.replace('_', ' ')}</span></td>
                        <td>${activity.details}</td>
                    </tr>
                `).join('');
            })
            .catch(error => {
                document.getElementById('activitiesTableBody').innerHTML =
                    '<tr><td colspan="4" class="text-center py-4 text-danger">Error loading activities</td></tr>';
            });
    }

    function refreshMonitors() {
        loadMonitors();
    }

    function refreshActivities() {
        loadActivities();
    }

    function createMonitor() {
        const form = document.getElementById('createMonitorForm');
        const data = {
            name: document.getElementById('monitorName').value,
            tearsheet_name: document.getElementById('tearsheetName').value,
            tearsheet_id: parseInt(document.getElementById('tearsheetId').value) || 0,
            interval_minutes: parseInt(document.getElementById('intervalMinutes').value)
        };

        fetch('/api/monitors', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    bootstrap.Modal.getInstance(document.getElementById('createMonitorModal')).hide();
                    form.reset();
                    loadMonitors();
                    loadSystemStatus();
                } else {
                    alert('Error: ' + result.error);
                }
            })
            .catch(error => alert('Error creating monitor'));
    }

    function toggleMonitor(monitorId) {
        fetch(`/api/monitors/${monitorId}/toggle`, { method: 'POST' })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    loadMonitors();
                    loadSystemStatus();
                } else {
                    alert('Error: ' + result.error);
                }
            })
            .catch(error => alert('Error toggling monitor'));
    }

    function deleteMonitor(monitorId) {
        if (confirm('Are you sure you want to delete this monitor?')) {
            fetch(`/api/monitors/${monitorId}`, { method: 'DELETE' })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        loadMonitors();
                        loadSystemStatus();
                    } else {
                        alert('Error: ' + result.error);
                    }
                })
                .catch(error => alert('Error deleting monitor'));
        }
    }
</script>
{% endblock %}