{% extends "base_layout.html" %}

{% block title %}Global Settings - Scout Genius™{% endblock %}

{% block extra_head %}
<style>
    .settings-card {
        background: linear-gradient(145deg, rgba(22, 42, 31, 0.9), rgba(10, 22, 16, 0.95));
        border: 1px solid rgba(74, 150, 120, 0.15);
        backdrop-filter: blur(20px);
        border-radius: 16px;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        position: relative;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    }

    .settings-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, #4a9678, #4a9678);
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .settings-card:hover::before {
        opacity: 1;
    }

    .settings-card:hover {
        background: linear-gradient(145deg, rgba(30, 58, 42, 0.95), rgba(15, 35, 25, 0.98));
        border-color: rgba(74, 150, 120, 0.35);
        transform: translateY(-4px);
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.25), 0 0 25px rgba(74, 150, 120, 0.1);
    }

    .settings-card.no-hover:hover {
        background: linear-gradient(145deg, rgba(22, 42, 31, 0.9), rgba(10, 22, 16, 0.95));
        border-color: rgba(74, 150, 120, 0.15);
        transform: none;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    }

    .settings-card.no-hover::before {
        display: none;
    }

    .form-check-input {
        background-color: rgba(22, 42, 31, 0.8) !important;
        border: 2px solid rgba(74, 150, 120, 0.4) !important;
        opacity: 1 !important;
    }

    .form-check-input:checked {
        background-color: #4a9678 !important;
        border-color: #4a9678 !important;
    }

    .form-check-input:focus {
        border-color: #4a9678 !important;
        box-shadow: 0 0 0 3px rgba(74, 150, 120, 0.2) !important;
    }

    .form-check-input:not(:checked) {
        background-color: rgba(22, 42, 31, 0.8) !important;
        border-color: rgba(74, 150, 120, 0.3) !important;
    }

    @media (max-width: 768px) {
        .settings-card {
            margin-bottom: 1rem;
        }

        .card-body {
            padding: 1rem;
        }

        .btn {
            font-size: 0.875rem;
            padding: 0.5rem 0.75rem;
        }
    }

    @media (max-width: 576px) {
        .btn {
            font-size: 0.8rem;
            padding: 0.4rem 0.6rem;
            width: 100%;
            margin-bottom: 0.5rem;
        }

        .row .col-md-6 {
            margin-bottom: 1rem;
        }
    }
</style>
{% endblock %}

{% block page_title %}Global Settings{% endblock %}
{% block page_subtitle %}Configure SFTP upload and email notification settings{% endblock %}

{% block content %}
<!-- Flash Messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
{% for category, message in messages %}
<div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
    {{ message }}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endfor %}
{% endif %}
{% endwith %}

<!-- Settings Form -->
<form method="POST" action="{{ url_for('settings.update_settings') }}">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <!-- SFTP Settings -->
    <div class="card glass-card mb-4">
        <div class="card-header bg-transparent border-bottom border-secondary">
            <h5 class="card-title mb-0">
                <i class="fas fa-server me-2"></i>
                SFTP Upload Settings
            </h5>
        </div>
        <div class="card-body">
            <div class="row mb-3">
                <div class="col-md-6">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="sftp_enabled" name="sftp_enabled" {% if
                            settings.sftp_enabled=='true' %}checked{% endif %}>
                        <label class="form-check-label" for="sftp_enabled">
                            <strong>Enable SFTP Connection</strong>
                        </label>
                    </div>
                    <small class="text-muted">
                        When enabled, SFTP connection will be available for uploads
                    </small>
                </div>
                <div class="col-md-6">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="automated_uploads_enabled"
                            name="automated_uploads_enabled" {% if settings.automated_uploads_enabled=='true'
                            %}checked{% endif %}>
                        <label class="form-check-label" for="automated_uploads_enabled">
                            <strong>Enable Automated Uploads (Every 30 Minutes)</strong>
                        </label>
                    </div>
                    <small class="text-muted">
                        Automatically upload XML files every 30 minutes. Disable for manual workflow only.
                    </small>
                </div>
            </div>

            <!-- Automation Status Display -->
            <div id="automation-status-section" class="row mb-3" style="display: none;">
                <div class="col-12">
                    <div class="card border-info">
                        <div class="card-header bg-info text-white">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-clock me-2"></i>
                                Automated Upload Status
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <strong>Status:</strong>
                                    <span id="automation-status" class="badge bg-secondary">Loading...</span>
                                </div>
                                <div class="col-md-4">
                                    <strong>Next Upload:</strong>
                                    <div id="next-upload-time" class="text-muted">Loading...</div>
                                    <small id="countdown-timer" class="text-info"></small>
                                </div>
                                <div class="col-md-3">
                                    <strong>Frequency:</strong>
                                    <div id="upload-interval" class="text-muted">Every 30 minutes</div>
                                </div>
                                <div class="col-md-2">
                                    <strong>Last Upload:</strong>
                                    <div id="last-upload-time" class="text-muted">Loading...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="sftp_hostname" class="form-label">SFTP Hostname</label>
                    <input type="text" class="form-control" id="sftp_hostname" name="sftp_hostname"
                        value="{{ settings.sftp_hostname }}" placeholder="yourdomain.wpengine.com">
                    <small class="text-muted">Your SFTP server hostname (e.g., WP Engine domain)</small>
                </div>
                <div class="col-md-6">
                    <label for="sftp_port" class="form-label">SFTP Port</label>
                    <input type="number" class="form-control" id="sftp_port" name="sftp_port"
                        value="{{ settings.sftp_port or '2222' }}" placeholder="2222">
                    <small class="text-muted">Usually 2222 for WP Engine, 22 for standard SFTP</small>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="sftp_username" class="form-label">SFTP Username</label>
                    <input type="text" class="form-control" id="sftp_username" name="sftp_username"
                        value="{{ settings.sftp_username }}" placeholder="your-username">
                </div>
                <div class="col-md-6">
                    <label for="sftp_password" class="form-label">SFTP Password</label>
                    <input type="password" class="form-control" id="sftp_password" name="sftp_password"
                        placeholder="{% if settings.sftp_password %}••••••••{% else %}Enter password{% endif %}">
                    <small class="text-muted">Leave blank to keep current password</small>
                </div>
            </div>

            <div class="mb-3">
                <label for="sftp_directory" class="form-label">Upload Directory</label>
                <input type="text" class="form-control" id="sftp_directory" name="sftp_directory"
                    value="{{ settings.sftp_directory or '/' }}" placeholder="/">
                <small class="text-muted">Target directory on your server (e.g., /wp-content/uploads/)</small>
            </div>
        </div>
    </div>

    <!-- Test Connection Section -->
    <div class="card glass-card mb-4">
        <div class="card-header bg-transparent border-bottom border-secondary">
            <h5 class="card-title mb-0">
                <i class="fas fa-check-circle me-2"></i>
                Test SFTP Connection
            </h5>
        </div>
        <div class="card-body text-center">
            <p class="text-muted mb-3">
                Test your SFTP connection to ensure settings are correct before saving
            </p>
            <button type="button" class="btn btn-outline-info" onclick="testSftpConnection()">
                <i class="fas fa-plug me-2"></i>
                Test SFTP Connection
            </button>
            <div id="testResult" class="mt-3"></div>
        </div>
    </div>

    <!-- Email Settings -->
    <div class="card glass-card mb-4">
        <div class="card-header bg-transparent border-bottom border-secondary">
            <h5 class="card-title mb-0">
                <i class="fas fa-envelope me-2"></i>
                Email Notification Settings (for automation use only)
            </h5>
        </div>
        <div class="card-body">
            <div class="row mb-3">
                <div class="col-md-6">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="email_notifications_enabled"
                            name="email_notifications_enabled" {% if settings.email_notifications_enabled=='true'
                            %}checked{% endif %}>
                        <label class="form-check-label" for="email_notifications_enabled">
                            <strong>Enable Email Notifications</strong>
                        </label>
                    </div>
                    <small class="text-muted">
                        Send email notifications when processing completes
                    </small>
                </div>
            </div>

            <div class="mb-3">
                <label for="default_notification_email" class="form-label">Default Notification Email</label>
                <input type="email" class="form-control" id="default_notification_email"
                    name="default_notification_email" value="{{ settings.default_notification_email }}"
                    placeholder="your-email@example.com">
                <small class="text-muted">Default email address for notifications (can be overridden per
                    schedule)</small>
            </div>
        </div>
    </div>

    <!-- Save Button -->
    <div class="d-grid gap-2">
        <button type="submit" class="btn btn-primary btn-lg">
            <i class="fas fa-save me-2"></i>
            Save Settings
        </button>
    </div>
</form>

<!-- Usage Information -->
<div class="card glass-card mt-4">
    <div class="card-body">
        <h5 class="card-title">
            <i class="fas fa-info-circle me-2"></i>
            How These Settings Work
        </h5>
        <ul class="mb-0">
            <li><strong>SFTP Upload:</strong> When enabled, all processed XML files (both manual and scheduled) will
                automatically upload to your server</li>
            <li><strong>Email Notifications:</strong> Receive email notifications when scheduled processing completes
                with the processed file attached</li>
            <li><strong>Shared Credentials:</strong> These settings apply to both manual uploads and automated
                scheduling</li>
            <li><strong>Security:</strong> Passwords are stored securely and only updated when you enter a new value
            </li>
        </ul>
    </div>
</div>

<!-- Support Directory Section -->
<div id="support-directory" class="mt-5">
    <h4 class="mb-1"><i class="fas fa-address-book me-2"></i>Support Form Directory</h4>
    <p class="text-muted mb-2">These are the people who can submit support requests via the internal support form at <code>support.myticas.com</code>. This registry is separate from Scout Genius platform users below — support contacts do not have login access to this application.</p>
    <div class="alert alert-secondary mb-3 py-2 px-3" style="font-size: 0.85rem; background: rgba(74,150,120,0.08); border-color: rgba(74,150,120,0.2); color: rgba(255,255,255,0.7);">
        <i class="fas fa-info-circle me-2"></i>
        <strong>How it works:</strong> When someone visits the support form and types their name, they are matched against this directory. Their email and department auto-populate based on their profile here. Department is used for smart email routing.
    </div>

    <div class="settings-card no-hover p-4">
        <div class="d-flex align-items-center justify-content-between mb-3">
            <h5 class="mb-0"><i class="fas fa-users me-2"></i>Myticas Support Directory ({{ support_contacts|length }})</h5>
            <div class="d-flex gap-2 align-items-center">
                <span class="badge" style="background: rgba(74,150,120,0.2); color: #4a9678; font-size: 0.78rem; padding: 5px 10px;">{{ support_contacts|selectattr('is_active')|list|length }} Active</span>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-sm mb-0" style="color: rgba(255,255,255,0.85); font-size: 0.875rem;">
                <thead>
                    <tr style="border-color: rgba(74,150,120,0.2);">
                        <th style="color: #4a9678; font-weight: 600; padding: 10px 12px;">Name</th>
                        <th style="color: #4a9678; font-weight: 600; padding: 10px 12px;">Email</th>
                        <th style="color: #4a9678; font-weight: 600; padding: 10px 12px;">Department</th>
                        <th style="color: #4a9678; font-weight: 600; padding: 10px 12px; text-align: center;">Status</th>
                        <th style="color: #4a9678; font-weight: 600; padding: 10px 12px;">Scout Genius Role</th>
                    </tr>
                </thead>
                <tbody>
                    {% set platform_emails = users | map(attribute='email') | list %}
                    {% for contact in support_contacts %}
                    <tr style="border-color: rgba(74,150,120,0.1);">
                        <td style="padding: 9px 12px; vertical-align: middle;">
                            <div class="d-flex align-items-center gap-2">
                                <div class="rounded-circle d-flex align-items-center justify-content-center" 
                                     style="width: 30px; height: 30px; background: rgba(74,150,120,0.2); font-size: 0.75rem; font-weight: 600; flex-shrink: 0;">
                                    {{ contact.first_name[0] }}{{ contact.last_name[0] }}
                                </div>
                                <span>{{ contact.full_name }}</span>
                            </div>
                        </td>
                        <td style="padding: 9px 12px; vertical-align: middle; color: rgba(255,255,255,0.6);">{{ contact.email }}</td>
                        <td style="padding: 9px 12px; vertical-align: middle;">
                            {% if contact.department %}
                            <span class="badge" style="background: rgba(42,82,152,0.3); color: #4FC3F7; font-weight: 500;">{{ contact.department }}</span>
                            {% else %}
                            <span style="color: rgba(255,255,255,0.3); font-style: italic; font-size: 0.8rem;">Not set</span>
                            {% endif %}
                        </td>
                        <td style="padding: 9px 12px; vertical-align: middle; text-align: center;">
                            {% if contact.is_active %}
                            <span class="badge bg-success" style="font-size: 0.72rem;">Active</span>
                            {% else %}
                            <span class="badge bg-secondary" style="font-size: 0.72rem;">Inactive</span>
                            {% endif %}
                        </td>
                        <td style="padding: 9px 12px; vertical-align: middle;">
                            {% if contact.email in platform_emails %}
                            {% set platform_user = users | selectattr('email', 'equalto', contact.email) | first %}
                            <div class="d-flex gap-1 flex-wrap">
                                {% if platform_user.is_admin %}
                                <span class="badge" style="background: rgba(74,150,120,0.25); color: #4a9678; font-size: 0.7rem;">Admin</span>
                                {% endif %}
                                {% for mod in platform_user.get_modules() %}
                                <span class="badge" style="background: rgba(255,255,255,0.08); color: rgba(255,255,255,0.6); font-size: 0.7rem;">
                                    {% if mod == 'scout_inbound' %}Scout Inbound{% elif mod == 'scout_screening' %}Scout Screening{% elif mod == 'scout_vetting' %}Scout Vetting{% else %}{{ mod }}{% endif %}
                                </span>
                                {% endfor %}
                            </div>
                            {% else %}
                            <span style="color: rgba(255,255,255,0.3); font-size: 0.8rem; font-style: italic;">Support form only</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- User Management Section -->
<div id="user-management" class="mt-5">
    <h4 class="mb-3"><i class="fas fa-users-cog me-2"></i>User Management</h4>
    <p class="text-muted mb-4">Create and manage user accounts. Control which modules each user can access.</p>
    
    <!-- Create New User -->
    <div class="settings-card p-4 mb-4">
        <h5 class="mb-3"><i class="fas fa-user-plus me-2 text-success"></i>Create New User</h5>
        <form action="{{ url_for('settings.create_user') }}" method="POST">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">Username <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" name="username" required placeholder="e.g. john.doe">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Email <span class="text-danger">*</span></label>
                    <input type="email" class="form-control" name="email" required placeholder="john@company.com">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Password <span class="text-danger">*</span></label>
                    <input type="password" class="form-control" name="password" required placeholder="Minimum 8 characters">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Display Name</label>
                    <input type="text" class="form-control" name="display_name" placeholder="John Doe (for Bullhorn matching)">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Bullhorn User ID</label>
                    <input type="number" class="form-control" name="bullhorn_user_id" placeholder="e.g. 12345">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Admin</label>
                    <div class="form-check form-switch mt-2">
                        <input class="form-check-input" type="checkbox" name="is_admin" id="new_user_admin">
                        <label class="form-check-label" for="new_user_admin">Full admin access</label>
                    </div>
                </div>
                <div class="col-12">
                    <label class="form-label">Module Subscriptions</label>
                    <div class="d-flex gap-4 flex-wrap">
                        {% for mod in available_modules %}
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="modules" value="{{ mod }}" id="new_{{ mod }}">
                            <label class="form-check-label" for="new_{{ mod }}">
                                {% if mod == 'scout_inbound' %}
                                <i class="fas fa-satellite-dish text-warning me-1"></i> Scout Inbound
                                {% elif mod == 'scout_screening' %}
                                <i class="fas fa-brain text-info me-1"></i> Scout Screening
                                {% elif mod == 'scout_vetting' %}
                                <i class="fas fa-comments me-1" style="color: #7cc5c5;"></i> Scout Vetting
                                {% else %}
                                {{ mod }}
                                {% endif %}
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="col-12">
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-plus me-1"></i> Create User
                    </button>
                </div>
            </div>
        </form>
    </div>
    
    <!-- Existing Users -->
    <div class="settings-card no-hover p-4">
        <h5 class="mb-3"><i class="fas fa-users me-2"></i>Existing Users ({{ users|length }})</h5>
        {% for user in users %}
        <div class="border rounded p-3 mb-3" style="border-color: rgba(74, 150, 120, 0.2) !important; background: rgba(10, 22, 16, 0.5);">
            <form action="{{ url_for('settings.update_user', user_id=user.id) }}" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="row g-2 align-items-center">
                    <div class="col-md-2">
                        <div class="d-flex align-items-center gap-2">
                            <div class="rounded-circle d-flex align-items-center justify-content-center" 
                                 style="width: 36px; height: 36px; background: {% if user.is_admin %}rgba(74, 150, 120, 0.3){% else %}rgba(200, 160, 60, 0.3){% endif %}; font-weight: 600; font-size: 0.85rem;">
                                {{ user.username[0]|upper }}
                            </div>
                            <div>
                                <strong>{{ user.username }}</strong>
                                <div class="small text-muted">{{ user.email }}</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <input type="text" class="form-control form-control-sm" name="display_name" 
                               value="{{ user.display_name or '' }}" placeholder="Display name">
                    </div>
                    <div class="col-md-1">
                        <input type="number" class="form-control form-control-sm" name="bullhorn_user_id" 
                               value="{{ user.bullhorn_user_id or '' }}" placeholder="BH ID">
                    </div>
                    <div class="col-md-2">
                        <input type="password" class="form-control form-control-sm" name="password" placeholder="New password (optional)">
                    </div>
                    <div class="col-md-1">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" name="is_admin" 
                                   id="admin_{{ user.id }}" {% if user.is_admin %}checked{% endif %}>
                            <label class="form-check-label small" for="admin_{{ user.id }}">Admin</label>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="d-flex gap-2 flex-wrap">
                            {% for mod in available_modules %}
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" name="modules" value="{{ mod }}" 
                                       id="mod_{{ user.id }}_{{ mod }}"
                                       {% if mod in user.get_modules() and not user.is_admin %}checked{% endif %}
                                       {% if user.is_admin %}checked disabled{% endif %}>
                                <label class="form-check-label small" for="mod_{{ user.id }}_{{ mod }}">
                                    {% if mod == 'scout_inbound' %}Inbound{% elif mod == 'scout_screening' %}Screening{% elif mod == 'scout_vetting' %}Vetting{% else %}{{ mod }}{% endif %}
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="col-md-1 text-end">
                        <div class="btn-group btn-group-sm">
                            <button type="submit" class="btn btn-outline-primary btn-sm" title="Save changes">
                                <i class="fas fa-save"></i>
                            </button>
                        </div>
                    </div>
                </div>
                {% if user.last_login %}
                <div class="small text-muted mt-1" style="padding-left: 48px;">
                    Last login: {{ user.last_login.strftime('%b %d, %Y %H:%M') }}
                </div>
                {% endif %}
            </form>
            <div class="mt-1" style="padding-left: 48px; display: flex; gap: 8px; flex-wrap: wrap;">
                {% if user.id != current_user.id %}
                <form action="{{ url_for('settings.impersonate_user', user_id=user.id) }}" method="POST" class="d-inline">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-outline-warning btn-sm" title="View the app as this user">
                        <i class="fas fa-user-secret me-1"></i> View As
                    </button>
                </form>
                {% endif %}
                {% if not user.is_admin or users|selectattr('is_admin')|list|length > 1 %}
                <form action="{{ url_for('settings.delete_user', user_id=user.id) }}" method="POST" class="d-inline"
                      onsubmit="return confirm('Are you sure you want to delete user {{ user.username }}? This cannot be undone.');">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-outline-danger btn-sm">
                        <i class="fas fa-trash me-1"></i> Delete
                    </button>
                </form>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    function testSftpConnection() {
        const button = event.target;
        const resultDiv = document.getElementById('testResult');

        const formData = {
            sftp_hostname: document.getElementById('sftp_hostname').value,
            sftp_username: document.getElementById('sftp_username').value,
            sftp_password: document.getElementById('sftp_password').value,
            sftp_directory: document.getElementById('sftp_directory').value,
            sftp_port: document.getElementById('sftp_port').value
        };

        if (!formData.sftp_hostname || !formData.sftp_username || !formData.sftp_password) {
            resultDiv.innerHTML = '<div class="alert alert-warning"><i class="fas fa-exclamation-triangle me-2"></i>Please fill in hostname, username, and password before testing</div>';
            return;
        }

        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Testing...';
        resultDiv.innerHTML = '';

        fetch('/test-sftp-connection', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    resultDiv.innerHTML = '<div class="alert alert-success"><i class="fas fa-check me-2"></i>' + data.message + '</div>';
                } else {
                    resultDiv.innerHTML = '<div class="alert alert-danger"><i class="fas fa-times me-2"></i>' + data.error + '</div>';
                }
            })
            .catch(error => {
                resultDiv.innerHTML = '<div class="alert alert-danger"><i class="fas fa-times me-2"></i>Failed to test connection</div>';
            })
            .finally(() => {
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-plug me-2"></i>Test SFTP Connection';
            });
    }

    // Automation Status Management
    let countdownInterval = null;

    function formatCountdown(timestamp, isoDate, humanDate) {
        const now = new Date();
        let target;

        if (timestamp && typeof timestamp === 'number') {
            target = new Date(timestamp);
        } else if (isoDate) {
            target = new Date(isoDate);
        } else if (humanDate) {
            target = new Date(humanDate.replace(' UTC', 'Z').replace(' ', 'T'));
        } else {
            return "Invalid date format";
        }

        if (isNaN(target.getTime())) {
            return "Date parsing error";
        }

        const diff = target - now;

        if (diff <= 0) {
            return "Upload should start soon...";
        }

        const minutes = Math.floor(diff / (1000 * 60));
        const seconds = Math.floor((diff % (1000 * 60)) / 1000);

        if (minutes > 0) {
            return `in ${minutes}m ${seconds}s`;
        } else {
            return `in ${seconds}s`;
        }
    }

    function updateAutomationStatus() {
        fetch('/automation-status')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Error getting automation status:', data.error);
                    return;
                }

                const statusElement = document.getElementById('automation-status');
                const statusSection = document.getElementById('automation-status-section');

                if (data.automation_enabled) {
                    statusElement.className = 'badge bg-success';
                    statusElement.textContent = data.status;
                    statusSection.style.display = 'block';

                    document.getElementById('next-upload-time').textContent = data.next_upload_time || 'Not scheduled';
                    document.getElementById('last-upload-time').textContent = data.last_upload_time || 'Not available yet';
                    document.getElementById('upload-interval').textContent = data.upload_interval;

                    if (data.next_upload_timestamp || data.next_upload_iso || data.next_upload_time) {
                        if (countdownInterval) {
                            clearInterval(countdownInterval);
                        }

                        const updateCountdown = () => {
                            const countdown = formatCountdown(
                                data.next_upload_timestamp,
                                data.next_upload_iso,
                                data.next_upload_time
                            );
                            document.getElementById('countdown-timer').textContent = countdown;
                        };

                        updateCountdown();
                        countdownInterval = setInterval(updateCountdown, 1000);
                    } else {
                        document.getElementById('countdown-timer').textContent = '';
                    }
                } else {
                    statusElement.className = 'badge bg-secondary';
                    statusElement.textContent = 'Disabled';
                    statusSection.style.display = 'none';

                    if (countdownInterval) {
                        clearInterval(countdownInterval);
                        countdownInterval = null;
                    }
                }
            })
            .catch(error => {
                console.error('Error fetching automation status:', error);
            });
    }

    document.getElementById('automated_uploads_enabled').addEventListener('change', function () {
        setTimeout(updateAutomationStatus, 1000);
    });

    document.addEventListener('DOMContentLoaded', function () {
        updateAutomationStatus();
        setInterval(updateAutomationStatus, 30000);
    });
</script>
{% endblock %}