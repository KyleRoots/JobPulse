{% extends "base_layout.html" %}
{% block body_attrs %}data-module="screening"{% endblock %}

{% block title %}Scout Screening Portal{% endblock %}

{% block extra_head %}
<style>
    :root {
        --sc-accent:        #9b7fd4;
        --sc-accent-dim:    rgba(155, 127, 212, 0.15);
        --sc-accent-border: rgba(155, 127, 212, 0.25);
        --sc-accent-hover:  rgba(155, 127, 212, 0.35);
        --sc-bg-card:       rgba(22, 14, 38, 0.65);
    }

    /* ── Metric cards (purple overrides for base metric-card) ── */
    .metrics-row .metric-card {
        background: linear-gradient(145deg, #1e1230 0%, #120b22 50%, #0e0819 100%);
        border-color: var(--sc-accent-border);
    }
    .metrics-row .metric-card::before {
        background: linear-gradient(135deg, var(--sc-accent-dim) 0%, transparent 50%);
    }
    .metrics-row .metric-card:hover {
        border-color: rgba(155, 127, 212, 0.5);
        box-shadow: 0 10px 30px rgba(155, 127, 212, 0.15);
    }
    .metrics-row .metric-card.metric-filter {
        cursor: pointer;
        transition: all 0.25s ease, outline 0.15s ease;
    }
    .metrics-row .metric-card.metric-filter.active {
        outline: 2px solid var(--sc-accent);
        outline-offset: 2px;
        box-shadow: 0 8px 28px rgba(155, 127, 212, 0.25);
    }
    .metrics-row .metric-value { color: var(--sc-accent); }
    .metrics-row .metric-icon  { color: var(--sc-accent); }

    /* ── Section layout ── */
    .section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1.25rem;
    }
    .section-header h5 { margin: 0; font-weight: 600; color: rgba(255,255,255,0.9); }
    .section-subtitle  { font-size: 0.8rem; color: rgba(255,255,255,0.45); margin-top: 0.25rem; }
    .section-divider   { border-top: 1px solid rgba(255,255,255,0.07); margin: 2.5rem 0; }

    /* ── Candidate table ── */
    .glass-card {
        background: var(--sc-bg-card);
        border: 1px solid var(--sc-accent-border);
        border-radius: 14px;
        overflow: hidden;
    }
    .screening-table { width: 100%; margin: 0; }
    .screening-table thead th {
        font-size: 0.72rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: rgba(255,255,255,0.45);
        border-bottom: 1px solid rgba(255,255,255,0.08);
        padding: 0.75rem 1rem;
        background: rgba(0,0,0,0.15);
        white-space: nowrap;
    }
    .screening-table tbody td {
        font-size: 0.85rem;
        vertical-align: middle;
        padding: 0.8rem 1rem;
        border-bottom: 1px solid rgba(255,255,255,0.04);
        color: rgba(255,255,255,0.8);
    }
    .screening-table tbody tr:last-child td { border-bottom: none; }
    .screening-table tbody tr:hover td { background: rgba(155,127,212,0.04); }

    /* ── Score badges ── */
    .score-badge {
        display: inline-block;
        padding: 0.25rem 0.65rem;
        border-radius: 6px;
        font-weight: 700;
        font-size: 0.82rem;
        min-width: 52px;
        text-align: center;
    }
    .score-high  { background: rgba(40,167,69,0.15);   color: #7ec98e; border: 1px solid rgba(40,167,69,0.25); }
    .score-mid   { background: rgba(255,193,7,0.15);   color: #ffd966; border: 1px solid rgba(255,193,7,0.25); }
    .score-low   { background: rgba(220,53,69,0.15);   color: #e87c7c; border: 1px solid rgba(220,53,69,0.25); }
    .score-zero  { background: rgba(108,117,125,0.15); color: #9da5ad; border: 1px solid rgba(108,117,125,0.2); }

    /* ── Status badges ── */
    .status-qualified { background: rgba(40,167,69,0.12);  color: #7ec98e; border: 1px solid rgba(40,167,69,0.2);  font-size: 0.72rem; }
    .status-not-rec   { background: rgba(220,53,69,0.12);  color: #e87c7c; border: 1px solid rgba(220,53,69,0.2);  font-size: 0.72rem; }
    .status-pending   { background: rgba(255,193,7,0.12);  color: #ffd966; border: 1px solid rgba(255,193,7,0.2);  font-size: 0.72rem; }

    /* ── Links ── */
    .candidate-link { color: var(--sc-accent); text-decoration: none; font-weight: 500; }
    .candidate-link:hover { color: #b899e8; text-decoration: underline; }
    .job-link { color: rgba(255,255,255,0.65); text-decoration: none; font-size: 0.82rem; }
    .job-link:hover { color: rgba(255,255,255,0.95); text-decoration: underline; }
    .ext-icon { font-size: 0.6rem; opacity: 0.45; margin-left: 3px; }

    /* ── Notes cell ── */
    .notes-cell {
        max-width: 260px;
        font-size: 0.8rem;
        color: rgba(255,255,255,0.5);
        line-height: 1.45;
    }
    .notes-truncated { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

    /* ── Pagination ── */
    .pagination-bar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.75rem 1rem;
        border-top: 1px solid rgba(255,255,255,0.06);
        background: rgba(0,0,0,0.1);
        font-size: 0.82rem;
        color: rgba(255,255,255,0.45);
    }
    .pagination-controls { display: flex; gap: 0.35rem; align-items: center; }
    .page-btn {
        background: rgba(155,127,212,0.1);
        border: 1px solid var(--sc-accent-border);
        color: var(--sc-accent);
        border-radius: 6px;
        padding: 0.3rem 0.65rem;
        font-size: 0.78rem;
        cursor: pointer;
        transition: all 0.2s;
    }
    .page-btn:hover  { background: var(--sc-accent-dim); }
    .page-btn:disabled { opacity: 0.35; cursor: default; }
    .page-btn.current { background: var(--sc-accent); color: #fff; border-color: var(--sc-accent); }

    /* ── Empty / filter states ── */
    .empty-state {
        text-align: center;
        padding: 3.5rem 1rem;
        color: rgba(255,255,255,0.35);
    }
    .empty-state i { font-size: 2.5rem; margin-bottom: 1rem; opacity: 0.22; display: block; }
    #active-filter-label { font-size: 0.8rem; color: var(--sc-accent); }

    /* ── Job settings table ── */
    .settings-table { width: 100%; border-collapse: collapse; }
    .settings-table thead th {
        font-size: 0.72rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: rgba(255,255,255,0.4);
        border-bottom: 1px solid rgba(255,255,255,0.08);
        padding: 0.75rem 1rem;
        background: rgba(0,0,0,0.15);
        white-space: nowrap;
    }
    .settings-table tbody td {
        padding: 0.9rem 1rem;
        border-bottom: 1px solid rgba(255,255,255,0.05);
        vertical-align: middle;
        font-size: 0.85rem;
        color: rgba(255,255,255,0.8);
    }
    .settings-table tbody tr:last-child td { border-bottom: none; }
    .settings-table tbody tr:hover td { background: rgba(155,127,212,0.03); }
    .job-title-cell { font-weight: 600; color: rgba(255,255,255,0.88); }
    .job-id-badge {
        display: inline-block;
        font-size: 0.7rem;
        font-weight: 400;
        color: rgba(255,255,255,0.35);
        margin-left: 0.4rem;
    }
    .ai-req-snippet {
        font-size: 0.78rem;
        color: rgba(255,255,255,0.5);
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        max-width: 220px;
        line-height: 1.45;
    }
    .ai-req-snippet.empty-req { font-style: italic; color: rgba(255,255,255,0.25); }
    .threshold-input {
        background: rgba(0,0,0,0.3);
        border: 1px solid var(--sc-accent-border);
        border-radius: 7px;
        color: rgba(255,255,255,0.85);
        font-size: 0.85rem;
        padding: 0.35rem 0.6rem;
        width: 75px;
        text-align: center;
        transition: border-color 0.2s;
    }
    .threshold-input:focus { outline: none; border-color: var(--sc-accent); }
    .btn-configure {
        background: var(--sc-accent-dim);
        border: 1px solid var(--sc-accent-border);
        color: var(--sc-accent);
        border-radius: 7px;
        padding: 0.35rem 0.85rem;
        font-size: 0.8rem;
        font-weight: 500;
        cursor: pointer;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        transition: all 0.2s;
        white-space: nowrap;
    }
    .btn-configure:hover { background: var(--sc-accent-hover); color: #c4aef0; }
    .btn-save {
        background: rgba(155,127,212,0.18);
        border: 1px solid var(--sc-accent-border);
        color: var(--sc-accent);
        border-radius: 7px;
        padding: 0.35rem 0.85rem;
        font-size: 0.8rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
    }
    .btn-save:hover { background: var(--sc-accent-hover); color: #c4aef0; }

    /* ── Override modal ── */
    .modal-content {
        background: #0f0a1c;
        border: 1px solid var(--sc-accent-border);
        border-radius: 14px;
        color: rgba(255,255,255,0.88);
    }
    .modal-header {
        border-bottom: 1px solid rgba(255,255,255,0.08);
        padding: 1.1rem 1.4rem 0.9rem;
    }
    .modal-title { font-size: 1rem; font-weight: 600; color: rgba(255,255,255,0.92); }
    .modal-footer { border-top: 1px solid rgba(255,255,255,0.08); padding: 0.85rem 1.4rem; }
    .modal-body { padding: 1.25rem 1.4rem; }
    .btn-close-modal {
        background: transparent;
        border: none;
        color: rgba(255,255,255,0.5);
        font-size: 1.2rem;
        cursor: pointer;
        padding: 0;
        line-height: 1;
    }
    .btn-close-modal:hover { color: rgba(255,255,255,0.9); }
    .col-label {
        font-size: 0.72rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--sc-accent);
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.35rem;
    }
    .ai-req-box {
        background: rgba(0,0,0,0.25);
        border: 1px solid rgba(255,255,255,0.06);
        border-radius: 8px;
        padding: 0.85rem 1rem;
        font-size: 0.82rem;
        color: rgba(255,255,255,0.6);
        min-height: 160px;
        max-height: 240px;
        overflow-y: auto;
        line-height: 1.65;
        white-space: pre-wrap;
    }
    .ai-req-box.empty { color: rgba(255,255,255,0.25); font-style: italic; }
    .override-textarea {
        background: rgba(0,0,0,0.3);
        border: 1px solid var(--sc-accent-border);
        border-radius: 8px;
        color: rgba(255,255,255,0.85);
        font-size: 0.82rem;
        resize: vertical;
        min-height: 160px;
        max-height: 240px;
        width: 100%;
        padding: 0.75rem 0.9rem;
        line-height: 1.65;
        transition: border-color 0.2s;
    }
    .override-textarea:focus { outline: none; border-color: var(--sc-accent); background: rgba(0,0,0,0.35); }
    .override-textarea::placeholder { color: rgba(255,255,255,0.2); }
    .override-hint { font-size: 0.74rem; color: rgba(255,255,255,0.3); margin-top: 0.4rem; }
    .threshold-modal-input {
        background: rgba(0,0,0,0.3);
        border: 1px solid var(--sc-accent-border);
        border-radius: 7px;
        color: rgba(255,255,255,0.85);
        font-size: 0.85rem;
        padding: 0.4rem 0.7rem;
        width: 90px;
        transition: border-color 0.2s;
    }
    .threshold-modal-input:focus { outline: none; border-color: var(--sc-accent); }
    .btn-modal-save {
        background: var(--sc-accent);
        border: none;
        color: #fff;
        border-radius: 8px;
        padding: 0.5rem 1.4rem;
        font-size: 0.88rem;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s;
    }
    .btn-modal-save:hover { background: #b899e8; }
    .active-override-badge {
        display: inline-block;
        font-size: 0.65rem;
        padding: 0.15rem 0.45rem;
        background: rgba(155,127,212,0.15);
        color: var(--sc-accent);
        border: 1px solid var(--sc-accent-border);
        border-radius: 4px;
        margin-left: 0.35rem;
        vertical-align: middle;
    }
</style>
{% endblock %}

{% block page_title %}Scout Screening Portal{% endblock %}
{% block page_subtitle %}AI-screened candidates for your open positions{% endblock %}

{% block page_actions %}
<button class="btn btn-outline-light btn-sm" onclick="location.reload()">
    <i class="fas fa-sync-alt me-1"></i>Refresh
</button>
{% endblock %}

{% block content %}

<!-- ===== METRIC CARDS ===== -->
<div class="metrics-row mb-4">
    <div class="metric-card metric-filter" id="card-qualified" onclick="filterMatches('qualified')" title="Filter: Qualified Matches">
        <div class="metric-icon"><i class="fas fa-check-circle"></i></div>
        <div class="metric-label">Qualified Matches</div>
        <div class="metric-value">{{ metrics.qualified }}</div>
        <div class="metric-subtext">Above threshold</div>
        <div class="metric-trend neutral"><i class="fas fa-star"></i> Approved</div>
    </div>
    <div class="metric-card metric-filter" id="card-pending" onclick="filterMatches('pending')" title="Filter: Pending Review">
        <div class="metric-icon"><i class="fas fa-clock"></i></div>
        <div class="metric-label">Pending Review</div>
        <div class="metric-value">{{ metrics.pending }}</div>
        <div class="metric-subtext">Awaiting AI analysis</div>
        <div class="metric-trend neutral"><i class="fas fa-hourglass-half"></i> In Queue</div>
    </div>
    <div class="metric-card metric-filter" id="card-not-rec" onclick="filterMatches('not_recommended')" title="Filter: Not Recommended">
        <div class="metric-icon"><i class="fas fa-times-circle"></i></div>
        <div class="metric-label">Not Recommended</div>
        <div class="metric-value">{{ metrics.not_recommended }}</div>
        <div class="metric-subtext">Below threshold</div>
        <div class="metric-trend neutral"><i class="fas fa-filter"></i> Filtered</div>
    </div>
    <div class="metric-card metric-filter" id="card-week" onclick="filterMatches('week')" title="Filter: Screened This Week">
        <div class="metric-icon"><i class="fas fa-calendar-week"></i></div>
        <div class="metric-label">Screened This Week</div>
        <div class="metric-value">{{ metrics.screened_this_week }}</div>
        <div class="metric-subtext">Last 7 days</div>
        <div class="metric-trend neutral"><i class="fas fa-chart-line"></i> Recent</div>
    </div>
</div>

<!-- ===== SCREENED CANDIDATES TABLE ===== -->
<div class="section-header">
    <div>
        <h5><i class="fas fa-users me-2" style="color: var(--sc-accent);"></i>Screened Candidates</h5>
        <div class="section-subtitle">AI match results for candidates on your active jobs</div>
    </div>
    <div id="active-filter-label"></div>
</div>

<div class="glass-card mb-4">
{% if matches or pending_logs %}
    <div style="overflow-x: auto;">
    <table class="screening-table" id="matchTable">
        <thead>
            <tr>
                <th style="width:110px;">Date</th>
                <th style="width:160px;">Candidate</th>
                <th style="min-width:150px;">Job</th>
                <th style="width:90px; text-align:center;">Score</th>
                <th style="width:140px;">Status</th>
                <th>AI Notes</th>
            </tr>
        </thead>
        <tbody id="tableBody">
            {% for m in matches %}
            <tr data-status="{{ 'qualified' if m.is_qualified else 'not_recommended' }}"
                data-week="{{ 'yes' if m.created_at and m.created_at >= week_ago else 'no' }}">
                <td style="color:rgba(255,255,255,0.4); font-size:0.78rem; white-space:nowrap;">
                    {{ m.created_at.strftime('%b %d, %Y') if m.created_at else '—' }}
                </td>
                <td>
                    {% if m.vetting_log and m.vetting_log.bullhorn_candidate_id %}
                    <a class="candidate-link"
                       href="https://www.bullhornstaffing.com/BullhornStaffing/OpenWindow.cfm?entity=Candidate&id={{ m.vetting_log.bullhorn_candidate_id }}"
                       target="_blank" rel="noopener">
                        {{ m.vetting_log.candidate_name or 'Unknown' }}<i class="fas fa-external-link-alt ext-icon"></i>
                    </a>
                    {% else %}
                    <span style="color:rgba(255,255,255,0.6);">{{ m.vetting_log.candidate_name if m.vetting_log else 'Unknown' }}</span>
                    {% endif %}
                </td>
                <td>
                    <a class="job-link"
                       href="https://www.bullhornstaffing.com/BullhornStaffing/OpenWindow.cfm?entity=JobOrder&id={{ m.bullhorn_job_id }}"
                       target="_blank" rel="noopener">
                        {{ m.job_title or ('Job #' ~ m.bullhorn_job_id) }}<i class="fas fa-external-link-alt ext-icon"></i>
                    </a>
                </td>
                <td style="text-align:center;">
                    {% set score = m.match_score|round|int %}
                    {% if score >= 80 %}<span class="score-badge score-high">{{ score }}%</span>
                    {% elif score >= 60 %}<span class="score-badge score-mid">{{ score }}%</span>
                    {% elif score > 0 %}<span class="score-badge score-low">{{ score }}%</span>
                    {% else %}<span class="score-badge score-zero">—</span>
                    {% endif %}
                </td>
                <td>
                    {% if m.is_qualified %}
                    <span class="badge rounded-pill status-qualified">Qualified</span>
                    {% else %}
                    <span class="badge rounded-pill status-not-rec">Not Recommended</span>
                    {% endif %}
                </td>
                <td>
                    <div class="notes-cell">
                        <span class="notes-truncated" title="{{ m.match_summary or '' }}">{{ m.match_summary or '—' }}</span>
                    </div>
                </td>
            </tr>
            {% endfor %}
            {% for log in pending_logs %}
            <tr data-status="pending" data-week="no">
                <td style="color:rgba(255,255,255,0.4); font-size:0.78rem; white-space:nowrap;">
                    {{ log.created_at.strftime('%b %d, %Y') if log.created_at else '—' }}
                </td>
                <td>
                    {% if log.bullhorn_candidate_id %}
                    <a class="candidate-link"
                       href="https://www.bullhornstaffing.com/BullhornStaffing/OpenWindow.cfm?entity=Candidate&id={{ log.bullhorn_candidate_id }}"
                       target="_blank" rel="noopener">
                        {{ log.candidate_name or 'Unknown' }}<i class="fas fa-external-link-alt ext-icon"></i>
                    </a>
                    {% else %}
                    <span style="color:rgba(255,255,255,0.6);">{{ log.candidate_name or 'Unknown' }}</span>
                    {% endif %}
                </td>
                <td>
                    {% if log.applied_job_id %}
                    <a class="job-link"
                       href="https://www.bullhornstaffing.com/BullhornStaffing/OpenWindow.cfm?entity=JobOrder&id={{ log.applied_job_id }}"
                       target="_blank" rel="noopener">
                        {{ log.applied_job_title or ('Job #' ~ log.applied_job_id) }}<i class="fas fa-external-link-alt ext-icon"></i>
                    </a>
                    {% else %}<span style="color:rgba(255,255,255,0.4);">—</span>
                    {% endif %}
                </td>
                <td style="text-align:center;"><span class="score-badge score-zero">—</span></td>
                <td><span class="badge rounded-pill status-pending">Pending</span></td>
                <td><div class="notes-cell" style="color:rgba(255,255,255,0.3); font-style:italic;">Awaiting AI analysis…</div></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    </div>

    <!-- Filter empty state (shown via JS when filter matches zero rows) -->
    <div id="filterEmptyState" style="display:none;">
        <div class="empty-state">
            <i class="fas fa-search"></i>
            <p style="font-size:0.95rem;">No candidates match this filter.</p>
            <p style="font-size:0.82rem; color:rgba(255,255,255,0.25);">Click the active card again to clear the filter.</p>
        </div>
    </div>

    <!-- Pagination bar -->
    <div class="pagination-bar" id="paginationBar">
        <span id="pageInfo"></span>
        <div class="pagination-controls" id="pageControls"></div>
    </div>
{% else %}
    <div class="empty-state">
        <i class="fas fa-brain"></i>
        <p style="font-size:0.95rem;">No screened candidates yet for your jobs.</p>
        <p style="font-size:0.82rem; color:rgba(255,255,255,0.25);">Candidates who apply to your open positions will appear here once the AI has screened them.</p>
    </div>
{% endif %}
</div>

<!-- ===== JOB LEVEL SETTINGS TABLE ===== -->
{% if jobs_map %}
<div class="section-divider"></div>
<div class="section-header">
    <div>
        <h5><i class="fas fa-sliders-h me-2" style="color: var(--sc-accent);"></i>Job-Level Settings</h5>
        <div class="section-subtitle">Refine AI screening per job — custom requirements and thresholds override global defaults</div>
    </div>
</div>

<div class="glass-card">
    <div style="overflow-x: auto;">
    <table class="settings-table">
        <thead>
            <tr>
                <th style="min-width:200px;">Job</th>
                <th style="min-width:200px;">AI-Interpreted Requirements</th>
                <th style="width:160px; text-align:center;">Custom Override</th>
                <th style="width:120px; text-align:center;">Threshold</th>
                <th style="width:90px; text-align:center;">Save</th>
            </tr>
        </thead>
        <tbody>
        {% for job_id, job in jobs_map.items() %}
        {% set req = job_requirements.get(job_id) %}
        <tr>
            <td>
                <div class="job-title-cell">
                    <a href="https://www.bullhornstaffing.com/BullhornStaffing/OpenWindow.cfm?entity=JobOrder&id={{ job_id }}"
                       target="_blank" rel="noopener" class="job-link" style="color:rgba(255,255,255,0.85); font-weight:600; font-size:0.88rem;">
                        {{ job.title }}<i class="fas fa-external-link-alt ext-icon"></i>
                    </a>
                    <span class="job-id-badge">ID: {{ job_id }}</span>
                </div>
                {% if job.location %}
                <div style="font-size:0.75rem; color:rgba(255,255,255,0.35); margin-top:0.2rem;">
                    <i class="fas fa-map-marker-alt me-1"></i>{{ job.location }}
                </div>
                {% endif %}
                {% if job.work_type %}
                <span class="badge mt-1" style="background:rgba(155,127,212,0.12); color:var(--sc-accent); font-size:0.66rem; border:1px solid var(--sc-accent-border);">{{ job.work_type }}</span>
                {% endif %}
            </td>
            <td>
                {% if req and req.ai_interpreted_requirements %}
                <div class="ai-req-snippet">{{ req.ai_interpreted_requirements }}</div>
                {% if req.last_ai_interpretation %}
                <div style="font-size:0.7rem; color:rgba(255,255,255,0.25); margin-top:0.3rem;">
                    <i class="fas fa-clock me-1"></i>{{ req.last_ai_interpretation.strftime('%b %d, %Y') }}
                </div>
                {% endif %}
                {% else %}
                <div class="ai-req-snippet empty-req">Pending extraction — available within 5 minutes of job being added.</div>
                {% endif %}
            </td>
            <td style="text-align:center;">
                <button type="button" class="btn-configure"
                        onclick="openOverrideModal({{ job_id }}, {{ job.title|tojson }}, {{ (req.ai_interpreted_requirements or '')|tojson }}, {{ (req.custom_requirements or '')|tojson }}, {{ (req.vetting_threshold or '')|tojson }})">
                    <i class="fas fa-edit"></i> Configure
                </button>
                {% if req and req.custom_requirements %}
                <span class="active-override-badge">Active</span>
                {% endif %}
            </td>
            <td style="text-align:center;">
                <form id="thresholdForm-{{ job_id }}"
                      action="{{ url_for('scout_screening.save_job_settings', job_id=job_id) }}"
                      method="POST" style="display:inline;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="custom_requirements"
                           id="hiddenOverride-{{ job_id }}"
                           value="{{ req.custom_requirements or '' }}">
                    <input type="number"
                           class="threshold-input"
                           name="vetting_threshold"
                           id="thresholdInput-{{ job_id }}"
                           min="50" max="100"
                           placeholder="{{ global_threshold }}"
                           value="{{ req.vetting_threshold if req and req.vetting_threshold else '' }}"
                           title="Match threshold (50–100). Blank = global {{ global_threshold }}%.">
                </form>
            </td>
            <td style="text-align:center;">
                <button type="submit" form="thresholdForm-{{ job_id }}" class="btn-save">
                    <i class="fas fa-save"></i>
                </button>
            </td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
    </div>
</div>
{% endif %}

<!-- ===== CUSTOM OVERRIDE MODAL ===== -->
<div class="modal fade" id="overrideModal" tabindex="-1" aria-labelledby="overrideModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <div class="modal-title" id="overrideModalLabel">Configure Screening</div>
                    <div style="font-size:0.78rem; color:rgba(255,255,255,0.4); margin-top:0.15rem;" id="modalJobSubtitle"></div>
                </div>
                <button type="button" class="btn-close-modal" data-bs-dismiss="modal" aria-label="Close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="overrideModalForm" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="col-label"><i class="fas fa-robot"></i> AI-Interpreted Requirements</div>
                            <div class="ai-req-box" id="modalAiReq"></div>
                            <div style="font-size:0.72rem; color:rgba(255,255,255,0.25); margin-top:0.4rem;">
                                Read-only — extracted automatically from the Bullhorn job description.
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="col-label"><i class="fas fa-edit"></i> Custom Override</div>
                            <textarea class="override-textarea" name="custom_requirements" id="modalOverrideText"
                                      placeholder="Enter custom requirements to override AI interpretation…"></textarea>
                            <div class="override-hint">Custom requirements take priority over AI-interpreted ones during screening. Leave blank to use AI interpretation.</div>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6 offset-md-6">
                            <div class="col-label"><i class="fas fa-sliders-h"></i> Match Threshold</div>
                            <div class="d-flex align-items-center gap-2">
                                <input type="number" class="threshold-modal-input" name="vetting_threshold"
                                       id="modalThreshold" min="50" max="100"
                                       placeholder="{{ global_threshold }}">
                                <span style="font-size:0.78rem; color:rgba(255,255,255,0.35);">% (blank = global {{ global_threshold }}%)</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-sm btn-outline-secondary me-auto" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn-modal-save">
                        <i class="fas fa-save me-1"></i>Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
// ── Pagination ──────────────────────────────────────────────────────────────
const PAGE_SIZE = 10;
let currentPage = 1;
let visibleRows  = [];

function getVisibleRows() {
    return Array.from(document.querySelectorAll('#tableBody tr:not([style*="display: none"])'));
}

function renderPage() {
    const rows = visibleRows;
    const total = rows.length;
    const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
    if (currentPage > totalPages) currentPage = totalPages;

    rows.forEach((r, i) => {
        r.style.display = (i >= (currentPage - 1) * PAGE_SIZE && i < currentPage * PAGE_SIZE) ? '' : 'none';
    });

    const info = document.getElementById('pageInfo');
    const controls = document.getElementById('pageControls');
    const bar = document.getElementById('paginationBar');
    if (!bar) return;

    if (total === 0) { bar.style.display = 'none'; return; }
    bar.style.display = 'flex';

    const start = (currentPage - 1) * PAGE_SIZE + 1;
    const end   = Math.min(currentPage * PAGE_SIZE, total);
    if (info) info.textContent = `Showing ${start}–${end} of ${total}`;

    if (!controls) return;
    controls.innerHTML = '';

    const prevBtn = document.createElement('button');
    prevBtn.className = 'page-btn';
    prevBtn.textContent = '‹ Prev';
    prevBtn.disabled = currentPage === 1;
    prevBtn.onclick = () => { currentPage--; renderPage(); };
    controls.appendChild(prevBtn);

    const maxBtns = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxBtns / 2));
    let endPage   = Math.min(totalPages, startPage + maxBtns - 1);
    if (endPage - startPage < maxBtns - 1) startPage = Math.max(1, endPage - maxBtns + 1);

    for (let p = startPage; p <= endPage; p++) {
        const btn = document.createElement('button');
        btn.className = 'page-btn' + (p === currentPage ? ' current' : '');
        btn.textContent = p;
        btn.onclick = (function(pg) { return () => { currentPage = pg; renderPage(); }; })(p);
        controls.appendChild(btn);
    }

    const nextBtn = document.createElement('button');
    nextBtn.className = 'page-btn';
    nextBtn.textContent = 'Next ›';
    nextBtn.disabled = currentPage === totalPages;
    nextBtn.onclick = () => { currentPage++; renderPage(); };
    controls.appendChild(nextBtn);
}

// ── Filter ──────────────────────────────────────────────────────────────────
let activeFilter = null;

function filterMatches(filter) {
    const allRows = Array.from(document.querySelectorAll('#tableBody tr'));
    const label   = document.getElementById('active-filter-label');
    const filterEmpty = document.getElementById('filterEmptyState');
    const cards = {
        qualified:       document.getElementById('card-qualified'),
        pending:         document.getElementById('card-pending'),
        not_recommended: document.getElementById('card-not-rec'),
        week:            document.getElementById('card-week'),
    };

    if (activeFilter === filter) {
        activeFilter = null;
        allRows.forEach(r => r.style.display = '');
        Object.values(cards).forEach(c => c && c.classList.remove('active'));
        if (label) label.textContent = '';
        if (filterEmpty) filterEmpty.style.display = 'none';
        visibleRows = allRows;
        currentPage = 1;
        renderPage();
        return;
    }

    activeFilter = filter;
    Object.values(cards).forEach(c => c && c.classList.remove('active'));
    if (cards[filter]) cards[filter].classList.add('active');

    const labels = {
        qualified:       'Showing: Qualified Matches',
        pending:         'Showing: Pending Review',
        not_recommended: 'Showing: Not Recommended',
        week:            'Showing: Screened This Week',
    };
    if (label) label.textContent = labels[filter] || '';

    let matched = [];
    allRows.forEach(row => {
        const status = row.dataset.status;
        const week   = row.dataset.week === 'yes';
        let show = false;
        if      (filter === 'qualified')       show = status === 'qualified';
        else if (filter === 'pending')         show = status === 'pending';
        else if (filter === 'not_recommended') show = status === 'not_recommended';
        else if (filter === 'week')            show = week;
        row.style.display = show ? '' : 'none';
        if (show) matched.push(row);
    });

    if (filterEmpty) filterEmpty.style.display = matched.length === 0 ? 'block' : 'none';
    visibleRows = matched;
    currentPage = 1;
    renderPage();
}

// ── Override modal ──────────────────────────────────────────────────────────
function openOverrideModal(jobId, jobTitle, aiReq, customOverride, threshold) {
    const form     = document.getElementById('overrideModalForm');
    const subtitle = document.getElementById('modalJobSubtitle');
    const aiBox    = document.getElementById('modalAiReq');
    const textarea = document.getElementById('modalOverrideText');
    const thInput  = document.getElementById('modalThreshold');

    form.action = '/scout-screening/job/' + jobId + '/save';
    if (subtitle) subtitle.textContent = jobTitle + ' — ID: ' + jobId;

    if (aiBox) {
        if (aiReq && aiReq.trim()) {
            aiBox.textContent = aiReq;
            aiBox.classList.remove('empty');
        } else {
            aiBox.textContent = 'No AI interpretation available yet. Requirements are extracted automatically from the Bullhorn job description.';
            aiBox.classList.add('empty');
        }
    }
    if (textarea) textarea.value = customOverride || '';
    if (thInput)  thInput.value  = threshold || '';

    const modal = new bootstrap.Modal(document.getElementById('overrideModal'));
    modal.show();
}

// ── Init ────────────────────────────────────────────────────────────────────
document.addEventListener('DOMContentLoaded', function () {
    const allRows = Array.from(document.querySelectorAll('#tableBody tr'));
    visibleRows = allRows;
    renderPage();
});

// Auto-refresh every 60 seconds
setTimeout(() => location.reload(), 60000);
</script>
{% endblock %}
