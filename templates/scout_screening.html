{% extends "base_layout.html" %}
{% block body_attrs %}data-module="screening"{% endblock %}

{% block title %}Scout Screening Portal{% endblock %}

{% block extra_head %}
<style>
    :root {
        --sc-accent:        #9b7fd4;
        --sc-accent-dim:    rgba(155, 127, 212, 0.15);
        --sc-accent-border: rgba(155, 127, 212, 0.22);
        --sc-accent-hover:  rgba(155, 127, 212, 0.35);
    }

    /* ── Metric cards ── */
    .metrics-row .metric-card {
        background: linear-gradient(145deg, #1e1230 0%, #120b22 50%, #0e0819 100%);
        border-color: var(--sc-accent-border);
    }
    .metrics-row .metric-card::before {
        background: linear-gradient(135deg, var(--sc-accent-dim) 0%, transparent 50%);
    }
    .metrics-row .metric-card:hover {
        border-color: rgba(155, 127, 212, 0.5);
        box-shadow: 0 10px 30px rgba(155, 127, 212, 0.15);
    }
    .metrics-row .metric-card.metric-filter { cursor: pointer; transition: all 0.25s ease; }
    .metrics-row .metric-card.metric-filter.active {
        outline: 2px solid var(--sc-accent);
        outline-offset: 2px;
        box-shadow: 0 8px 28px rgba(155, 127, 212, 0.22);
    }
    .metrics-row .metric-value { color: var(--sc-accent); }
    .metrics-row .metric-icon  { color: var(--sc-accent); }

    /* ── Section layout ── */
    .section-header { margin-bottom: 1.25rem; }
    .section-header h5 { margin: 0; font-weight: 600; color: rgba(255,255,255,0.9); display: inline; }
    .section-header .section-subtitle { font-size: 0.8rem; color: rgba(255,255,255,0.4); margin-top: 0.3rem; }
    .section-divider { border-top: 1px solid rgba(255,255,255,0.07); margin: 2.5rem 0; }

    /* ── Scout Screening card shell ── */
    .sc-card {
        background: rgba(18, 10, 30, 0.7);
        border: 1px solid var(--sc-accent-border);
        border-radius: 14px;
        overflow: hidden;
    }
    .sc-card-header {
        background: rgba(0,0,0,0.25) !important;
        border-bottom: 1px solid var(--sc-accent-border) !important;
        padding: 0.85rem 1.4rem;
    }
    .sc-card-header h6 { margin: 0; font-size: 0.9rem; font-weight: 600; color: rgba(255,255,255,0.88); }

    /* ── Shared table styles (Bootstrap override) ── */
    .sc-table { --bs-table-bg: transparent; --bs-table-hover-bg: rgba(155,127,212,0.05); margin-bottom: 0; }
    .sc-table tbody td, .sc-table tbody tr { background-color: transparent !important; }
    .sc-table thead th {
        font-size: 0.71rem;
        text-transform: uppercase;
        letter-spacing: 0.6px;
        color: rgba(155, 127, 212, 0.65);
        border-bottom: 1px solid var(--sc-accent-border) !important;
        padding: 0.85rem 1.4rem;
        background: rgba(0,0,0,0.12);
        white-space: nowrap;
        font-weight: 600;
    }
    .sc-table tbody td {
        padding: 1.1rem 1.4rem;
        border-color: rgba(255,255,255,0.05) !important;
        vertical-align: middle;
        font-size: 0.85rem;
        color: rgba(255,255,255,0.78);
    }
    .sc-table tbody tr:last-child td { border-bottom: none !important; }

    /* ── Shared hyperlink style ── */
    .sc-link {
        color: var(--sc-accent);
        text-decoration: none;
        font-size: 0.83rem;
        font-weight: 400;
    }
    .sc-link:hover { color: #c4aef0; text-decoration: underline; text-underline-offset: 2px; }
    .sc-link-sm { font-size: 0.77rem; }
    .ext-icon { font-size: 0.6rem; opacity: 0.42; margin-left: 2px; }

    /* ── Candidate name link ── */
    .cand-link { color: var(--sc-accent); text-decoration: none; font-weight: 500; font-size: 0.85rem; }
    .cand-link:hover { color: #c4aef0; text-decoration: underline; }

    /* ── Score badges ── */
    .score-badge {
        display: inline-block; padding: 0.22rem 0.6rem;
        border-radius: 6px; font-weight: 700; font-size: 0.82rem;
        min-width: 50px; text-align: center;
    }
    .score-high  { background: rgba(40,167,69,0.14);   color: #7ec98e; border: 1px solid rgba(40,167,69,0.22); }
    .score-mid   { background: rgba(255,193,7,0.14);   color: #ffd966; border: 1px solid rgba(255,193,7,0.22); }
    .score-low   { background: rgba(220,53,69,0.14);   color: #e87c7c; border: 1px solid rgba(220,53,69,0.22); }
    .score-zero  { background: rgba(108,117,125,0.12); color: #9da5ad; border: 1px solid rgba(108,117,125,0.18); }

    /* ── Status badges ── */
    .st-qualified { background: rgba(40,167,69,0.12);  color: #7ec98e; border: 1px solid rgba(40,167,69,0.18);  font-size: 0.71rem; }
    .st-not-rec   { background: rgba(220,53,69,0.12);  color: #e87c7c; border: 1px solid rgba(220,53,69,0.18);  font-size: 0.71rem; }
    .st-pending   { background: rgba(255,193,7,0.12);  color: #ffd966; border: 1px solid rgba(255,193,7,0.18);  font-size: 0.71rem; }

    /* ── AI notes snippet ── */
    .notes-snippet {
        font-size: 0.8rem;
        color: rgba(255,255,255,0.45);
        display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
        overflow: hidden; max-width: 240px; line-height: 1.45; margin-bottom: 0.25rem;
    }

    /* ── AI requirement status text ── */
    .ai-ready-text   { color: rgba(155,127,212,0.75); font-size: 0.8rem; }
    .ai-pending-text { color: rgba(255,255,255,0.28); font-size: 0.8rem; font-style: italic; }

    /* ── Threshold input ── */
    .threshold-input {
        background: rgba(0,0,0,0.35);
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 6px;
        color: rgba(255,255,255,0.7);
        font-size: 0.82rem;
        padding: 0.3rem 0.4rem;
        width: 52px; text-align: center;
        transition: border-color 0.2s;
    }
    .threshold-input:focus { outline: none; border-color: var(--sc-accent); }

    /* ── Threshold auto-save feedback ── */
    .threshold-feedback {
        position: absolute; right: -54px; top: 50%; transform: translateY(-50%);
        font-size: 0.72rem; white-space: nowrap; pointer-events: none;
        opacity: 0; transition: opacity 0.3s ease;
    }
    .threshold-feedback.visible { opacity: 1; }
    .threshold-feedback.saved   { color: #7ec98e; }
    .threshold-feedback.error   { color: #e87c7c; }

    /* ── Pagination footer ── */
    .sc-footer {
        background: rgba(0,0,0,0.18) !important;
        border-top: 1px solid rgba(255,255,255,0.06) !important;
        padding: 0.65rem 1.4rem;
        font-size: 0.8rem;
        color: rgba(255,255,255,0.32);
    }
    .pg-nav {
        color: var(--sc-accent); text-decoration: none; font-size: 0.82rem;
        transition: color 0.15s, opacity 0.15s;
    }
    .pg-nav:hover { color: #c4aef0; }
    .pg-nav.disabled { opacity: 0.28; pointer-events: none; }

    /* ── Empty state ── */
    .sc-empty {
        text-align: center; padding: 3.5rem 1rem;
        color: rgba(255,255,255,0.32);
    }
    .sc-empty i { font-size: 2.5rem; margin-bottom: 1rem; opacity: 0.2; display: block; }

    /* ── Modal shell ── */
    .modal-content {
        background: #0f0a1c;
        border: 1px solid var(--sc-accent-border);
        border-radius: 14px;
        color: rgba(255,255,255,0.88);
    }
    .modal-header {
        display: flex; align-items: flex-start; justify-content: space-between;
        border-bottom: 1px solid rgba(255,255,255,0.08); padding: 1.1rem 1.4rem 0.9rem;
    }
    .modal-footer { border-top: 1px solid rgba(255,255,255,0.08); padding: 0.85rem 1.4rem; }
    .modal-body   { padding: 1.25rem 1.4rem; }
    .modal-title  { font-size: 1rem; font-weight: 600; color: rgba(255,255,255,0.92); }
    .btn-close-modal {
        background: transparent !important; border: none !important; padding: 0 !important;
        margin-left: auto !important; line-height: 1; flex-shrink: 0;
        color: rgba(255,255,255,0.4); font-size: 1.1rem; cursor: pointer;
        transition: color 0.15s; align-self: flex-start;
    }
    .btn-close-modal:hover { color: rgba(255,255,255,0.85); }
    /* Remove number input spinners so centering works */
    input[type=number].threshold-input::-webkit-outer-spin-button,
    input[type=number].threshold-input::-webkit-inner-spin-button,
    input[type=number].threshold-modal-input::-webkit-outer-spin-button,
    input[type=number].threshold-modal-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number].threshold-input,
    input[type=number].threshold-modal-input { -moz-appearance: textfield; }
    .col-label {
        font-size: 0.71rem; text-transform: uppercase; letter-spacing: 0.5px;
        color: var(--sc-accent); margin-bottom: 0.5rem;
        display: flex; align-items: center; gap: 0.35rem;
    }
    .override-textarea {
        display: block; box-sizing: border-box; width: 100%;
        background: rgba(0,0,0,0.3); border: 1px solid var(--sc-accent-border);
        border-radius: 8px; color: rgba(255,255,255,0.85); font-size: 0.82rem;
        resize: vertical; min-height: 130px; max-height: 280px;
        padding: 0.75rem 0.9rem; line-height: 1.65; transition: border-color 0.2s;
    }
    .override-textarea:focus { outline: none; border-color: var(--sc-accent); }
    .override-textarea::placeholder { color: rgba(255,255,255,0.2); }
    .override-hint { font-size: 0.72rem; color: rgba(255,255,255,0.27); margin-top: 0.4rem; }
    .threshold-modal-input {
        background: rgba(0,0,0,0.3); border: 1px solid var(--sc-accent-border);
        border-radius: 7px; color: rgba(255,255,255,0.85); font-size: 0.85rem;
        padding: 0.35rem 0.5rem; width: 58px; text-align: center;
        transition: border-color 0.2s;
    }
    .threshold-modal-input:focus { outline: none; border-color: var(--sc-accent); }
    .btn-modal-save {
        background-color: var(--sc-accent) !important; border: none; color: #fff !important;
        border-radius: 8px; padding: 0.5rem 1.4rem; font-size: 0.88rem;
        font-weight: 600; cursor: pointer; transition: background-color 0.2s;
    }
    .btn-modal-save:hover { background-color: #b899e8 !important; }
    .notes-full-text {
        background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.06);
        border-radius: 8px; padding: 1rem 1.1rem; font-size: 0.85rem;
        color: rgba(255,255,255,0.68); line-height: 1.75; white-space: pre-wrap;
        max-height: 360px; overflow-y: auto;
    }
</style>
{% endblock %}

{% block page_title %}Scout Screening Portal{% endblock %}
{% block page_subtitle %}AI-screened candidates for your open positions{% endblock %}

{% block page_actions %}
<button class="btn btn-outline-light btn-sm" onclick="location.reload()">
    <i class="fas fa-sync-alt me-1"></i>Refresh
</button>
{% endblock %}

{% block content %}

<!-- ===== METRIC CARDS ===== -->
<div class="metrics-row mb-4">
    <div class="metric-card metric-filter" id="card-qualified" onclick="filterMatches('qualified')">
        <div class="metric-icon"><i class="fas fa-check-circle"></i></div>
        <div class="metric-label">Qualified Matches</div>
        <div class="metric-value">{{ metrics.qualified }}</div>
        <div class="metric-subtext">Above threshold</div>
        <div class="metric-trend neutral"><i class="fas fa-star"></i> Approved</div>
    </div>
    <div class="metric-card metric-filter" id="card-pending" onclick="filterMatches('pending')">
        <div class="metric-icon"><i class="fas fa-clock"></i></div>
        <div class="metric-label">Pending Review</div>
        <div class="metric-value">{{ metrics.pending }}</div>
        <div class="metric-subtext">Awaiting AI analysis</div>
        <div class="metric-trend neutral"><i class="fas fa-hourglass-half"></i> In Queue</div>
    </div>
    <div class="metric-card metric-filter" id="card-not-rec" onclick="filterMatches('not_recommended')">
        <div class="metric-icon"><i class="fas fa-times-circle"></i></div>
        <div class="metric-label">Not Recommended</div>
        <div class="metric-value">{{ metrics.not_recommended }}</div>
        <div class="metric-subtext">Below threshold</div>
        <div class="metric-trend neutral"><i class="fas fa-filter"></i> Filtered</div>
    </div>
    <div class="metric-card metric-filter" id="card-week" onclick="filterMatches('week')">
        <div class="metric-icon"><i class="fas fa-calendar-week"></i></div>
        <div class="metric-label">Screened This Week</div>
        <div class="metric-value">{{ metrics.screened_this_week }}</div>
        <div class="metric-subtext">Last 7 days</div>
        <div class="metric-trend neutral"><i class="fas fa-chart-line"></i> Recent</div>
    </div>
</div>

<!-- ===== SCREENED CANDIDATES ===== -->
<div class="section-header">
    <h5><i class="fas fa-users me-2" style="color:var(--sc-accent);"></i>Screened Candidates</h5>
    <div class="section-subtitle">AI match results for candidates on your active jobs — click a metric card above to filter</div>
</div>

<div class="sc-card mb-4">
    <div class="card-body p-0">
{% if matches or pending_logs %}
        <div class="table-responsive">
        <table class="table table-dark table-hover sc-table" id="matchTable">
            <thead>
                <tr>
                    <th style="width:100px; white-space:nowrap;">Screened</th>
                    <th style="white-space:nowrap;">Candidate</th>
                    <th style="white-space:nowrap;">Job</th>
                    <th style="width:80px; text-align:center; white-space:nowrap;">Score</th>
                    <th style="white-space:nowrap;">Status</th>
                    <th style="white-space:nowrap;">AI Notes</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                {% for m in matches %}
                <tr data-status="{{ 'qualified' if m.is_qualified else 'not_recommended' }}"
                    data-week="{{ 'yes' if m.created_at and m.created_at >= week_ago else 'no' }}">
                    <td style="color:rgba(255,255,255,0.38); font-size:0.78rem; white-space:nowrap;">
                        {{ m.created_at.strftime('%b %d, %Y') if m.created_at else '—' }}
                    </td>
                    <td>
                        {% if m.vetting_log and m.vetting_log.bullhorn_candidate_id %}
                        <a class="cand-link"
                           href="https://www.bullhornstaffing.com/BullhornStaffing/OpenWindow.cfm?entity=Candidate&id={{ m.vetting_log.bullhorn_candidate_id }}"
                           target="_blank" rel="noopener">
                            {{ m.vetting_log.candidate_name or 'Unknown' }}<i class="fas fa-external-link-alt ext-icon"></i>
                        </a>
                        {% else %}
                        <span style="color:rgba(255,255,255,0.6);">{{ m.vetting_log.candidate_name if m.vetting_log else 'Unknown' }}</span>
                        {% endif %}
                    </td>
                    <td>
                        <a class="sc-link"
                           href="https://www.bullhornstaffing.com/BullhornStaffing/OpenWindow.cfm?entity=JobOrder&id={{ m.bullhorn_job_id }}"
                           target="_blank" rel="noopener">
                            {{ m.job_title or ('Job #' ~ m.bullhorn_job_id) }}<i class="fas fa-external-link-alt ext-icon"></i>
                        </a>
                    </td>
                    <td style="text-align:center;">
                        {% set score = m.match_score|round|int %}
                        {% if score >= 80 %}<span class="score-badge score-high">{{ score }}%</span>
                        {% elif score >= 60 %}<span class="score-badge score-mid">{{ score }}%</span>
                        {% elif score > 0 %}<span class="score-badge score-low">{{ score }}%</span>
                        {% else %}<span class="score-badge score-zero">—</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if m.is_qualified %}
                        <span class="badge rounded-pill st-qualified">Qualified</span>
                        {% else %}
                        <span class="badge rounded-pill st-not-rec">Not Recommended</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if m.match_summary %}
                        <div class="notes-snippet">{{ m.match_summary[:100] }}…</div>
                        <a href="javascript:void(0)" class="sc-link sc-link-sm open-notes-link"
                           data-cname="{{ (m.vetting_log.candidate_name if m.vetting_log else 'Unknown')|e }}"
                           data-job="{{ (m.job_title or ('Job #' ~ m.bullhorn_job_id))|e }}"
                           data-notes="{{ m.match_summary|e }}"
                           data-bhid="{{ (m.vetting_log.bullhorn_candidate_id if m.vetting_log else '')|e }}">View full notes</a>
                        {% else %}
                        <span style="color:rgba(255,255,255,0.2); font-size:0.78rem;">—</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
                {% for log in pending_logs %}
                <tr data-status="pending" data-week="no">
                    <td style="color:rgba(255,255,255,0.38); font-size:0.78rem; white-space:nowrap;">
                        {{ log.created_at.strftime('%b %d, %Y') if log.created_at else '—' }}
                    </td>
                    <td>
                        {% if log.bullhorn_candidate_id %}
                        <a class="cand-link"
                           href="https://www.bullhornstaffing.com/BullhornStaffing/OpenWindow.cfm?entity=Candidate&id={{ log.bullhorn_candidate_id }}"
                           target="_blank" rel="noopener">
                            {{ log.candidate_name or 'Unknown' }}<i class="fas fa-external-link-alt ext-icon"></i>
                        </a>
                        {% else %}
                        <span style="color:rgba(255,255,255,0.6);">{{ log.candidate_name or 'Unknown' }}</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if log.applied_job_id %}
                        <a class="sc-link"
                           href="https://www.bullhornstaffing.com/BullhornStaffing/OpenWindow.cfm?entity=JobOrder&id={{ log.applied_job_id }}"
                           target="_blank" rel="noopener">
                            {{ log.applied_job_title or ('Job #' ~ log.applied_job_id) }}<i class="fas fa-external-link-alt ext-icon"></i>
                        </a>
                        {% else %}<span style="color:rgba(255,255,255,0.25);">—</span>
                        {% endif %}
                    </td>
                    <td style="text-align:center;"><span class="score-badge score-zero">—</span></td>
                    <td><span class="badge rounded-pill st-pending">Pending</span></td>
                    <td><span style="color:rgba(255,255,255,0.25); font-size:0.78rem; font-style:italic;">Awaiting AI analysis…</span></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        </div>

        <!-- Filter zero-match message -->
        <div id="filterEmptyState" style="display:none;">
            <div class="sc-empty">
                <i class="fas fa-search"></i>
                <p style="font-size:0.92rem;">No candidates match this filter.</p>
                <p style="font-size:0.8rem; color:rgba(255,255,255,0.22);">Click the highlighted card again to clear the filter.</p>
            </div>
        </div>

        <!-- Pagination footer (only shown when there are rows) -->
        <div class="sc-footer d-flex justify-content-between align-items-center" id="paginationBar" style="display:none !important;">
            <span id="pageInfo"></span>
            <div class="d-flex align-items-center gap-3">
                <a href="javascript:void(0)" class="pg-nav disabled" id="prevBtn" onclick="changePage(-1)">← Previous</a>
                <span id="pageIndicator" style="color:rgba(255,255,255,0.35); font-size:0.78rem;"></span>
                <a href="javascript:void(0)" class="pg-nav disabled" id="nextBtn" onclick="changePage(1)">Next →</a>
            </div>
        </div>
{% else %}
        <div class="sc-empty">
            <i class="fas fa-brain"></i>
            <p style="font-size:0.95rem;">No screened candidates yet for your jobs.</p>
            <p style="font-size:0.82rem; color:rgba(255,255,255,0.22);">Candidates who apply to your open positions will appear here once the AI has screened them.</p>
        </div>
{% endif %}
    </div>
</div>

<!-- ===== JOB LEVEL SETTINGS ===== -->
{% if jobs_map %}
<div class="section-divider"></div>
<div class="section-header">
    <h5><i class="fas fa-sliders-h me-2" style="color:var(--sc-accent);"></i>Job-Level Settings</h5>
    <div class="section-subtitle">Refine AI screening per job — custom requirements and thresholds override global defaults</div>
</div>

<div class="sc-card">
    <div class="card-body p-0">
        <div class="table-responsive">
        <table class="table table-dark table-hover sc-table">
            <thead>
                <tr>
                    <th>Job</th>
                    <th style="text-align:center; white-space:nowrap;">AI Requirements</th>
                    <th style="text-align:center; white-space:nowrap;">Custom Override</th>
                    <th style="width:130px; text-align:center; white-space:nowrap;">Threshold</th>
                </tr>
            </thead>
            <tbody>
            {% for job_id, job in jobs_map.items() %}
            {% set req = job_requirements.get(job_id) %}
            <tr>
                <td>
                    <div>
                        <a href="https://www.bullhornstaffing.com/BullhornStaffing/OpenWindow.cfm?entity=JobOrder&id={{ job_id }}"
                           target="_blank" rel="noopener" class="sc-link" style="font-weight:600; font-size:0.87rem; color:rgba(255,255,255,0.82);">
                            {{ job.title }}<i class="fas fa-external-link-alt ext-icon"></i>
                        </a>
                        <span style="font-size:0.7rem; color:rgba(255,255,255,0.28); margin-left:0.4rem;">ID: {{ job_id }}</span>
                    </div>
                    {% if job.location %}
                    <div style="font-size:0.74rem; color:rgba(255,255,255,0.3); margin-top:0.2rem;">
                        <i class="fas fa-map-marker-alt me-1"></i>{{ job.location }}
                    </div>
                    {% endif %}
                </td>
                <td style="text-align:center;">
                    {% if req and req.ai_interpreted_requirements %}
                    <span class="ai-ready-text"><i class="fas fa-robot me-1"></i>Ready</span>
                    {% else %}
                    <span class="ai-pending-text"><i class="fas fa-clock me-1"></i>Pending</span>
                    {% endif %}
                </td>
                <td style="text-align:center;">
                    <a href="javascript:void(0)" class="sc-link open-config-link"
                       data-job-id="{{ job_id }}"
                       data-job-title="{{ job.title|e }}"
                       data-ai-req="{{ (req.ai_interpreted_requirements if req and req.ai_interpreted_requirements else '')|e }}"
                       data-custom="{{ (req.custom_requirements if req and req.custom_requirements else '')|e }}"
                       data-threshold="{{ (req.vetting_threshold if req and req.vetting_threshold else '')|e }}">
                        Configure{% if req and req.custom_requirements %}&nbsp;<i class="fas fa-circle" style="font-size:0.45rem; color:var(--sc-accent); vertical-align:middle; opacity:0.8;"></i>{% endif %}
                    </a>
                </td>
                <td style="text-align:center;">
                    <input type="hidden" id="hiddenOverride-{{ job_id }}"
                           value="{{ req.custom_requirements or '' if req else '' }}">
                    <div style="position:relative; display:inline-block;">
                        <input type="number"
                               class="threshold-input auto-save-threshold"
                               data-job-id="{{ job_id }}"
                               data-save-url="{{ url_for('scout_screening.save_job_settings', job_id=job_id) }}"
                               data-csrf="{{ csrf_token() }}"
                               min="50" max="100"
                               placeholder="{{ global_threshold }}"
                               value="{{ req.vetting_threshold if req and req.vetting_threshold else '' }}"
                               title="Match threshold (50–100). Blank = global {{ global_threshold }}%."
                               style="width:46px; min-width:0; text-align:center; -webkit-appearance:none; -moz-appearance:textfield;">
                        <span class="threshold-feedback" id="tfb-{{ job_id }}"></span>
                    </div>
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
        </div>
    </div>
</div>
{% endif %}

<!-- ===== CONFIGURE OVERRIDE MODAL ===== -->
<div class="modal fade" id="overrideModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" style="max-width:640px;">
        <div class="modal-content">
            <div class="modal-header" style="display:flex; align-items:flex-start; justify-content:space-between; padding:1.1rem 1.4rem 0.9rem; border-bottom:1px solid rgba(255,255,255,0.08);">
                <div style="flex:1; min-width:0;">
                    <div class="modal-title">Configure Screening</div>
                    <div style="font-size:0.78rem; color:rgba(255,255,255,0.35); margin-top:0.15rem;" id="modalJobSubtitle"></div>
                </div>
                <button type="button" class="btn-close-modal" data-bs-dismiss="modal" style="margin-left:1rem; flex-shrink:0; background:transparent; border:none; color:rgba(255,255,255,0.4); font-size:1.1rem; cursor:pointer; padding:0; line-height:1; align-self:flex-start;"><i class="fas fa-times"></i></button>
            </div>
            <form id="overrideModalForm" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body" style="padding:1.25rem 1.4rem;">

                    <div class="col-label mb-1"><i class="fas fa-robot"></i> AI-Interpreted Requirements</div>
                    <div class="notes-full-text" id="modalAiReq" style="max-height:180px;"></div>
                    <div style="font-size:0.71rem; color:rgba(255,255,255,0.22); margin-top:0.4rem; margin-bottom:1.1rem;">
                        Read-only — extracted automatically from the Bullhorn job description.
                    </div>

                    <div class="col-label mb-1"><i class="fas fa-edit"></i> Custom Override</div>
                    <textarea name="custom_requirements" id="modalOverrideText"
                              placeholder="Enter custom requirements to override AI interpretation…"
                              style="display:block; width:100%; box-sizing:border-box; background:rgba(0,0,0,0.3); border:1px solid rgba(155,127,212,0.22); border-radius:8px; color:rgba(255,255,255,0.85); font-size:0.82rem; resize:vertical; min-height:130px; max-height:280px; padding:0.75rem 0.9rem; line-height:1.65; outline:none; font-family:inherit;"></textarea>
                    <div style="font-size:0.72rem; color:rgba(255,255,255,0.27); margin-top:0.4rem; margin-bottom:1.1rem;">Custom requirements take priority over AI-interpreted ones. Leave blank to use AI interpretation.</div>

                    <div class="col-label mb-1"><i class="fas fa-sliders-h"></i> Match Threshold</div>
                    <div style="display:flex; align-items:center; gap:0.6rem;">
                        <input type="number" name="vetting_threshold" id="modalThreshold"
                               min="50" max="100" placeholder="{{ global_threshold }}"
                               style="width:52px; text-align:center; background:rgba(0,0,0,0.3); border:1px solid rgba(155,127,212,0.22); border-radius:7px; color:rgba(255,255,255,0.85); font-size:0.85rem; padding:0.35rem 0.4rem; outline:none; -moz-appearance:textfield;">
                        <span style="font-size:0.77rem; color:rgba(255,255,255,0.3);">% — blank uses global default ({{ global_threshold }}%)</span>
                    </div>

                </div>
                <div class="modal-footer" style="border-top:1px solid rgba(255,255,255,0.08); padding:0.85rem 1.4rem;">
                    <button type="button" class="btn btn-sm btn-outline-secondary me-auto" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" style="background-color:#9b7fd4; border:none; color:#fff; border-radius:8px; padding:0.5rem 1.4rem; font-size:0.88rem; font-weight:600; cursor:pointer;"><i class="fas fa-save me-1"></i>Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ===== AI NOTES MODAL ===== -->
<div class="modal fade" id="notesModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" style="max-width:600px;">
        <div class="modal-content">
            <div class="modal-header" style="display:flex; align-items:flex-start; justify-content:space-between; padding:1.1rem 1.4rem 0.9rem; border-bottom:1px solid rgba(255,255,255,0.08);">
                <div style="flex:1; min-width:0;">
                    <div class="modal-title">AI Match Analysis</div>
                    <div style="font-size:0.78rem; color:rgba(255,255,255,0.35); margin-top:0.15rem;" id="notesModalSubtitle"></div>
                </div>
                <button type="button" data-bs-dismiss="modal" style="margin-left:1rem; flex-shrink:0; align-self:flex-start; background:transparent; border:none; color:#9b7fd4; font-size:1.1rem; cursor:pointer; padding:0; line-height:1; transition:color 0.15s;" onmouseover="this.style.color='#c4a8f0'" onmouseout="this.style.color='#9b7fd4'"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="col-label mb-2"><i class="fas fa-brain"></i> Scout AI Assessment</div>
                <div class="notes-full-text" id="notesFullText"></div>
                <div style="margin-top:0.85rem; font-size:0.72rem; color:rgba(255,255,255,0.28);">
                    <i class="fas fa-check-circle me-1" style="color:rgba(155,127,212,0.6);"></i>These notes are generated by Scout AI and are also written directly to the candidate record in Bullhorn — visible under the candidate's Notes tab.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-sm btn-outline-secondary me-auto" data-bs-dismiss="modal">Close</button>
                <a id="notesBullhornLink" href="#" target="_blank" rel="noopener"
                   style="background:var(--sc-accent-dim); border:1px solid var(--sc-accent-border); color:var(--sc-accent); border-radius:7px; padding:0.35rem 0.9rem; font-size:0.82rem; text-decoration:none;">
                    <i class="fas fa-external-link-alt me-1"></i>View in Bullhorn
                </a>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
// ── Pagination ───────────────────────────────────────────────────────────────
const PAGE_SIZE = 10;
let currentPage = 1;
let visibleRows = [];

function renderPage() {
    const total      = visibleRows.length;
    const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
    if (currentPage > totalPages) currentPage = totalPages;
    if (currentPage < 1) currentPage = 1;

    visibleRows.forEach((r, i) => {
        r.style.display = (i >= (currentPage-1)*PAGE_SIZE && i < currentPage*PAGE_SIZE) ? '' : 'none';
    });

    const bar  = document.getElementById('paginationBar');
    const info = document.getElementById('pageInfo');
    const ind  = document.getElementById('pageIndicator');
    const prev = document.getElementById('prevBtn');
    const next = document.getElementById('nextBtn');
    if (!bar) return;

    if (total === 0) { bar.style.setProperty('display','none','important'); return; }
    bar.style.removeProperty('display');
    bar.style.display = 'flex';

    const start = (currentPage-1)*PAGE_SIZE + 1;
    const end   = Math.min(currentPage*PAGE_SIZE, total);
    if (info) info.textContent = `Showing ${start}–${end} of ${total} result${total !== 1 ? 's' : ''}`;
    if (ind)  ind.textContent  = `Page ${currentPage} of ${totalPages}`;
    if (prev) prev.classList.toggle('disabled', currentPage === 1);
    if (next) next.classList.toggle('disabled', currentPage === totalPages);
}

function changePage(delta) {
    const tp = Math.max(1, Math.ceil(visibleRows.length / PAGE_SIZE));
    const np = currentPage + delta;
    if (np < 1 || np > tp) return;
    currentPage = np;
    renderPage();
}

// ── Filter ───────────────────────────────────────────────────────────────────
let activeFilter = null;

function filterMatches(filter) {
    const allRows     = Array.from(document.querySelectorAll('#tableBody tr'));
    const filterEmpty = document.getElementById('filterEmptyState');
    const cards = {
        qualified:       document.getElementById('card-qualified'),
        pending:         document.getElementById('card-pending'),
        not_recommended: document.getElementById('card-not-rec'),
        week:            document.getElementById('card-week'),
    };

    if (activeFilter === filter) {
        activeFilter = null;
        allRows.forEach(r => r.style.display = '');
        Object.values(cards).forEach(c => c && c.classList.remove('active'));
        if (filterEmpty) filterEmpty.style.display = 'none';
        visibleRows = allRows;
        currentPage = 1;
        renderPage();
        return;
    }

    activeFilter = filter;
    Object.values(cards).forEach(c => c && c.classList.remove('active'));
    if (cards[filter]) cards[filter].classList.add('active');

    const matched = [];
    allRows.forEach(row => {
        const status = row.dataset.status;
        const isWeek = row.dataset.week === 'yes';
        let show = (filter === 'qualified' && status === 'qualified')
                || (filter === 'pending'   && status === 'pending')
                || (filter === 'not_recommended' && status === 'not_recommended')
                || (filter === 'week'      && isWeek);
        row.style.display = show ? '' : 'none';
        if (show) matched.push(row);
    });

    if (filterEmpty) filterEmpty.style.display = matched.length === 0 ? 'block' : 'none';
    visibleRows = matched;
    currentPage = 1;
    renderPage();
}

// ── Event delegation — notes + configure links ────────────────────────────────
document.addEventListener('click', function (e) {
    const notesLink = e.target.closest('.open-notes-link');
    if (notesLink) {
        e.preventDefault();
        openNotesModal(
            notesLink.dataset.cname,
            notesLink.dataset.job,
            notesLink.dataset.notes,
            notesLink.dataset.bhid
        );
        return;
    }

    const configLink = e.target.closest('.open-config-link');
    if (configLink) {
        e.preventDefault();
        openOverrideModal(
            configLink.dataset.jobId,
            configLink.dataset.jobTitle,
            configLink.dataset.aiReq,
            configLink.dataset.custom,
            configLink.dataset.threshold
        );
    }
});

// ── Override modal ────────────────────────────────────────────────────────────
function openOverrideModal(jobId, jobTitle, aiReq, customOverride, threshold) {
    const form     = document.getElementById('overrideModalForm');
    const subtitle = document.getElementById('modalJobSubtitle');
    const aiBox    = document.getElementById('modalAiReq');
    const textarea = document.getElementById('modalOverrideText');
    const thInput  = document.getElementById('modalThreshold');

    form.action = '/scout-screening/job/' + jobId + '/save';
    if (subtitle) subtitle.textContent = (jobTitle || '') + '  ·  ID: ' + jobId;
    if (aiBox) {
        const hasReq = aiReq && aiReq.trim();
        aiBox.textContent = hasReq ? aiReq
            : 'No AI interpretation available yet. Requirements are extracted automatically from the Bullhorn job description within 5 minutes of the job being added.';
        aiBox.style.color = hasReq ? '' : 'rgba(255,255,255,0.28)';
        aiBox.style.fontStyle = hasReq ? '' : 'italic';
    }
    if (textarea) textarea.value = customOverride || '';
    if (thInput)  thInput.value  = threshold || '';
    new bootstrap.Modal(document.getElementById('overrideModal')).show();
}

// ── Notes modal ───────────────────────────────────────────────────────────────
function openNotesModal(candidateName, jobTitle, notes, bullhornId) {
    const subtitle = document.getElementById('notesModalSubtitle');
    const notesBox = document.getElementById('notesFullText');
    const bhLink   = document.getElementById('notesBullhornLink');

    if (subtitle) subtitle.textContent = (candidateName || '') + '  ·  ' + (jobTitle || '');
    if (notesBox) notesBox.textContent = notes || '—';
    if (bhLink) {
        bhLink.style.display = bullhornId ? '' : 'none';
        if (bullhornId) bhLink.href = 'https://www.bullhornstaffing.com/BullhornStaffing/OpenWindow.cfm?entity=Candidate&id=' + bullhornId;
    }
    new bootstrap.Modal(document.getElementById('notesModal')).show();
}

// ── Threshold auto-save ───────────────────────────────────────────────────────
function showThresholdFeedback(jobId, success) {
    const fb = document.getElementById('tfb-' + jobId);
    if (!fb) return;
    fb.textContent = success ? '✓ Saved' : '✗ Error';
    fb.className   = 'threshold-feedback ' + (success ? 'saved' : 'error');
    void fb.offsetWidth; // reflow
    fb.classList.add('visible');
    setTimeout(() => { fb.classList.remove('visible'); }, 2000);
}

document.addEventListener('DOMContentLoaded', function () {
    // Pagination init
    visibleRows = Array.from(document.querySelectorAll('#tableBody tr'));
    renderPage();

    // Auto-save threshold on blur
    document.querySelectorAll('.auto-save-threshold').forEach(function (input) {
        let originalValue = input.value;
        input.addEventListener('focus', function () { originalValue = this.value; });
        input.addEventListener('blur', function () {
            const jobId  = this.dataset.jobId;
            const newVal = this.value.trim();
            if (newVal === originalValue) return; // no change

            const num = parseInt(newVal, 10);
            if (newVal !== '' && (isNaN(num) || num < 50 || num > 100)) {
                showThresholdFeedback(jobId, false);
                this.value = originalValue;
                return;
            }

            const fd = new FormData();
            fd.append('csrf_token',         this.dataset.csrf);
            fd.append('vetting_threshold',  newVal);
            fd.append('custom_requirements', (document.getElementById('hiddenOverride-' + jobId) || {}).value || '');
            fd.append('_ajax',              '1');

            fetch(this.dataset.saveUrl, { method: 'POST', body: fd })
                .then(r => {
                    if (r.ok) { originalValue = newVal; showThresholdFeedback(jobId, true); }
                    else showThresholdFeedback(jobId, false);
                })
                .catch(() => showThresholdFeedback(jobId, false));
        });
    });
});

// ── Modal-aware auto-refresh ─────────────────────────────────────────────────
// Reloads after 60s of idle time, but pauses while any modal is open.
(function () {
    let reloadTimer = null;
    let pendingReload = false;

    function startTimer() {
        clearTimeout(reloadTimer);
        reloadTimer = setTimeout(() => {
            if (document.querySelector('.modal.show')) {
                pendingReload = true; // defer until modal closes
            } else {
                location.reload();
            }
        }, 60000);
    }

    document.querySelectorAll('.modal').forEach(function (modal) {
        modal.addEventListener('hidden.bs.modal', function () {
            if (pendingReload) { location.reload(); }
        });
    });

    startTimer();
}());
</script>
{% endblock %}
