{% extends "base_layout.html" %}
{% block title %}Cleanup Duplicate Notes - JobPulse{% endblock %}
{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="mb-0">
                <i class="fas fa-broom me-2 text-warning"></i>
                Cleanup Duplicate AI Notes
            </h1>
            <p class="text-muted mt-2">Remove duplicate "AI Vetting - Not Recommended" notes from Bullhorn candidate
                records</p>
        </div>
    </div>

    <!-- Settings Card -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Cleanup Settings</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Max Candidates to Scan</label>
                        <input type="number" id="maxCandidates" class="form-control" value="500" min="10" max="2000">
                        <small class="text-muted">Increase to cover all affected candidates (report showed 73 with
                            duplicates)</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Days to Look Back</label>
                        <input type="number" id="daysBack" class="form-control" value="5" min="1" max="30">
                        <small class="text-muted">How many days of candidate modifications to check</small>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-primary" onclick="runCleanup('dry-run')">
                            <i class="fas fa-search me-1"></i> Dry Run (Preview)
                        </button>
                        <button class="btn btn-danger" onclick="runCleanup('execute')" id="executeBtn">
                            <i class="fas fa-trash-alt me-1"></i> Execute Cleanup
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card bg-info bg-opacity-10 border-info">
                <div class="card-body">
                    <h5 class="text-info"><i class="fas fa-info-circle me-2"></i>How It Works</h5>
                    <ul class="mb-0">
                        <li><strong>Keep:</strong> The oldest (original) note for each candidate</li>
                        <li><strong>Keep:</strong> Any note created 60+ minutes after the previous kept note</li>
                        <li><strong>Delete:</strong> All notes within 60 minutes of each other (duplicates)</li>
                        <li>Notes are "soft-deleted" (isDeleted=true), can be recovered if needed</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Card -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Results</h5>
                    <span id="runningIndicator" class="badge bg-warning" style="display:none;">
                        <i class="fas fa-spinner fa-spin me-1"></i> Running...
                    </span>
                </div>
                <div class="card-body">
                    <div id="resultsEmpty" class="text-center text-muted py-4">
                        <i class="fas fa-clipboard-list fa-3x mb-3"></i>
                        <p>Run a dry-run first to see what would be deleted</p>
                    </div>
                    <div id="resultsArea" style="display:none;">
                        <!-- Summary -->
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="card bg-primary bg-opacity-10">
                                    <div class="card-body text-center">
                                        <h2 class="mb-0" id="candidatesScanned">0</h2>
                                        <small>Candidates Scanned</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-warning bg-opacity-10">
                                    <div class="card-body text-center">
                                        <h2 class="mb-0" id="candidatesWithDups">0</h2>
                                        <small>Candidates with Duplicates</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-danger bg-opacity-10">
                                    <div class="card-body text-center">
                                        <h2 class="mb-0" id="notesToDelete">0</h2>
                                        <small id="notesLabel">Notes to Delete</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Status Messages -->
                        <div id="statusMessage" class="alert" style="display:none;"></div>

                        <!-- Candidate Details Table -->
                        <h6>Candidate Details</h6>
                        <div class="table-responsive">
                            <table class="table table-striped table-sm">
                                <thead>
                                    <tr>
                                        <th>Candidate Name</th>
                                        <th>ID</th>
                                        <th>Email</th>
                                        <th class="text-center">Keep</th>
                                        <th class="text-center">Delete</th>
                                    </tr>
                                </thead>
                                <tbody id="candidateList"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    async function runCleanup(mode) {
        const maxCandidates = document.getElementById('maxCandidates').value;
        const days = document.getElementById('daysBack').value;

        // Show running indicator
        document.getElementById('runningIndicator').style.display = 'inline-block';
        document.getElementById('resultsEmpty').style.display = 'none';
        document.getElementById('executeBtn').disabled = true;

        try {
            const response = await fetch(
                `/cleanup-duplicate-notes/run?mode=${mode}&max_candidates=${maxCandidates}&days=${days}`,
                { method: 'POST' }
            );

            const data = await response.json();

            // Hide running indicator
            document.getElementById('runningIndicator').style.display = 'none';
            document.getElementById('executeBtn').disabled = false;
            document.getElementById('resultsArea').style.display = 'block';

            if (data.success) {
                // Update summary cards
                document.getElementById('candidatesScanned').textContent = data.summary.candidates_scanned;
                document.getElementById('candidatesWithDups').textContent = data.summary.candidates_with_duplicates;
                document.getElementById('notesToDelete').textContent = data.summary.notes_to_delete;

                // Update label based on mode
                if (mode === 'execute') {
                    document.getElementById('notesLabel').textContent = 'Notes Deleted';
                    document.getElementById('notesToDelete').textContent = data.summary.notes_deleted;
                } else {
                    document.getElementById('notesLabel').textContent = 'Notes to Delete';
                }

                // Show status message
                const statusDiv = document.getElementById('statusMessage');
                if (mode === 'execute') {
                    statusDiv.className = 'alert alert-success';
                    statusDiv.innerHTML = `<i class="fas fa-check-circle me-2"></i>Successfully deleted ${data.summary.notes_deleted} duplicate notes!`;
                } else {
                    statusDiv.className = 'alert alert-info';
                    statusDiv.innerHTML = `<i class="fas fa-info-circle me-2"></i>Dry run complete. ${data.summary.notes_to_delete} notes would be deleted. Run "Execute Cleanup" to proceed.`;
                }
                statusDiv.style.display = 'block';

                // Populate candidate table
                const tbody = document.getElementById('candidateList');
                tbody.innerHTML = '';
                data.candidate_details.forEach(c => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                    <td>${c.name}</td>
                    <td><a href="https://bullhorn.com/candidate/${c.id}" target="_blank">${c.id}</a></td>
                    <td>${c.email || '-'}</td>
                    <td class="text-center text-success">${c.notes_to_keep}</td>
                    <td class="text-center text-danger">${c.notes_to_delete}</td>
                `;
                    tbody.appendChild(row);
                });

            } else {
                const statusDiv = document.getElementById('statusMessage');
                statusDiv.className = 'alert alert-danger';
                statusDiv.innerHTML = `<i class="fas fa-exclamation-triangle me-2"></i>Error: ${data.error}`;
                statusDiv.style.display = 'block';
            }

        } catch (error) {
            document.getElementById('runningIndicator').style.display = 'none';
            document.getElementById('executeBtn').disabled = false;

            const statusDiv = document.getElementById('statusMessage');
            statusDiv.className = 'alert alert-danger';
            statusDiv.innerHTML = `<i class="fas fa-exclamation-triangle me-2"></i>Request failed: ${error.message}`;
            statusDiv.style.display = 'block';
            document.getElementById('resultsArea').style.display = 'block';
        }
    }
</script>
{% endblock %}